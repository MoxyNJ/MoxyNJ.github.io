"use strict";(self.webpackChunkninjee=self.webpackChunkninjee||[]).push([[6142],{3905:function(e,n,t){t.d(n,{Zo:function(){return c},kt:function(){return m}});var a=t(67294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)t=o[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)t=o[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var i=a.createContext({}),d=function(e){var n=a.useContext(i),t=n;return e&&(t="function"==typeof e?e(n):l(l({},n),e)),t},c=function(e){var n=d(e.components);return a.createElement(i.Provider,{value:n},e.children)},p={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},u=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,o=e.originalType,i=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),u=d(t),m=r,g=u["".concat(i,".").concat(m)]||u[m]||p[m]||o;return t?a.createElement(g,l(l({ref:n},c),{},{components:t})):a.createElement(g,l({ref:n},c))}));function m(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var o=t.length,l=new Array(o);l[0]=u;var s={};for(var i in n)hasOwnProperty.call(n,i)&&(s[i]=n[i]);s.originalType=e,s.mdxType="string"==typeof e?e:r,l[1]=s;for(var d=2;d<o;d++)l[d]=t[d];return a.createElement.apply(null,l)}return a.createElement.apply(null,t)}u.displayName="MDXCreateElement"},90292:function(e,n,t){t.r(n),t.d(n,{assets:function(){return c},contentTitle:function(){return i},default:function(){return m},frontMatter:function(){return s},metadata:function(){return d},toc:function(){return p}});var a=t(87462),r=t(63366),o=(t(67294),t(3905)),l=["components"],s={title:"Frida so\u5c42\u4e2d\u7684hook",date:new Date("2021-02-10T00:00:00.000Z"),authors:"kuizuo",tags:["frida","app","hook"]},i=void 0,d={unversionedId:"skill/reverse/android/frida/Frida so\u5c42\u4e2d\u7684hook",id:"skill/reverse/android/frida/Frida so\u5c42\u4e2d\u7684hook",title:"Frida so\u5c42\u4e2d\u7684hook",description:"\u524d\u8a00",source:"@site/docs/skill/reverse/android/frida/Frida so\u5c42\u4e2d\u7684hook.md",sourceDirName:"skill/reverse/android/frida",slug:"/skill/reverse/android/frida/Frida so\u5c42\u4e2d\u7684hook",permalink:"/docs/skill/reverse/android/frida/Frida so\u5c42\u4e2d\u7684hook",tags:[{label:"frida",permalink:"/docs/tags/frida"},{label:"app",permalink:"/docs/tags/app"},{label:"hook",permalink:"/docs/tags/hook"}],version:"current",frontMatter:{title:"Frida so\u5c42\u4e2d\u7684hook",date:"2021-02-10T00:00:00.000Z",authors:"kuizuo",tags:["frida","app","hook"]},sidebar:"skill",previous:{title:"Frida java\u5c42\u81ea\u5410\u52a0\u5bc6\u7b97\u6cd5",permalink:"/docs/skill/reverse/android/frida/Frida java\u5c42\u81ea\u5410\u52a0\u5bc6\u7b97\u6cd5"},next:{title:"Frida\u7b14\u8bb0",permalink:"/docs/skill/reverse/android/frida/Frida\u7b14\u8bb0"}},c={},p=[{value:"\u524d\u8a00",id:"\u524d\u8a00",level:2},{value:"\u5982\u4f55hook",id:"\u5982\u4f55hook",level:2},{value:"\u5f97\u5230\u51fd\u6570\u5730\u5740\u7684\u65b9\u5f0f",id:"\u5f97\u5230\u51fd\u6570\u5730\u5740\u7684\u65b9\u5f0f",level:3},{value:"\u6f14\u793a\u4ee3\u7801\u5982\u4e0b",id:"\u6f14\u793a\u4ee3\u7801\u5982\u4e0b",level:3},{value:"API",id:"api",level:2},{value:"\u679a\u4e3e\u5bfc\u5165\u8868",id:"\u679a\u4e3e\u5bfc\u5165\u8868",level:3},{value:"\u679a\u4e3e\u5bfc\u51fa\u8868",id:"\u679a\u4e3e\u5bfc\u51fa\u8868",level:3},{value:"\u679a\u4e3e\u7b26\u53f7\u8868",id:"\u679a\u4e3e\u7b26\u53f7\u8868",level:3},{value:"\u679a\u4e3e\u8fdb\u7a0b\u4e2d\u5df2\u52a0\u8f7d\u7684\u6a21\u5757",id:"\u679a\u4e3e\u8fdb\u7a0b\u4e2d\u5df2\u52a0\u8f7d\u7684\u6a21\u5757",level:3},{value:"findExportByName",id:"findexportbyname",level:3},{value:"\u6a21\u5757\u57fa\u5740\u83b7\u53d6\u65b9\u5f0f",id:"\u6a21\u5757\u57fa\u5740\u83b7\u53d6\u65b9\u5f0f",level:3},{value:"Process.findModuleByName",id:"processfindmodulebyname",level:4},{value:"Process.getModuleByName",id:"processgetmodulebyname",level:4},{value:"Module.findBaseAddress()\uff08\u5e38\u7528\uff09",id:"modulefindbaseaddress\u5e38\u7528",level:4},{value:"Process.findModuleByAddress(address)",id:"processfindmodulebyaddressaddress",level:4},{value:"Process.getModuleByAddress(address)",id:"processgetmodulebyaddressaddress",level:4},{value:"\u6d4b\u8bd5hook\u4efb\u610f\u51fd\u6570",id:"\u6d4b\u8bd5hook\u4efb\u610f\u51fd\u6570",level:4},{value:"\u6253\u5370\u53c2\u6570",id:"\u6253\u5370\u53c2\u6570",level:4},{value:"\u53c2\u6570\u7684\u65b9\u6cd5",id:"\u53c2\u6570\u7684\u65b9\u6cd5",level:4},{value:"\u4fee\u6539\u51fd\u6570\u6570\u503c\u53c2\u6570\u548c\u8fd4\u56de\u503c",id:"\u4fee\u6539\u51fd\u6570\u6570\u503c\u53c2\u6570\u548c\u8fd4\u56de\u503c",level:3},{value:"\u4fee\u6539\u6570\u503c",id:"\u4fee\u6539\u6570\u503c",level:4},{value:"\u4fee\u6539\u5b57\u7b26\u4e32",id:"\u4fee\u6539\u5b57\u7b26\u4e32",level:3},{value:"\u5c06\u6307\u5411\u7684\u5b57\u7b26\u4e32\u4fee\u6539\u6210\u65b0\u7684\u5b57\u7b26\u4e32\uff08\u65b0\u5b57\u7b26\u4e32\u4e0d\u5b9c\u8d85\u8fc7\u539f\u6709\u5b57\u7b26\u4e32\u957f\u5ea6\uff09",id:"\u5c06\u6307\u5411\u7684\u5b57\u7b26\u4e32\u4fee\u6539\u6210\u65b0\u7684\u5b57\u7b26\u4e32\u65b0\u5b57\u7b26\u4e32\u4e0d\u5b9c\u8d85\u8fc7\u539f\u6709\u5b57\u7b26\u4e32\u957f\u5ea6",level:4},{value:"\u5c06so\u5c42\u4e2d\u5df2\u6709\u7684\u5b57\u7b26\u4e32\u4f20\u7ed9\u51fd\u6570\uff08\u5b57\u7b26\u4e32\u5730\u5740\u66ff\u6362\uff09",id:"\u5c06so\u5c42\u4e2d\u5df2\u6709\u7684\u5b57\u7b26\u4e32\u4f20\u7ed9\u51fd\u6570\u5b57\u7b26\u4e32\u5730\u5740\u66ff\u6362",level:4},{value:"\u66ff\u6362\u51fd\u6570\uff08\u5efa\u8bae\u4f7f\u7528\uff09",id:"\u66ff\u6362\u51fd\u6570\u5efa\u8bae\u4f7f\u7528",level:4},{value:"\u5185\u5b58\u8bfb\u5199",id:"\u5185\u5b58\u8bfb\u5199",level:3},{value:"\u4fee\u6539so\u51fd\u6570\u4ee3\u7801\uff08\u9700\u4e86\u89e3ARM\u6c47\u7f16\u76f8\u5173\u77e5\u8bc6\uff09",id:"\u4fee\u6539so\u51fd\u6570\u4ee3\u7801\u9700\u4e86\u89e3arm\u6c47\u7f16\u76f8\u5173\u77e5\u8bc6",level:3},{value:"\u4e3b\u52a8\u8c03\u7528\u4efb\u610f\u51fd\u6570",id:"\u4e3b\u52a8\u8c03\u7528\u4efb\u610f\u51fd\u6570",level:3},{value:"hook libc.so\u8bfb\u5199\u6587\u4ef6",id:"hook-libcso\u8bfb\u5199\u6587\u4ef6",level:3},{value:"hook jni\u51fd\u6570",id:"hook-jni\u51fd\u6570",level:3},{value:"\u4e3b\u52a8\u8c03\u7528JNI\u51fd\u6570",id:"\u4e3b\u52a8\u8c03\u7528jni\u51fd\u6570",level:3},{value:"\u4f7f\u7528frida\u5c01\u88c5\u7684\u51fd\u6570\u6765\u8c03\u7528jni",id:"\u4f7f\u7528frida\u5c01\u88c5\u7684\u51fd\u6570\u6765\u8c03\u7528jni",level:4},{value:"NativeFunction\u65b9\u5f0f\u4e3b\u52a8\u8c03\u7528",id:"nativefunction\u65b9\u5f0f\u4e3b\u52a8\u8c03\u7528",level:4},{value:"\u6253\u5370\u51fd\u6570\u8c03\u7528\u5806\u6808",id:"\u6253\u5370\u51fd\u6570\u8c03\u7528\u5806\u6808",level:3},{value:"frida trace + IDA\u63d2\u4ef6trace-natives\u6253\u5370\u51fd\u6570\u8c03\u7528\u6d41\u7a0b",id:"frida-trace--ida\u63d2\u4ef6trace-natives\u6253\u5370\u51fd\u6570\u8c03\u7528\u6d41\u7a0b",level:3},{value:"\u786e\u8ba4native\u51fd\u6570\u5728\u54ea\u4e2aso",id:"\u786e\u8ba4native\u51fd\u6570\u5728\u54ea\u4e2aso",level:3},{value:"hook_RegisterNatives",id:"hook_registernatives",level:4},{value:"hook_dlsym",id:"hook_dlsym",level:4},{value:"inlineHook\uff08\u9488\u5bf9\u5bc4\u5b58\u5668\u7684\u503c\uff09",id:"inlinehook\u9488\u5bf9\u5bc4\u5b58\u5668\u7684\u503c",level:3},{value:"hook_dlopen",id:"hook_dlopen",level:3},{value:"hook_initarray",id:"hook_initarray",level:3},{value:"hook_JNIOnload",id:"hook_jnionload",level:3},{value:"hook_pthread_create",id:"hook_pthread_create",level:3},{value:"\u5c01\u88c5so\u4e2d\u5e38\u7528hook\u51fd\u6570",id:"\u5c01\u88c5so\u4e2d\u5e38\u7528hook\u51fd\u6570",level:2},{value:"JNItrace",id:"jnitrace",level:2},{value:"\u5b89\u88c5\uff08\u8fdb\u5165\u5230frida\u73af\u5883\uff09",id:"\u5b89\u88c5\u8fdb\u5165\u5230frida\u73af\u5883",level:3},{value:"\u4f7f\u7528",id:"\u4f7f\u7528",level:3},{value:"ollvm\u5b57\u7b26\u4e32\u89e3\u5bc6",id:"ollvm\u5b57\u7b26\u4e32\u89e3\u5bc6",level:2},{value:"dump_so.js",id:"dump_sojs",level:3},{value:"SoFixer",id:"sofixer",level:3},{value:"Frida\u68c0\u6d4b",id:"frida\u68c0\u6d4b",level:2},{value:"ptrace\u5360\u5751",id:"ptrace\u5360\u5751",level:4},{value:"\u8fdb\u7a0b\u540d\u68c0\u6d4b",id:"\u8fdb\u7a0b\u540d\u68c0\u6d4b",level:4},{value:"\u7aef\u53e3\u68c0\u6d4b",id:"\u7aef\u53e3\u68c0\u6d4b",level:4},{value:"D-Bus\u534f\u8bae\u901a\u4fe1",id:"d-bus\u534f\u8bae\u901a\u4fe1",level:4},{value:"\u626b\u63cfmaps\u6587\u4ef6",id:"\u626b\u63cfmaps\u6587\u4ef6",level:4},{value:"\u626b\u63cftask\u76ee\u5f55",id:"\u626b\u63cftask\u76ee\u5f55",level:4},{value:"\u901a\u8fc7readlink",id:"\u901a\u8fc7readlink",level:4},{value:"\u5e38\u89c1\u7528\u4e8e\u68c0\u6d4b\u7684\u7cfb\u7edf\u51fd\u6570",id:"\u5e38\u89c1\u7528\u4e8e\u68c0\u6d4b\u7684\u7cfb\u7edf\u51fd\u6570",level:4},{value:"\u901a\u5e38\u6bd4\u8f83\u4f1a\u88ab\u68c0\u6d4b\u7684\u6587\u4ef6",id:"\u901a\u5e38\u6bd4\u8f83\u4f1a\u88ab\u68c0\u6d4b\u7684\u6587\u4ef6",level:4}],u={toc:p};function m(e){var n=e.components,t=(0,r.Z)(e,l);return(0,o.kt)("wrapper",(0,a.Z)({},u,t,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"\u524d\u8a00"},"\u524d\u8a00"),(0,o.kt)("p",null,"so\u4e2d\u4f1a\u63a5\u89e6\u5230\u7684\u4e1c\u897f\uff1a\u7cfb\u7edf\u5e93\u51fd\u6570\u3001\u52a0\u5bc6\u7b97\u6cd5\u3001jni\u8c03\u7528\u3001\u7cfb\u7edf\u8c03\u7528\u3001\u81ea\u5b9a\u4e49\u7b97\u6cd5"),(0,o.kt)("h2",{id:"\u5982\u4f55hook"},"\u5982\u4f55hook"),(0,o.kt)("p",null,"so hook\u53ea\u9700\u8981\u5f97\u5230\u4e00\u4e2a\u5730\u5740\uff0c\u6709",(0,o.kt)("strong",{parentName:"p"},"\u51fd\u6570\u5730\u5740\u5c31\u80fdhook\u4e0e\u4e3b\u52a8\u8c03\u7528"),"\uff0c\u4e0ejava\u5c42\u7684hook\u4e00\u81f4\u3002"),(0,o.kt)("h3",{id:"\u5f97\u5230\u51fd\u6570\u5730\u5740\u7684\u65b9\u5f0f"},"\u5f97\u5230\u51fd\u6570\u5730\u5740\u7684\u65b9\u5f0f"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"\u901a\u8fc7frida\u63d0\u4f9b\u7684api\u6765\u5f97\u5230\uff0c\u8be5\u51fd\u6570\u5fc5\u987b\u6709\u7b26\u53f7\u7684\u624d\u53ef\u4ee5"),(0,o.kt)("li",{parentName:"ol"},"\u901a\u8fc7\u8ba1\u7b97\u5f97\u5230\u5730\u5740\uff1aso\u57fa\u5740+\u51fd\u6570\u5728so\u4e2d\u7684\u504f\u79fb","[+1]")),(0,o.kt)("h3",{id:"\u6f14\u793a\u4ee3\u7801\u5982\u4e0b"},"\u6f14\u793a\u4ee3\u7801\u5982\u4e0b"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"const moduleName = 'libnative-lib.so';\nlet baseAddr = Module.findBaseAddress(moduleName);\nlet sub_99C0 = baseAddr.add(0x99c0 + 1);\nInterceptor.attach(funcPtr, {\n  onEnter: function (args) {\n    // ...\n  },\n  onLeave: function (retval) {\n    // ...\n  },\n})\n\n")),(0,o.kt)("h2",{id:"api"},"API"),(0,o.kt)("h3",{id:"\u679a\u4e3e\u5bfc\u5165\u8868"},"\u679a\u4e3e\u5bfc\u5165\u8868"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},'const improts = Module.enumerateImports("libencryptlib.so");\nfor (const iterator of improts) {\n    console.log(JSON.stringify(iterator));\n    // {"type":"function","name":"__cxa_atexit","module":"/apex/com.android.runtime/lib64/bionic/libc.so","address":"0x778957bd34"}\n}\n')),(0,o.kt)("h3",{id:"\u679a\u4e3e\u5bfc\u51fa\u8868"},"\u679a\u4e3e\u5bfc\u51fa\u8868"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},'const exports = Module.enumerateExports("libencryptlib.so");\nfor (const iterator of exports) {\n    console.log(JSON.stringify(iterator));\n    // {"type":"letiable","name":"_ZTSx","address":"0x74d594b1c0"}    \n}\n')),(0,o.kt)("h3",{id:"\u679a\u4e3e\u7b26\u53f7\u8868"},"\u679a\u4e3e\u7b26\u53f7\u8868"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},'const symbols = Module.enumerateSymbols("libencryptlib.so");\nfor (const iterator of symbols) {\n    console.log(JSON.stringify(iterator));\n    // {"isGlobal":true,"type":"function","name":"pthread_getspecific","address":"0x0","size":0\n}\n')),(0,o.kt)("h3",{id:"\u679a\u4e3e\u8fdb\u7a0b\u4e2d\u5df2\u52a0\u8f7d\u7684\u6a21\u5757"},"\u679a\u4e3e\u8fdb\u7a0b\u4e2d\u5df2\u52a0\u8f7d\u7684\u6a21\u5757"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"const modules = Process.enumerateModules();\nconsole.log(JSON.stringify(modules[0].enumerateExports()[0]));\n")),(0,o.kt)("h3",{id:"findexportbyname"},"findExportByName"),(0,o.kt)("p",null,"\u6ce8: ",(0,o.kt)("strong",{parentName:"p"},"\u51fd\u6570\u540d\u4ee5\u6c47\u7f16\u4e2d\u51fa\u73b0\u7684\u4e3a\u51c6")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},'const funcAddr = Module.findExportByName("libencryptlib.so", "_ZN7MD5_CTX11MakePassMD5EPhjS0_");\n// \u8fd4\u56de\u7684\u662f\u51fd\u6570\u5730\u5740  \u7b2c\u4e8c\u4e2a\u53c2\u6570\u6839\u636e\u6c47\u7f16\u4e2d\u4e3a\u51c6\nconsole.log(funcAddr);\n\n// \u901a\u8fc7Interceptor.attach\u6765\u5bf9\u51fd\u6570\u8fdb\u884chook\nInterceptor.attach(funcAddr, {\n    onEnter: function (args) {\n        console.log("args[1]: ", hexdump(args[1])); // \u6253\u5370\u53c2\u6570\u7684\u5730\u5740 \u901a\u8fc7hexdump\u6253\u537016\u8fdb\u5236\n        console.log(this.context.x1) // \u6253\u5370\u5bc4\u5b58\u5668\u5185\u5bb9 \n        console.log("args[2]: ", args[2].toInt32()); // \u9ed8\u8ba4\u663e\u793a16\u8fdb\u5236,\u8fd9\u91cc\u8f6c\u4e3a10\u8fdb\u5236\n        this.args3 = args[3]; // \u5c06args[3]\u503c\u4fdd\u5b58\u5230this\u4e0a\n    }, onLeave: function (retval) {\n        console.log("args[3]: ", hexdump(this.args3));\n    }\n});\n')),(0,o.kt)("h3",{id:"\u6a21\u5757\u57fa\u5740\u83b7\u53d6\u65b9\u5f0f"},"\u6a21\u5757\u57fa\u5740\u83b7\u53d6\u65b9\u5f0f"),(0,o.kt)("p",null,"\u5982\u679c\u5728\u5bfc\u5165\u8868\u3001\u5bfc\u51fa\u8868\u3001\u7b26\u53f7\u8868\u91cc\u627e\u4e0d\u5230\u7684\u51fd\u6570\uff0c\u90a3\u4e48\u51fd\u6570\u5730\u5740\u9700\u8981\u81ea\u5df1\u8ba1\u7b97"),(0,o.kt)("p",null,"\u8ba1\u7b97\u516c\u5f0f\uff1a",(0,o.kt)("strong",{parentName:"p"},"so\u57fa\u5740+\u51fd\u6570\u5728so\u4e2d\u7684\u504f\u79fb","[+1]")),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:null},"\u5b89\u5353\u4f4d\u6570"),(0,o.kt)("th",{parentName:"tr",align:null},"\u6307\u4ee4"),(0,o.kt)("th",{parentName:"tr",align:null},"\u8ba1\u7b97\u65b9\u5f0f"))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"32\u4f4d"),(0,o.kt)("td",{parentName:"tr",align:null},"thumb"),(0,o.kt)("td",{parentName:"tr",align:null},"so\u57fa\u5740 + \u51fd\u6570\u5728so\u4e2d\u7684\u504f\u79fb + 1")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"64\u4f4d"),(0,o.kt)("td",{parentName:"tr",align:null},"arm"),(0,o.kt)("td",{parentName:"tr",align:null},"so\u57fa\u5740 + \u51fd\u6570\u5728so\u4e2d\u7684\u504f\u79fb")))),(0,o.kt)("p",null,"\u4e5f\u53ef\u901a\u8fc7\u663e\u793a\u6c47\u7f16\u6307\u4ee4\u5bf9\u5e94\u7684opcode bytes\uff0c\u6765\u5224\u65ad "),(0,o.kt)("p",null,"IDA -> Options -> General -> Number of opcode bytes (non-graph) \u6539\u4e3a4"),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://img.kuizuo.cn/20220206042927.png",alt:"image-20220206042920297"})),(0,o.kt)("p",null,"arm\u6307\u4ee4\u4e3a4\u4e2a\u5b57\u8282\uff0c\u5982\u679c\u51fd\u6570\u4e2d\u6709\u4e9b\u6307\u4ee4\u662f\u4e24\u4e2a\u5b57\u8282\uff0c\u90a3\u4e48\u51fd\u6570\u5730\u5740\u8ba1\u7b97\u9700\u8981 + 1"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"\u4e0d\u6e05\u695a\u7684\u8bdd\uff0c+1\u548c\u4e0d+1\u90fd\u8bd5\u4e00\u904d\u5373\u53ef")),(0,o.kt)("p",null,"\u6240\u4ee5\u83b7\u53d6\u57fa\u5740\u5c31\u663e\u5f97\u5c24\u4e3a\u91cd\u8981"),(0,o.kt)("h4",{id:"processfindmodulebyname"},"Process.findModuleByName"),(0,o.kt)("p",null,"\u901a\u8fc7\u6a21\u5757\u540d\u627e\u5230\u6a21\u5757"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},'const module = Process.findModuleByName("libencryptlib.so");\nconsole.log(JSON.stringify(module));\n// {"name":"libencryptlib.so","base":"0x74d5934000","size":303104,"path":"/data/app/~~Nzn4SQ_RZn1-PYH7TbX7Ig==/com.pocket.snh48.activity-Muxx7c_dtplxjFPY2SGF0A==/lib/arm64/libencryptlib.so"}\n// base\u4e3a\u57fa\u5740\n')),(0,o.kt)("h4",{id:"processgetmodulebyname"},"Process.getModuleByName"),(0,o.kt)("p",null,"\u540cfindModuleByName "),(0,o.kt)("h4",{id:"modulefindbaseaddress\u5e38\u7528"},"Module.findBaseAddress()\uff08\u5e38\u7528\uff09"),(0,o.kt)("p",null,"\u76f4\u63a5\u83b7\u5f97\u6a21\u5757\u57fa\u5740"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},'const baseAddr = Module.findBaseAddress("libencryptlib.so");\nconsole.log(baseAddr);\n// 0x74d5934000\n')),(0,o.kt)("h4",{id:"processfindmodulebyaddressaddress"},"Process.findModuleByAddress(address)"),(0,o.kt)("p",null,"\u901a\u8fc7\u57fa\u5740\u6765\u627e\u5230\u6a21\u5757"),(0,o.kt)("h4",{id:"processgetmodulebyaddressaddress"},"Process.getModuleByAddress(address)"),(0,o.kt)("p",null,"\u540cfindModuleByAddress"),(0,o.kt)("h4",{id:"\u6d4b\u8bd5hook\u4efb\u610f\u51fd\u6570"},"\u6d4b\u8bd5hook\u4efb\u610f\u51fd\u6570"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},'const baseAddr = Module.findBaseAddress("libencryptlib.so");\n// const so = 0x77ab999000;\n// console.log(ptr(so).add(0x1FA38)); // ptr \u662f new NativePointer()\u7684\u7b80\u5199\nconst funcAddr = baseAddr.add(0x1FA38); // 0x1FA38 \u662fIDA\u4e2d\u51fd\u6570\u5b9a\u4e49\u7684\u5730\u5740\nInterceptor.attach(funcAddr, {})\n')),(0,o.kt)("h4",{id:"\u6253\u5370\u53c2\u6570"},"\u6253\u5370\u53c2\u6570"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},'function print_arg(addr){\n    const module = Process.findRangeByAddress(addr);\n    // \u5224\u65ad\u4f20\u5165\u7684\u53c2\u6570\u662f\u5426\u4e3a\u5730\u5740\n    if(module !== null) return hexdump(addr) + "\\n";\n    return ptr(addr) + "\\n";\n}\n')),(0,o.kt)("h4",{id:"\u53c2\u6570\u7684\u65b9\u6cd5"},"\u53c2\u6570\u7684\u65b9\u6cd5"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"// args[0] \u662f\u4e00\u4e2a\u5185\u5b58\u5730\u5740\nhexdump(args[0]) // \u6253\u5370\u53c2\u6570\u7684\u6240\u5728\u5185\u5b58\u533a\u57df\u7684\u5b57\u8282\u6570\u636e\nargs[0].readCString() // \u8bfb\u53d6\u53c2\u6570\u6240\u5bf9\u5e94\u7684C\u5b57\u7b26\u4e32 (\u524d\u63d0: \u53c2\u6570\u662f\u4e00\u4e2a\u53ef\u89c1\u5b57\u7b26\u4e32)\nargs[0].readPointer() // \u7528\u8bfb\u5730\u5740\u65b9\u5f0f\u53bb\u8bfb\u53d6\u53c2\u6570\u6240\u5bf9\u5e94\u7684\u503c (\u5982\u679c\u53c2\u6570\u662f\u4e00\u4e2a\u6307\u9488\u7684\u8bdd\u53ef\u80fd\u5c31\u9700\u8981\u4f7f\u7528)\n")),(0,o.kt)("h3",{id:"\u4fee\u6539\u51fd\u6570\u6570\u503c\u53c2\u6570\u548c\u8fd4\u56de\u503c"},"\u4fee\u6539\u51fd\u6570\u6570\u503c\u53c2\u6570\u548c\u8fd4\u56de\u503c"),(0,o.kt)("h4",{id:"\u4fee\u6539\u6570\u503c"},"\u4fee\u6539\u6570\u503c"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"Interceptor.attach(helloAddr, {\n  onEnter: function (args) {\n    args[2] = ptr(1000) // \u76f4\u63a5\u5c06\u7b2c\u4e09\u4e2a\u53c2\u6570\u4fee\u6539\u4e3a1000\n    console.log(args[2].toInt32())\n  },\n  onLeave: function (retval) {\n    retval.replace(20000) // \u901a\u8fc7replace \u4fee\u6539\u621020000\n    console.log('retval', retval.toInt32())\n  },\n})\n")),(0,o.kt)("h3",{id:"\u4fee\u6539\u5b57\u7b26\u4e32"},"\u4fee\u6539\u5b57\u7b26\u4e32"),(0,o.kt)("p",null,"hex\u4e0estring\u8f6c\u5316\u5c01\u88c5\u51fd\u6570\uff08\u4e2d\u6587\u65e0\u6cd5\u8f6c\u5316\uff09"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},'function stringToBytes(str){\n    return hexToBytes(stringToHex(str));\n}\n\nfunction stringToHex(str) {\n    return str.split("").map(function(c) {\n        return ("0" + c.charCodeAt(0).toString(16)).slice(-2);\n    }).join("");\n}\n\nfunction hexToBytes(hex) {\n    for (let bytes = [], c = 0; c < hex.length; c += 2)\n        bytes.push(parseInt(hex.substr(c, 2), 16));\n    return bytes;\n}\n\nfunction hexToString(hexStr) {\n    let hex = hexStr.toString();\n    let str = \'\';\n    for (let i = 0; i < hex.length; i += 2)\n        str += String.fromCharCode(parseInt(hex.substr(i, 2), 16));\n    return str;\n}\n')),(0,o.kt)("h4",{id:"\u5c06\u6307\u5411\u7684\u5b57\u7b26\u4e32\u4fee\u6539\u6210\u65b0\u7684\u5b57\u7b26\u4e32\u65b0\u5b57\u7b26\u4e32\u4e0d\u5b9c\u8d85\u8fc7\u539f\u6709\u5b57\u7b26\u4e32\u957f\u5ea6"},"\u5c06\u6307\u5411\u7684\u5b57\u7b26\u4e32\u4fee\u6539\u6210\u65b0\u7684\u5b57\u7b26\u4e32\uff08\u65b0\u5b57\u7b26\u4e32\u4e0d\u5b9c\u8d85\u8fc7\u539f\u6709\u5b57\u7b26\u4e32\u957f\u5ea6\uff09"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},'Interceptor.attach(funcAddr, {\n    onEnter: function (args) {\n        let newStr = "some strings";\n        // \u9700\u8981\u5199\u5165\u5b57\u8282\u6570\u7ec4\u7684\u65b9\u5f0f\u6765\u5199\u5165\u5b57\u7b26\u4e32\n        args[1].writeByteArray(hexToBytes(stringToHex(newStr) + "00")); // c\u8bed\u8a00\u5b57\u7b26\u4e32\u7ed3\u5c3e\u4e3a0\u5b57\u8282\n        console.log(hexdump(args[1]));\n        args[2] = ptr(newStr.length);\n        console.log(args[2].toInt32());\n    }, onLeave: function (retval) {\n    }\n});\n')),(0,o.kt)("div",{className:"admonition admonition-danger alert alert--danger"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"}))),"danger")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"\u6709\u7f3a\u9677\uff0c\u5982\u679c\u5b57\u7b26\u4e32\u957f\u5ea6\u5927\u4e8e\u539f\u5b57\u7b26\u4e32\u957f\u5ea6\uff0c\u6709\u53ef\u80fd\u5bfc\u81f4\u5185\u5b58\u4e2d\u5176\u4ed6\u533a\u57df\u88ab\u4fee\u6539\uff0c\u5bfc\u81f4\u4e0d\u53ef\u9884\u77e5\u7684BUG"))),(0,o.kt)("h4",{id:"\u5c06so\u5c42\u4e2d\u5df2\u6709\u7684\u5b57\u7b26\u4e32\u4f20\u7ed9\u51fd\u6570\u5b57\u7b26\u4e32\u5730\u5740\u66ff\u6362"},"\u5c06so\u5c42\u4e2d\u5df2\u6709\u7684\u5b57\u7b26\u4e32\u4f20\u7ed9\u51fd\u6570\uff08\u5b57\u7b26\u4e32\u5730\u5740\u66ff\u6362\uff09"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"Interceptor.attach(funcAddr, {\n  onEnter: function (args) {\n    args[1] = baseAddr.add(0x38a1) // 0x38a1 \u4e3aIDA\u4e2d\u6240\u5bf9\u5e94\u7684\u5b57\u7b26\u4e32\u5730\u5740\n    console.log(hexdump(args[1]))\n    args[2] = ptr(baseAddr.add(0x38a1).readCString().length) // \u8bfb\u53d6\u5b57\u7b26\u4e32\u957f\u5ea6\n    console.log(args[2].toInt32())\n  },\n  onLeave: function (retval) {},\n})\n\n")),(0,o.kt)("h4",{id:"\u66ff\u6362\u51fd\u6570\u5efa\u8bae\u4f7f\u7528"},"\u66ff\u6362\u51fd\u6570\uff08\u5efa\u8bae\u4f7f\u7528\uff09"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},'cosnt newStr = "some strings";\ncosnt newStrAddr = Memory.allocUtf8String(newStr); // \u4f7f\u7528Frida\u7684Memory\u6765\u7533\u8bf7\u5185\u5b58\u533a\u57df \u8fd4\u56de\u7684\u662f\u4e00\u4e2a\u6307\u9488\n\nInterceptor.attach(funcAddr, {\n  onEnter: function (args) {\n    // cosnt newStrAddr = Memory.allocUtf8String(newStr); // \u5982\u679c\u5728\u8fd9\u91cc\u7533\u8bf7\u7684\u8bdd,\u5230onLeave\u5c06\u4f1a\u56de\u6536 \u53ef\u4ee5\u5728\u5168\u5c40\u5b9a\u4e49\u6216\u4f7f\u7528this.newStrAddr \u9644\u52a0\u5230\u81ea\u8eab\n    args[1] = newStrAddr\n    console.log(hexdump(args[1]))\n    args[2] = ptr(newStr.length)\n    console.log(args[2].toInt32())\n  },\n  onLeave: function (retval) {},\n})\n\n\n')),(0,o.kt)("h3",{id:"\u5185\u5b58\u8bfb\u5199"},"\u5185\u5b58\u8bfb\u5199"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},'// 1. \u8bfb\u53d6\u6307\u5b9a\u5730\u5740\u7684\u5b57\u7b26\u4e32\nlet baseAddr = Module.findBaseAddress("libxiaojianbang.so");\nconsole.log(baseAddr.add(0x2C00).readCString());\n\n// 2. dump\u6307\u5b9a\u5730\u5740\u7684\u5185\u5b58\nconsole.log(hexdump(baseAddr.add(0x2C00)));\n\n// 3. \u8bfb\u6307\u5b9a\u5730\u5740\u7684\u5185\u5b58\nconsole.log(baseAddr.add(0x2C00).readByteArray(16));\nconsole.log(Memory.readByteArray(baseAddr.add(0x2C00), 16));  //\u539f\u5148\u7684API\n\n// 4. \u5199\u6307\u5b9a\u5730\u5740\u7684\u5185\u5b58\nbaseAddr.add(0x2C00).writeByteArray(stringToBytes("xiaojianbang")); \nconsole.log(hexdump(baseAddr.add(0x2C00)));\n        \n// 5. \u7533\u8bf7\u65b0\u5185\u5b58\u5199\u5165\nMemory.alloc()\nMemory.allocUtf8String()\n\n// 6. \u4fee\u6539\u5185\u5b58\u6743\u9650\nMemory.protect(ptr(libso.base), libso.size, \'rwx\');\n')),(0,o.kt)("h3",{id:"\u4fee\u6539so\u51fd\u6570\u4ee3\u7801\u9700\u4e86\u89e3arm\u6c47\u7f16\u76f8\u5173\u77e5\u8bc6"},"\u4fee\u6539so\u51fd\u6570\u4ee3\u7801\uff08\u9700\u4e86\u89e3ARM\u6c47\u7f16\u76f8\u5173\u77e5\u8bc6\uff09"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},'// 1. \u4fee\u6539\u5730\u5740\u5bf9\u5e94\u7684\u6307\u4ee4\nlet baseAddr = Module.findBaseAddress("libxiaojianbang.so");\nbaseAddr.add(0x1684).writeByteArray(hexToBytes("0001094B"));\nARM\u4e0eHex\u5728\u7ebf\u8f6c\u6362 https://armconverter.com/\n\n// 2. \u5c06\u5bf9\u5e94\u5730\u5740\u7684\u6307\u4ee4\u89e3\u6790\u6210\u6c47\u7f16\nlet ins = Instruction.parse(baseAddr.add(0x1684));\nconsole.log(ins.toString());\n\n// 3. \u5229\u7528frida\u63d0\u4f9b\u7684api\u6765\u5199\u6c47\u7f16\u4ee3\u7801\nnew Arm64Writer(baseAddr.add(0x167C)).putNop();\nconsole.log(Instruction.parse(baseAddr.add(0x167C)).toString());\n\n// 4. \u5229\u7528frida\u63d0\u4f9b\u7684api\u6765\u5199\u6c47\u7f16\u4ee3\u7801\nlet codeAddr = baseAddr.add(0x167C);\nMemory.patchCode(codeAddr, 8, function (code) {\n    let Writer = new Arm64Writer(code, {pc: codeAddr});\n    Writer.putBytes(hexToBytes("0001094B"));\n    Writer.putBytes(hexToBytes("FF830091"));\n    Writer.putRet();\n    Writer.flush();\n});\n')),(0,o.kt)("h3",{id:"\u4e3b\u52a8\u8c03\u7528\u4efb\u610f\u51fd\u6570"},"\u4e3b\u52a8\u8c03\u7528\u4efb\u610f\u51fd\u6570"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"\u58f0\u660e\u51fd\u6570\u6307\u9488"),(0,o.kt)("p",{parentName:"li"},"\u6587\u6863\uff1a",(0,o.kt)("a",{parentName:"p",href:"https://frida.re/docs/javascript-api/#NativeFunction"},"https://frida.re/docs/javascript-api/#NativeFunction"),"\n\u8bed\u6cd5\uff1a",(0,o.kt)("inlineCode",{parentName:"p"},"new NativeFunction(address, returnType, argTypes[, abi])"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"\u652f\u6301\u7684returnType\u548cargTypes"),(0,o.kt)("p",{parentName:"li"},"void\u3001pointer\u3001int\u3001uint\u3001long\u3001ulong\u3001char\u3001uchar\u3001float\u3001double\nint8\u3001uint8\u3001int16\u3001uint16\u3001int32\u3001uint32\u3001int64\u3001uint64\u3001bool\nsize_t\u3001ssize_t")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"\u4ee3\u7801\u793a\u4f8b"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"Java.perform(function () {\n  //\u62ff\u5230\u51fd\u6570\u5730\u5740\n  let funcAddr = Module.findBaseAddress('libxiaojianbang.so').add(0x23f4)\n  //\u58f0\u660e\u51fd\u6570\u6307\u9488\n  let func = new NativeFunction(funcAddr, 'pointer', ['pointer', 'pointer'])\n  let env = Java.vm.tryGetEnv() // \u83b7\u53d6JNIEnv\n  console.log('env: ', JSON.stringify(env))\n  // {\"handle\":\"0xb400007911df2c10\",\"vm\":{\"handle\":\"0xb400007921d5f710\"}}\n  if (env != null) {\n    // \u521b\u5efajava\u5b57\u7b26\u4e32 (jstr\u662f\u4e00\u4e2a\u5730\u5740)\n    let jstr = env.newStringUtf('some strings')\n    let cstr = func(env, jstr)\n    console.log(cstr.readCString())\n    console.log(hexdump(cstr))\n  }\n})\n")))),(0,o.kt)("h3",{id:"hook-libcso\u8bfb\u5199\u6587\u4ef6"},"hook libc.so\u8bfb\u5199\u6587\u4ef6"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"// \u627e\u5230C\u4e2d\u64cd\u4f5c\u6587\u4ef6\u7684api\nlet fopenAddr = Module.findExportByName('libc.so', 'fopen')\nlet fputsAddr = Module.findExportByName('libc.so', 'fputs')\nlet fcloseAddr = Module.findExportByName('libc.so', 'fclose')\nconsole.log(fopenAddr, fputsAddr, fcloseAddr)\n\nlet fopen = new NativeFunction(fopenAddr, 'pointer', ['pointer', 'pointer'])\nlet fputs = new NativeFunction(fputsAddr, 'int', ['pointer', 'pointer'])\nlet fclose = new NativeFunction(fcloseAddr, 'int', ['pointer'])\n\n// \u9700\u8981\u7533\u8bf7\u5185\u5b58\u5730\u5740 (\u7531\u4e8e\u9700\u8981\u4f20\u5165\u6307\u9488)\nlet fileName = Memory.allocUtf8String('/data/data/com.xiaojianbang.app/xiaojianbang.txt')\nlet openMode = Memory.allocUtf8String('w')\nlet data = Memory.allocUtf8String('QQ24358757\\n')\n\nlet file = fopen(fileName, openMode)\nconsole.log(file)\nfputs(data, file)\nfclose(file)\n")),(0,o.kt)("h3",{id:"hook-jni\u51fd\u6570"},"hook jni\u51fd\u6570"),(0,o.kt)("p",null,"libart.so \u5b58\u653ejni\u51fd\u6570"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"jni\u6587\u6863\u53ef\u5728jni.h\u5934\u6587\u4ef6\u4e2d\u67e5\u770b")),(0,o.kt)("p",null,"\u5b89\u535310\u4ee5\u4e0b ",(0,o.kt)("inlineCode",{parentName:"p"},"/system/lib")," \u6216 ",(0,o.kt)("inlineCode",{parentName:"p"},"/system/lib64")),(0,o.kt)("p",null,"\u5b89\u535310\u4ee5\u540e ",(0,o.kt)("inlineCode",{parentName:"p"},"/system/apex/com.android.runtime.release/lib64/libart.so")),(0,o.kt)("p",null,"\u4f8b\u5982hook env->NewStringUTF()\u65b9\u6cd5"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"// \u627e\u5230 env->NewStringUTF(a1, str) \u51fd\u6570\nfunction findNewStringUtfAddr() {\n  let artSym = Module.enumerateSymbols('libart.so');\n  for (const sym of artSym) {\n    if (!sym.name.includes('CheckJNI') && sym.name.includes('NewStringUTF')) {\n      // console.log(JSON.stringify(sym));\n      return sym.address;\n    }\n  }\n  return null;\n}\n\nfunction hookNewStringUTF() {\n  const NewStringUTFAddr = findNewStringUtfAddr();\n  // console.log('NewStringUTFAddr', NewStringUTFAddr);\n  if (NewStringUTFAddr !== null) {\n    Interceptor.attach(NewStringUTFAddr, {\n      onEnter: function (args) {\n        console.log(args[1].readCString());\n      },\n      onLeave: function (retval) {},\n    });\n  }\n}\nhookNewStringUTF()\n")),(0,o.kt)("p",null,"\u8ba1\u7b97\u5730\u5740\u65b9\u5f0f\uff08\u4e86\u89e3\uff09"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"Java.perform(function () {\n  console.log('Process.arch: ', Process.arch)\n  let envAddr = ptr(Java.vm.tryGetEnv().handle).readPointer()\n  // \u83b7\u53d6\u5230\u7684\u662fJNINativeInterface \u7ed3\u6784\u4f53\n\n  // 0x538 \u662f\u7ed3\u6784\u4f53\u504f\u79fb\u7684\u6307\u9488 \u9700\u8981\u8ba1\u7b97\n  let newStringUtfAddr = envAddr.add(0x538).readPointer()\n  console.log('newStringUtfAddr', newStringUtfAddr)\n  if (newStringUtfAddr != null) {\n    Interceptor.attach(newStringUtfAddr, {\n      onEnter: function (args) {\n        console.log(args[1].readCString())\n      },\n      onLeave: function (retval) {},\n    })\n  }\n})\n\n")),(0,o.kt)("h3",{id:"\u4e3b\u52a8\u8c03\u7528jni\u51fd\u6570"},"\u4e3b\u52a8\u8c03\u7528JNI\u51fd\u6570"),(0,o.kt)("h4",{id:"\u4f7f\u7528frida\u5c01\u88c5\u7684\u51fd\u6570\u6765\u8c03\u7528jni"},"\u4f7f\u7528frida\u5c01\u88c5\u7684\u51fd\u6570\u6765\u8c03\u7528jni"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"let funcAddr = Module.findExportByName('libxiaojianbang.so', 'helloFromC')\nconsole.log(funcAddr)\nif (funcAddr != null) {\n  Interceptor.attach(funcAddr, {\n    onEnter: function (args) {},\n    onLeave: function (retval) {\n      let env = Java.vm.tryGetEnv()\n      let jstr = env.newStringUtf('bbs.125.la') //\u4e3b\u52a8\u8c03\u7528jni\u51fd\u6570 cstr\u8f6cjstr\n      retval.replace(jstr)\n\n      let cstr = env.getStringUtfChars(jstr) //\u4e3b\u52a8\u8c03\u7528 jstr\u8f6ccstr\n      console.log(cstr.readCString())\n      console.log(hexdump(cstr))\n    },\n  })\n}\n")),(0,o.kt)("h4",{id:"nativefunction\u65b9\u5f0f\u4e3b\u52a8\u8c03\u7528"},"NativeFunction\u65b9\u5f0f\u4e3b\u52a8\u8c03\u7528"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"let symbols = Process.getModuleByName('libart.so').enumerateSymbols()\nlet newStringUtf = null\nfor (let i = 0; i < symbols.length; i++) {\n  let symbol = symbols[i]\n  if (symbol.name.indexOf('CheckJNI') == -1 && symbol.name.indexOf('NewStringUTF') != -1) {\n    console.log(symbol.name, symbol.address)\n    newStringUtf = symbol.address\n  }\n}\nlet newStringUtf_func = new NativeFunction(newStringUtf, 'pointer', ['pointer', 'pointer'])\nlet jstring = newStringUtf_func(Java.vm.tryGetEnv().handle, Memory.allocUtf8String('xiaojianbang'))\nconsole.log(jstring)\n\nlet envAddr = Java.vm.tryGetEnv().handle.readPointer()\nlet GetStringUTFChars = envAddr.add(0x548).readPointer()\nlet GetStringUTFChars_func = new NativeFunction(GetStringUTFChars, 'pointer', ['pointer', 'pointer', 'pointer'])\nlet cstr = GetStringUTFChars_func(Java.vm.tryGetEnv().handle, jstring, ptr(0))\nconsole.log(cstr.readCString())\n\n")),(0,o.kt)("h3",{id:"\u6253\u5370\u51fd\u6570\u8c03\u7528\u5806\u6808"},"\u6253\u5370\u51fd\u6570\u8c03\u7528\u5806\u6808"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"console.log(Thread.backtrace(this.context, Backtracer.FUZZY).map(DebugSymbol.fromAddress).join('\\n') + '\\n');\n")),(0,o.kt)("h3",{id:"frida-trace--ida\u63d2\u4ef6trace-natives\u6253\u5370\u51fd\u6570\u8c03\u7528\u6d41\u7a0b"},"frida trace + IDA\u63d2\u4ef6trace-natives\u6253\u5370\u51fd\u6570\u8c03\u7528\u6d41\u7a0b"),(0,o.kt)("p",null,"github\u5730\u5740: ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/Pr0214/trace_natives"},"https://github.com/Pr0214/trace_natives")),(0,o.kt)("p",null,"IDA -> Edit -> Plugins -> traceNatives\uff0c\u5c06\u4f1a\u5bf9\u5f53\u524dso\u6587\u4ef6\u4e2d\u6240\u6709\u51fd\u6570\u8fdb\u884chook"),(0,o.kt)("p",null,"\u4f7f\u7528"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"frida-trace -UF -O C:\\Users\\zeyu\\Desktop\\libmfw_1644263290.txt\n")),(0,o.kt)("p",null,"\u4f1a\u751f\u6210 ",(0,o.kt)("inlineCode",{parentName:"p"},"__handlers__/libdemo.so"),"\u7684\u6587\u4ef6\u5939\uff0c\u91cc\u9762\u5b58\u653e\u5bf9\u6240\u6709\u51fd\u6570\u7684hook\u811a\u672c"),(0,o.kt)("p",null,"\u7ed3\u679c\u5982\u4e0b"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"           /* TID 0x4da4 */\n 11249 ms  sub_1e3c()\n 11250 ms     | sub_15fc()\n 11250 ms     |    | sub_1794()\n 11250 ms     |    | sub_17cc()\n 11250 ms     |    | sub_1804()\n 11250 ms     |    | sub_184c()\n 11255 ms     |    | sub_194c()\n 11255 ms     |    | sub_1984()\n 11255 ms     |    | sub_19c4()\n 11255 ms     | sub_2140()\n 11255 ms     | sub_21b0()\n 11255 ms     | sub_3988()\n 11255 ms     |    | sub_3a84()\n 11255 ms     |    | sub_21b0()\n 11255 ms     |    | sub_21b0()\n 11255 ms     |    |    | sub_2428()\n 11255 ms     |    |    |    | sub_3bc0()\n 11255 ms     |    | sub_3a84()\n 11255 ms     | sub_2004()\n")),(0,o.kt)("h3",{id:"\u786e\u8ba4native\u51fd\u6570\u5728\u54ea\u4e2aso"},"\u786e\u8ba4native\u51fd\u6570\u5728\u54ea\u4e2aso"),(0,o.kt)("p",null,"\u9759\u6001\u5206\u6790\u67e5\u770b\u9759\u6001\u4ee3\u7801\u5757\u4e2d\u52a0\u8f7d\u7684so\uff0c\u4f46\u5e76\u4e0d\u9760\u8c31\uff0c\u56e0\u4e3anative\u51fd\u6570\u58f0\u660e\u5728\u4e00\u4e2a\u7c7b\u4e2d\uff0cso\u52a0\u8f7d\u53ef\u4ee5\u5728\u5176\u4ed6\u7684\u7c7b\u4e2d\n\u6b64\u5916\u8fd8\u53ef\u4ee5\u5728\u53e6\u5916\u7684\u7c7b\u4e2d\uff0c\u4e00\u6b21\u6027\u52a0\u8f7d\u6240\u6709\u7684so"),(0,o.kt)("p",null,"hook\u7cfb\u7edf\u51fd\u6570\u6765\u5f97\u5230\u7ed1\u5b9a\u7684native\u51fd\u6570\u5730\u5740\uff0c\u7136\u540e\u518d\u5f97\u5230so\u5730\u5740"),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:null},"\u6ce8\u518c\u65b9\u5f0f"),(0,o.kt)("th",{parentName:"tr",align:null},"hook\u70b9"))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"jni\u51fd\u6570\u52a8\u6001\u6ce8\u518c"),(0,o.kt)("td",{parentName:"tr",align:null},"hook RegisterNatives")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"jni\u51fd\u6570\u9759\u6001\u6ce8\u518c"),(0,o.kt)("td",{parentName:"tr",align:null},"hook dlsym")))),(0,o.kt)("h4",{id:"hook_registernatives"},"hook_RegisterNatives"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"function hook_RegisterNatives() {\n  let RegisterNatives_addr = null\n  let symbols = Process.findModuleByName('libart.so').enumerateSymbols()\n  for (let i = 0; i < symbols.length; i++) {\n    let symbol = symbols[i].name\n    if (symbol.indexOf('CheckJNI') == -1 && symbol.indexOf('JNI') >= 0) {\n      if (symbol.indexOf('RegisterNatives') >= 0) {\n        RegisterNatives_addr = symbols[i].address\n        console.log('RegisterNatives_addr: ', RegisterNatives_addr)\n      }\n    }\n  }\n  Interceptor.attach(RegisterNatives_addr, {\n    onEnter: function (args) {\n      let env = args[0]\n      let jclass = args[1]\n      let class_name = Java.vm.tryGetEnv().getClassName(jclass)\n      let methods_ptr = ptr(args[2])\n      let method_count = args[3].toInt32()\n      console.log('RegisterNatives method counts: ', method_count)\n      for (let i = 0; i < method_count; i++) {\n        let name = methods_ptr\n          .add(i * Process.pointerSize * 3)\n          .readPointer()\n          .readCString()\n        let sig = methods_ptr\n          .add(i * Process.pointerSize * 3 + Process.pointerSize)\n          .readPointer()\n          .readCString()\n        let fnPtr_ptr = methods_ptr.add(i * Process.pointerSize * 3 + Process.pointerSize * 2).readPointer()\n        let find_module = Process.findModuleByAddress(fnPtr_ptr)\n        console.log(\n          'RegisterNatives java_class: ',\n          class_name,\n          'name: ',\n          name,\n          'sig: ',\n          sig,\n          'fnPtr: ',\n          fnPtr_ptr,\n          'module_name: ',\n          find_module.name,\n          'module_base: ',\n          find_module.base,\n          'offset: ',\n          ptr(fnPtr_ptr).sub(find_module.base),\n        )\n      }\n    },\n    onLeave: function (retval) {},\n  })\n}\n\n")),(0,o.kt)("h4",{id:"hook_dlsym"},"hook_dlsym"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},'function hook_dlsym() {\n    let dlsymAddr = Module.findExportByName("libdl.so", "dlsym");\n    console.log(dlsymAddr);\n    Interceptor.attach(dlsymAddr, {\n        onEnter: function (args) {\n            this.args1 = args[1];\n        }, onLeave: function (retval) {\n            let module = Process.findModuleByAddress(retval);\n            if(module == null) return;\n            console.log(this.args1.readCString(), module.name, retval, retval.sub(module.base));\n        }\n    });\n}\n')),(0,o.kt)("h3",{id:"inlinehook\u9488\u5bf9\u5bc4\u5b58\u5668\u7684\u503c"},"inlineHook\uff08\u9488\u5bf9\u5bc4\u5b58\u5668\u7684\u503c\uff09"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},'function inlineHook() {\n    // var nativePointer = Module.findBaseAddress("libxiaojianbang.so");\n    // var hookAddr = nativePointer.add(0x17BC);\n    // Interceptor.attach(hookAddr, {\n    //     onEnter: function (args) {\n    //         console.log("onEnter: ", this.context.x8);\n    //     }, onLeave: function (retval) {\n    //         console.log("onLeave: ", this.context.x8.toInt32());\n    //         console.log(this.context.x8 & 7);\n    //     }\n    // });\n\n    var nativePointer = Module.findBaseAddress("libxiaojianbang.so");\n    var hookAddr = nativePointer.add(0x1B70);\n    Interceptor.attach(hookAddr, {\n        onEnter: function (args) {\n            console.log("onEnter: ", this.context.x1);\n            console.log("onEnter: ", hexdump(this.context.x1));\n        }, onLeave: function (retval) {\n\n        }\n    });\n}\n')),(0,o.kt)("h3",{id:"hook_dlopen"},"hook_dlopen"),(0,o.kt)("p",null,"\u6709\u4e9b\u51fd\u6570\u5728so\u9996\u6b21\u52a0\u8f7d\u7684\u65f6\u5019\u6267\u884c\uff0c\u800cso\u6ca1\u52a0\u8f7d\u4e4b\u524d\u53c8\u4e0d\u80fd\u53bbhook\uff0c\u90a3\u4e48\u8981hook\u8fd9\u4e9b\u51fd\u6570\uff0c\u5c31\u5fc5\u987b\u76d1\u63a7so\u4f55\u65f6\u88ab\u52a0\u8f7d\uff0c\u56e0\u6b64\uff0c\u9700\u8981hook dlopen\u7b49\u7cfb\u7edf\u51fd\u6570\uff0c\u5f53so\u52a0\u8f7d\u5b8c\u6bd5\uff0c\u7acb\u523bhook"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},'//hook_dlopen\nfunction hook_dlopen(addr, soName, callback) {\n    Interceptor.attach(addr, {\n        onEnter: function (args) {\n            let soPath = args[0].readCString();\n            if(soPath.indexOf(soName) != -1) this.hook = true;\n        }, onLeave: function (retval) {\n            if(this.hook) callback();\n        }\n    });\n}\n\nfunction hook_func() {\n    let baseAddr = Module.findBaseAddress("libxiaojianbang.so");\n    console.log("baseAddr", baseAddr);\n    let MD5Final = baseAddr.add(0x3540);\n    Interceptor.attach(MD5Final, {\n        onEnter: function (args) {\n            this.args1 = args[1];\n        }, onLeave: function (retval) {\n            console.log(hexdump(this.args1));\n        }\n    });\n}\n\nlet dlopen = Module.findExportByName("libdl.so", "dlopen"); // \u4f4e\u7248\u672c\u5b89\u5353\u7cfb\u7edf\nlet android_dlopen_ext = Module.findExportByName("libdl.so", "android_dlopen_ext"); // \u9ad8\u7248\u672c\u5b89\u5353\u7cfb\u7edf\n//console.log(JSON.stringify(Process.getModuleByAddress(dlopen)));\nhook_dlopen(dlopen, "libxiaojianbang.so", hook_func);\nhook_dlopen(android_dlopen_ext, "libxiaojianbang.so", hook_func);\n')),(0,o.kt)("h3",{id:"hook_initarray"},"hook_initarray"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"function main() {\n  function hook_dlopen(addr, soName, callback) {\n    Interceptor.attach(addr, {\n      onEnter: function (args) {\n        var soPath = args[0].readCString()\n        if (soPath.indexOf(soName) != -1) hook_call_constructors()\n      },\n      onLeave: function (retval) {},\n    })\n  }\n  var dlopen = Module.findExportByName('libdl.so', 'dlopen')\n  var android_dlopen_ext = Module.findExportByName('libdl.so', 'android_dlopen_ext')\n  hook_dlopen(dlopen, 'libxiaojianbang.so', inlineHook)\n  hook_dlopen(android_dlopen_ext, 'libxiaojianbang.so', inlineHook)\n\n  var isHooked = false\n  function hook_call_constructors() {\n    var symbols = Process.getModuleByName('linker64').enumerateSymbols()\n    var call_constructors_addr = null\n    for (let i = 0; i < symbols.length; i++) {\n      var symbol = symbols[i]\n      // initarray \u5728__dl__ZN6soinfo17call_constructorsEv\u4e2d\u88ab\u8c03\u7528\u7684\n      if (symbol.name.indexOf('__dl__ZN6soinfo17call_constructorsEv') != -1) {\n        call_constructors_addr = symbol.address\n      }\n    }\n    console.log('call_constructors_addr: ', call_constructors_addr)\n    Interceptor.attach(call_constructors_addr, {\n      onEnter: function (args) {\n        if (!isHooked) {\n          hook_initarray()\n          isHooked = true\n        }\n      },\n      onLeave: function (retval) {},\n    })\n  }\n\n  function hook_initarray() {\n    var xiaojianbangAddr = Module.findBaseAddress('libxiaojianbang.so')\n    var func1_addr = xiaojianbangAddr.add(0x1c54)\n    var func2_addr = xiaojianbangAddr.add(0x1c7c)\n    \n    Interceptor.replace(\n      func1_addr,\n      new NativeCallback(\n        function () {\n          console.log('func1 is replaced!!!')\n        },\n        'void',\n        [],\n      ),\n    )\n\n    Interceptor.replace(\n      func2_addr,\n      new NativeCallback(\n        function () {\n          console.log('func2 is replaced!!!')\n        },\n        'void',\n        [],\n      ),\n    )\n  }\n}\nmain()\n\n")),(0,o.kt)("h3",{id:"hook_jnionload"},"hook_JNIOnload"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},'hook_dlopen(dlopen, "libxiaojianbang.so", hook_JNIOnload);\nhook_dlopen(android_dlopen_ext, "libxiaojianbang.so", hook_JNIOnload);\n\nfunction hook_JNIOnload() {\n    var xiaojianbangAddr = Module.findBaseAddress("libxiaojianbang.so");\n    // 0x1CCC JNIOnload\u7684\u5730\u5740\n    var funcAddr = xiaojianbangAddr.add(0x1CCC);\n    Interceptor.replace(funcAddr, new NativeCallback(function () {\n        console.log("this func is replaced !");\n    }, \'void\', []));\n}\n')),(0,o.kt)("h3",{id:"hook_pthread_create"},"hook_pthread_create"),(0,o.kt)("p",null,"\u521b\u5efa\u5b50\u7ebf\u7a0b\u7684\u76f8\u5173\u51fd\u6570"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},'function hook_pthread_create(){\n    var pthread_create_addr = Module.findExportByName("libc.so", "pthread_create");\n    console.log("pthread_create_addr: ", pthread_create_addr);\n    Interceptor.attach(pthread_create_addr,{\n        onEnter:function(args){\n            console.log(args[0], args[1], args[2], args[3]);\n            var Module = Process.findModuleByAddress(args[2]);\n            if(Module != null) console.log(Module.name, args[2].sub(Module.base));\n        },onLeave:function(retval){\n        }\n    })\n}\nhook_pthread_create();\n')),(0,o.kt)("h2",{id:"\u5c01\u88c5so\u4e2d\u5e38\u7528hook\u51fd\u6570"},"\u5c01\u88c5so\u4e2d\u5e38\u7528hook\u51fd\u6570"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"function showStacks() {\n  console.log(Thread.backtrace(this.context, Backtracer.ACCURATE).map(DebugSymbol.fromAddress).join('\\n') + '\\n');\n}\n\nfunction findJNIFunc(func) {\n  if (!func) return null;\n  let artSym = Module.enumerateSymbols('libart.so');\n  for (const sym of artSym) {\n    if (!sym.name.includes('CheckJNI') && sym.name.includes(func)) {\n      // console.log(JSON.stringify(sym));\n      return sym.address;\n    }\n  }\n  return null;\n}\n\nfunction hookNewStringUTF() {\n  // \u627e\u5230 env->NewStringUTF(a1, str) \u51fd\u6570\n  const NewStringUTFAddr = findJNIFunc('NewStringUTF');\n  // console.log('NewStringUTFAddr', NewStringUTFAddr);\n  if (NewStringUTFAddr !== null) {\n    Interceptor.attach(NewStringUTFAddr, {\n      onEnter: function (args) {\n        showStacks.call(this);\n        console.log(args[1].readCString());\n      },\n      onLeave: function (retval) {},\n    });\n  }\n}\n\nfunction hookNewByteArray() {\n  const NewByteArrayAddr = findJNIFunc('NewByteArray');\n  console.log('NewByteArrayAddr', NewByteArrayAddr);\n  if (NewByteArrayAddr !== null) {\n    Interceptor.attach(NewByteArrayAddr, {\n      onEnter: function (args) {\n        showStacks.call(this);\n        console.log(args[1].toInt32());\n      },\n      onLeave: function (retval) {\n        // retval \u8fd4\u56de\u7684\u662f\u4e00\u4e2ajava\u5bf9\u8c61,\u4e0d\u53ef\u76f4\u63a5\u8bfb\u53d6,\u9700\u8981\u5c06\u5176\u8f6c\u4e3ac\u4e2d\u7684\u6307\u9488\n        // \u5f97\u5230\u662f\u4e00\u4e2a NativePointer\n        // let retPointer = Java.vm.tryGetEnv().getByteArrayElements(retval);\n        // console.log(retPointer.readByteArray(32));\n      },\n    });\n  }\n}\n\nfunction print_arg(addr) {\n  var module = Process.findRangeByAddress(addr);\n  if (module != null) return '\\n' + hexdump(addr);\n  return ptr(addr);\n}\n\nfunction hook_native_addr(funcPtr, params = [], result = {}) {\n  var module = Process.findModuleByAddress(funcPtr);\n  Interceptor.attach(funcPtr, {\n    onEnter: function (args) {\n      this.logs = [];\n      this.args = [];\n      this.logs.push('call ' + module.name + '!' + ptr(funcPtr).sub(module.base));\n      for (let i = 0; i < params.length; i++) {\n        let param = params[i];\n        this.args.push(args[i]);\n        if (param.type) {\n          this.logs.push(`a${i + 1} onEnter:` + args[i][param.type]());\n        } else {\n          this.logs.push(`a${i + 1} onEnter:` + print_arg(args[i]));\n        }\n      }\n    },\n    onLeave: function (retval) {\n      for (let i = 0; i < params.length; i++) {\n        let param = params[i];\n        if (param.type) {\n          this.logs.push(`a${i + 1} onLeave:` + this.args[i][param.type]());\n        } else {\n          this.logs.push(`a${i + 1} onLeave:` + print_arg(this.args[i]));\n        }\n      }\n      if (result.type) {\n        this.logs.push('retval onLeave: ' + retval[result.type]());\n      } else {\n        this.logs.push('retval onLeave: ' + print_arg(retval));\n      }\n      console.log(this.logs.join('\\n'));\n    },\n  });\n}\n\n// ================================================================================\n\n// hookNewStringUTF() // \u7528\u4e8e\u5b9a\u4f4dNewStringUTF\n// hookNewByteArray(); // \u7528\u4e8e\u5b9a\u4f4dNewByteArray\n\nconst moduleName = 'libnative-lib.so';\nlet baseAddr = Module.findBaseAddress(moduleName);\n\n// let sub_1234 = baseAddr.add(0x1234 + 1);\n// hook_native_addr(sub_1234, Array(3).fill({}));\n")),(0,o.kt)("h2",{id:"jnitrace"},"JNItrace"),(0,o.kt)("p",null,"so\u4e2d\u4f1a\u5e94\u7528\u5f88\u591a\u7684jni\u51fd\u6570\uff0c\u6bd4\u5982\uff1aJava\u7684\u5b57\u7b26\u4e32\u5230C\uff0c\u9700\u8981\u5148\u4f7f\u7528GetStringUtfChars\u6765\u8f6c\u6210C\u8bed\u8a00\u5b57\u7b26\u4e32\u3002\n\u800c\u52a0\u5bc6\u540e\u7684\u7ed3\u679c\uff0c\u5982\u679c\u8981\u8f6c\u6210jstring\uff0c\u53c8\u9700\u8981\u7528\u5230NewStringUtf\uff0c\u6240\u4ee5\u53ef\u4ee5\u901a\u8fc7hook\u8fd9\u4e9bjni\u51fd\u6570\uff0c\u6765\u53ef\u4ee5\u5b9a\u4f4d\u5173\u952e\u4ee3\u7801\uff0c\u4e5f\u53ef\u4ee5\u5927\u4f53\u4e0a\u4e86\u89e3\u51fd\u6570\u7684\u4ee3\u7801\u903b\u8f91\u3002"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"jnitrace\u5c31\u662fhook\u4e00\u7cfb\u5217\u7684jni\u51fd\u6570")),(0,o.kt)("p",null,"github\u5730\u5740\uff1a",(0,o.kt)("a",{parentName:"p",href:"https://github.com/chame1eon/jnitrace"},"https://github.com/chame1eon/jnitrace")),(0,o.kt)("p",null,"\u7248\u672c: jnitrace-3.3.0"),(0,o.kt)("h3",{id:"\u5b89\u88c5\u8fdb\u5165\u5230frida\u73af\u5883"},"\u5b89\u88c5\uff08\u8fdb\u5165\u5230frida\u73af\u5883\uff09"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"pip install jnitrace\n")),(0,o.kt)("h3",{id:"\u4f7f\u7528"},"\u4f7f\u7528"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"jnitrace -m attach -l <\u6a21\u5757.so> <\u5305\u540d>\n")),(0,o.kt)("p",null,"-m <spawn|attach> \u9644\u52a0\u65b9\u5f0f\u53bb\u8fd0\u884c"),(0,o.kt)("p",null,"-o path/output.json \u5c06\u7ed3\u679c\u8f93\u51fa\u5230\u6587\u4ef6\u4e0a"),(0,o.kt)("h2",{id:"ollvm\u5b57\u7b26\u4e32\u89e3\u5bc6"},"ollvm\u5b57\u7b26\u4e32\u89e3\u5bc6"),(0,o.kt)("p",null,"\u627e\u5230\u52a0\u5bc6\u7684\u5b57\u7b26\u4e32\u5730\u5740(\u57fa\u5740+\u53d8\u91cf\u504f\u79fb\u5730\u5740)\uff0c\u901a\u8fc7hexdump\u53ef\u4ee5\u76f4\u63a5\u6253\u5370\u51fa\u5185\u5b58\u4e2d\u89e3\u5bc6\u540e\u7684\u72b6\u6001"),(0,o.kt)("p",null,"\u4f7f\u7528JNItrace\uff0c\u4f46\u662f\u524d\u63d0\u53ea\u80fd\u67e5\u770bjni\u76f8\u5173\u51fd\u6570"),(0,o.kt)("p",null,"\u4ece\u5185\u5b58\u4e2ddump\u6574\u4e2aso\uff0c\u83b7\u53d6\u6240\u6709\u89e3\u5bc6\u540e\u7684\u5b57\u7b26\u4e32\uff0c\u4f46\u662f\u9700\u8981\u4fee\u590d"),(0,o.kt)("p",null,"\u5206\u6790so\u4e2d\u5b57\u7b26\u4e32\u89e3\u5bc6\u51fd\u6570\uff0c\u7136\u540e\u8fd8\u539f\uff08\u540cjs\u6df7\u6dc6\u89e3\u5bc6\u51fd\u6570\uff09"),(0,o.kt)("h3",{id:"dump_sojs"},"dump_so.js"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},'function dump_so(so_name) {\n    Java.perform(function () {\n        let currentApplication = Java.use("android.app.ActivityThread").currentApplication();\n        let dir = currentApplication.getApplicationContext().getFilesDir().getPath();\n        let libso = Process.getModuleByName(so_name);\n        console.log("[name]:", libso.name);\n        console.log("[base]:", libso.base);\n        console.log("[size]:", ptr(libso.size));\n        console.log("[path]:", libso.path);\n        let file_path = dir + "/" + libso.name + "_" + libso.base + "_" + ptr(libso.size) + ".so";\n        let file_handle = new File(file_path, "wb");\n        if (file_handle && file_handle != null) {\n            Memory.protect(ptr(libso.base), libso.size, \'rwx\');\n            let libso_buffer = ptr(libso.base).readByteArray(libso.size);\n            file_handle.write(libso_buffer);\n            file_handle.flush();\n            file_handle.close();\n            console.log("[dump]:", file_path);\n        }\n    });\n}\n')),(0,o.kt)("p",null,"\u4f7f\u7528dump_so(so_name)\u5c06\u4fdd\u5b58\u7684\u6587\u4ef6\u62c9\u53bb\u5230\u684c\u9762\u4e0a\uff08\u9700\u8981\u5148\u4ece\u79c1\u6709\u76ee\u5f55\u79fb\u52a8\u5230\u6743\u9650\u5927\u7684\u76ee\u5f55\u4e0b\u518d\u79fb\u52a8\u5230\u684c\u9762\uff09\u3002"),(0,o.kt)("p",null,"\u6b64\u65f6\u7684so\u6587\u4ef6\u76f4\u63a5\u901a\u8fc7IDA\u6253\u5f00\u4f1a\u62a5\u9519\uff0c\u9700\u8981\u4fee\u590d\uff0c\u4f7f\u7528\u7684\u5de5\u5177\u662f",(0,o.kt)("a",{parentName:"p",href:"https://github.com/F8LEFT/SoFixer"},"SoFixer"),"\u3002"),(0,o.kt)("h3",{id:"sofixer"},"SoFixer"),(0,o.kt)("p",null,"github\u5730\u5740\uff1a",(0,o.kt)("a",{parentName:"p",href:"https://github.com/F8LEFT/SoFixer"},"F8LEFT/SoFixer (github.com)")),(0,o.kt)("p",null,"\u4f7f\u7528\u65b9\u5f0f\u8be6\u770bREADME"),(0,o.kt)("p",null,"\u6ce8: \u4fee\u590d\u540e\u7684so\u6587\u4ef6\u65e0\u6cd5\u91cd\u65b0\u6253\u5305\u52a8\u6001\u5206\u6790\uff0c\u53ea\u53ef\u9759\u6001\u5206\u6790\u4f7f\u7528"),(0,o.kt)("h2",{id:"frida\u68c0\u6d4b"},"Frida\u68c0\u6d4b"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://bbs.pediy.com/thread-217482.htm"},"\u7ffb\u8bd1\u591a\u79cd\u7279\u5f81\u68c0\u6d4b Frida-\u5916\u6587\u7ffb\u8bd1-\u770b\u96ea\u8bba\u575b-\u5b89\u5168\u793e\u533a|\u5b89\u5168\u62db\u8058|bbs.pediy.com")),(0,o.kt)("h4",{id:"ptrace\u5360\u5751"},"ptrace\u5360\u5751"),(0,o.kt)("p",null,"ptrace(0, 0 ,0 ,0);\n\u5f00\u542f\u4e00\u4e2a\u5b50\u8fdb\u7a0b\u9644\u52a0\u7236\u8fdb\u7a0b\uff0c\u901a\u5e38\u6709\u4e00\u4e0b\u51e0\u79cd"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"\u5b88\u62a4\u8fdb\u7a0b"),(0,o.kt)("li",{parentName:"ul"},"\u5b50\u8fdb\u7a0b\u9644\u52a0\u7236\u8fdb\u7a0b \u76ee\u7684\u662f\u4e0d\u8ba9\u522b\u4eba\u9644\u52a0"),(0,o.kt)("li",{parentName:"ul"},"\u666e\u901a\u7684\u591a\u8fdb\u7a0b")),(0,o.kt)("p",null,"\u5c31\u53ea\u597d\u4f7f\u7528frida -f \u5305\u540d spawn\u65b9\u5f0f\u542f\u52a8"),(0,o.kt)("h4",{id:"\u8fdb\u7a0b\u540d\u68c0\u6d4b"},"\u8fdb\u7a0b\u540d\u68c0\u6d4b"),(0,o.kt)("p",null,"\u904d\u5386\u8fd0\u884c\u7684\u8fdb\u7a0b\u5217\u8868\uff0c\u68c0\u6d4bfrida-server\u662f\u5426\u8fd0\u884c"),(0,o.kt)("h4",{id:"\u7aef\u53e3\u68c0\u6d4b"},"\u7aef\u53e3\u68c0\u6d4b"),(0,o.kt)("p",null,"\u68c0\u6d4bfrida-server\u9ed8\u8ba4\u7aef\u53e327042\u662f\u5426\u5f00\u653e"),(0,o.kt)("h4",{id:"d-bus\u534f\u8bae\u901a\u4fe1"},"D-Bus\u534f\u8bae\u901a\u4fe1"),(0,o.kt)("p",null,"app\u8fd0\u884c\u65f6\uff0c\u4f1a\u521b\u5efa/proc/\u8fdb\u7a0bpid\u7684\u6587\u4ef6\u5939"),(0,o.kt)("p",null,"Frida\u4f7f\u7528D-Bus\u534f\u8bae\u901a\u4fe1\uff0c\u53ef\u4ee5\u904d\u5386/proc/net/tcp\u6587\u4ef6\uff0c\u6216\u8005\u76f4\u63a5\u4ece0-65535\n\u5411\u6bcf\u4e2a\u5f00\u653e\u7684\u7aef\u53e3\u53d1\u9001D-Bus\u8ba4\u8bc1\u6d88\u606f\uff0c\u54ea\u4e2a\u7aef\u53e3\u56de\u590d\u4e86REJECT\uff0c\u5c31\u662ffrida-server"),(0,o.kt)("h4",{id:"\u626b\u63cfmaps\u6587\u4ef6"},"\u626b\u63cfmaps\u6587\u4ef6"),(0,o.kt)("p",null,"cat maps"),(0,o.kt)("p",null,"maps\u6587\u4ef6\u7528\u4e8e\u663e\u793a\u5f53\u524dapp\u4e2d\u52a0\u8f7d\u7684\u4f9d\u8d56\u5e93\nFrida\u5728\u8fd0\u884c\u65f6\u4f1a\u5148\u786e\u5b9a\u8def\u5f84\u4e0b\u662f\u5426\u6709re.frida.server\u6587\u4ef6\u5939\n\u82e5\u6ca1\u6709\u5219\u521b\u5efa\u8be5\u6587\u4ef6\u5939\u5e76\u5b58\u653efrida-agent.so\u7b49\u6587\u4ef6\uff0c\u8be5so\u4f1a\u51fa\u73b0\u5728maps\u6587\u4ef6\u4e2d"),(0,o.kt)("h4",{id:"\u626b\u63cftask\u76ee\u5f55"},"\u626b\u63cftask\u76ee\u5f55"),(0,o.kt)("p",null,"\u626b\u63cf\u76ee\u5f55\u4e0b\u6240\u6709/task/pid/status\u4e2d\u7684Name\u5b57\u6bb5\n\u5bfb\u627e\u662f\u5426\u5b58\u5728frida\u6ce8\u5165\u7684\u7279\u5f81\n\u5177\u4f53\u7ebf\u7a0b\u540d\u4e3agmain\u3001gdbus\u3001gum-js-loop\u3001pool-frida\u7b49"),(0,o.kt)("h4",{id:"\u901a\u8fc7readlink"},"\u901a\u8fc7readlink"),(0,o.kt)("p",null,"\u67e5\u770b/proc/self/fd\u3001/proc/self/task/pid/fd\u4e0b\u6240\u6709\u6253\u5f00\u7684\u6587\u4ef6\uff0c\u68c0\u6d4b\u662f\u5426\u6709Frida\u76f8\u5173\u6587\u4ef6"),(0,o.kt)("h4",{id:"\u5e38\u89c1\u7528\u4e8e\u68c0\u6d4b\u7684\u7cfb\u7edf\u51fd\u6570"},"\u5e38\u89c1\u7528\u4e8e\u68c0\u6d4b\u7684\u7cfb\u7edf\u51fd\u6570"),(0,o.kt)("p",null,"strstr\u3001strcmp\u3001open\u3001read\u3001fread\u3001readlink"),(0,o.kt)("p",null,"\u626b\u63cf\u5185\u5b58\u4e2d\u662f\u5426\u6709Frida\u5e93\u7279\u5f81\u51fa\u73b0\uff0c\u4f8b\u5982\u5b57\u7b26\u4e32LIBFRIDA"),(0,o.kt)("h4",{id:"\u901a\u5e38\u6bd4\u8f83\u4f1a\u88ab\u68c0\u6d4b\u7684\u6587\u4ef6"},"\u901a\u5e38\u6bd4\u8f83\u4f1a\u88ab\u68c0\u6d4b\u7684\u6587\u4ef6"),(0,o.kt)("p",null,"riru\u7684\u7279\u5f81\u6587\u4ef6\n/system/lib/libmemtrack.so\n/system/lib/libmemtrack_real.so\ncmdline \u68c0\u6d4b\u8fdb\u7a0b\u540d\uff0c\u9632\u91cd\u6253\u5305\nstatus \u68c0\u6d4b\u8fdb\u7a0b\u662f\u5426\u88ab\u9644\u52a0\nstat \u68c0\u6d4b\u8fdb\u7a0b\u662f\u5426\u88ab\u9644\u52a0\ntask/xxx/cmdline \u68c0\u6d4b\u8fdb\u7a0b\u540d\uff0c\u9632\u91cd\u6253\u5305\ntask/xxx/stat \u68c0\u6d4b\u8fdb\u7a0b\u662f\u5426\u88ab\u9644\u52a0\ntask/xxx/status \u68c0\u6d4b\u7ebf\u7a0bname\u662f\u5426\u5305\u542bFrida\u5173\u952e\u5b57\nfd/xxx \u68c0\u6d4bapp\u662f\u5426\u6253\u5f00\u7684Frida\u76f8\u5173\u6587\u4ef6\nmaps \u68c0\u6d4bapp\u662f\u5426\u52a0\u8f7d\u7684\u4f9d\u8d56\u5e93\u91cc\u662f\u5426\u6709Frida\nnet/tcp \u68c0\u6d4bapp\u6253\u5f00\u7684\u7aef\u53e3"),(0,o.kt)("p",null,"huluda-server\u5904\u7406\u4e86re.frida.server\u6587\u4ef6\u5939\u4ee5\u53ca\u8be5\u6587\u4ef6\u5939\u4e0b\u7684\u6587\u4ef6\u7684\u540d\u5b57"),(0,o.kt)("p",null,"\u4f7f\u7528\u8fd9\u4e2aserver\uff0c\u4e0d\u653e\u5728/data/local/tmp\u76ee\u5f55\u4e0b\uff0c\u57fa\u672c\u53ef\u4ee5\u4e0d\u7528\u5173\u5fc3fd\u548cmaps\u7684\u68c0\u6d4b"),(0,o.kt)("p",null,"frida-gadget ",(0,o.kt)("a",{parentName:"p",href:"https://bbs.pediy.com/thread-269866.htm"},"https://bbs.pediy.com/thread-269866.htm")))}m.isMDXComponent=!0}}]);