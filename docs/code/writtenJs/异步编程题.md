---
title: 4. å¼‚æ­¥ç¼–ç¨‹é¢˜
sidebar_position: 4
date: 2022-08-01
tags: [é¢è¯•é¢˜]
---



## ç³»åˆ—ä¸€ async / await

async / await è¦ç‚¹ï¼š

- async function å¦‚æœæ²¡æœ‰é‡åˆ° await åˆ™ä¸€ç›´æ˜¯æŒ‰åºæ‰§è¡Œçš„ã€‚
- async function çš„ awaitï¼Œç›¸å½“äºä¸€ä¸ª `promise.then()` è¿ç®—ï¼Œåˆ™ await ä»¥åŠä¸‹é¢çš„ä»£ç éƒ½åœ¨ä¸€ä¸ªå¾®ä»»åŠ¡ä¸­æ‰§è¡Œã€‚
  - å³ä½¿ await å³ä¾§æ˜¯ä¸€ä¸ªç«‹å³å€¼ï¼Œä¹Ÿä¼šç»è¿‡ `Promise.resolve()` åŒ…è£¹ä¸€ä¸‹ï¼Œä¹Ÿæ˜¯å¼‚æ­¥å¾®ä»»åŠ¡ã€‚
  - âš ï¸âš ï¸âš ï¸**æ³¨æ„**ï¼šawait å³ä¾§çš„è¡¨è¾¾å¼æ˜¯åŒæ­¥è¿›å…¥å¹¶å¼€å§‹æ‰§è¡Œçš„ï¼Œasync function è®¨è®ºçš„å¼‚æ­¥é—®é¢˜æ˜¯ await æ¥å— **å³ä¾§è¡¨è¾¾å¼çš„è¿”å›å€¼**ï¼Œå¦‚æœè¿”å›çš„å€¼éœ€è¦ `promise.then()` å¤„ç†ï¼Œè¿™é‡Œå­˜åœ¨å¼‚æ­¥é—®é¢˜ã€‚

promise è¦ç‚¹ï¼š

- new Promise ä¸­çš„å›è°ƒå‡½æ•°æ˜¯ç«‹å³æ‰§è¡Œçš„ï¼Œæ²¡æœ‰å¼‚æ­¥æ“ä½œã€‚
- å‡ºç° `.then()` ã€`.catch()` æ“ä½œï¼Œå°±ä¼šäº§ç”Ÿä¸€ä¸ªå¾®ä»»åŠ¡ã€‚
- `Promise.resolve()` å’Œ `Promise.reject()` ä¼šäº§ç”Ÿä¸€ä¸ªå¾®ä»»åŠ¡ã€‚



#### é¢˜ç›®1

```js
async function bar() {
  console.log("22")
  return new Promise((resolve) => {
    resolve()
  })
}

async function foo() {
  console.log("11")
  await bar()
  console.log("33")
}

foo()
console.log("44")
```



æ‰§è¡Œé¡ºåºï¼š

```js
// å®ä»»åŠ¡1
11
22
44
// å¾®ä»»åŠ¡1.1
33
```

#### é¢˜ç›®2

```js
async function async1() {
  console.log("async1 start");
  await async2();  										// å¾®ä»»åŠ¡1.1
  console.log("async1 end");
}

async function async2() {
  console.log("async2");
}

console.log("script start");

setTimeout(function () {  						// å®ä»»åŠ¡2
  console.log("setTimeout");
}, 0);

async1();

new Promise(function (resolve) { 
  console.log("promise1");
  resolve();
}).then(function () {  // å¾®ä»»åŠ¡1.2
  console.log("promise2");
});

console.log("script end"); 
```

æ‰§è¡Œé¡ºåºï¼š

```js
// å®ä»»åŠ¡1
script start
async1 start
async2
promise1
script end
// å¾®ä»»åŠ¡1.1
async1 end
// å¾®ä»»åŠ¡1.2
promise2
// å®ä»»åŠ¡2
setTimeout
```

#### é¢˜ç›®3

```js
setTimeout(function () {
  console.log("setTimeout1");   // å®2
  new Promise(function (resolve) {
    resolve();
  }).then(function () {					// å¾®2.1
    new Promise(function (resolve) {
      resolve();
    }).then(function () {   		// å¾®2.2
      console.log("then4"); 
    });
    console.log("then2"); 
  });
});

new Promise(function (resolve) {
  console.log("promise1");   // 1
  resolve();
}).then(function () {			// å¾®1.1
  console.log("then1");   // 3
});

setTimeout(function () {	// å®3
  console.log("setTimeout2");  //    9
});

console.log(2);    // 2

queueMicrotask(() => {   // å¾®1.2
  console.log("queueMicrotask1")  // 4
});

new Promise(function (resolve) {
  resolve();
}).then(function () { 	// å¾®1.3
  console.log("then3");   // 5
});
```

æ‰§è¡Œé¡ºåºï¼š

```js
// å®1
promise1
2
// å¾®1.1
then1
// å¾®1.2
queueMicrotask1
// å¾®1.3
then3
// å®2
setTimeout1
// å¾®2.1
then2
// å¾®2.2
then4
// å®3
setTimeout2
```



## ç³»åˆ—äºŒ new Promise return

#### é¢˜ç›®1

```js
Promise.resolve(1).then((res) => {  // then ä¸‹ä¸€ä¸ªå¾®ä»»åŠ¡
  console.log(res);
})

new Promise((resolve, reject) => {
  console.log(2);
  resolve();
}).then(() => console.log(3));   // then ä¸‹ä¸€ä¸ªå¾®ä»»åŠ¡

console.log(4);
```

- `Promise.resolve()` ä¸ç®—ä¸€æ¬¡å¾®ä»»åŠ¡

æ‰§è¡Œé¡ºåº
```js
2
4
1
3
```



#### é¢˜ç›®2

ç¬¬ä¸€ä¸ª Promiseï¼Œç›´æ¥ return 4

- `return 4` ç›¸å½“äºï¼š`return Promise.resolve(4);` æ²¡æœ‰é¢å¤–çš„å¾®ä»»åŠ¡ã€‚

```js
Promise.resolve().then(() => { // then ä¸‹ä¸€ä¸ªå¾®ä»»åŠ¡
  console.log(0);    
  return 4;						
}).then((res) => {	 // then ä¸‹ä¸€ä¸ªå¾®ä»»åŠ¡
  console.log(res);
});

Promise.resolve().then(() => {  // then ä¸‹ä¸€ä¸ªå¾®ä»»åŠ¡
  console.log(1);			
}).then(() => {			// then ä¸‹ä¸€ä¸ªå¾®ä»»åŠ¡
  console.log(2);
}).then(() => {			// then ä¸‹ä¸€ä¸ªå¾®ä»»åŠ¡
  console.log(3);
}).then(() => {			// then ä¸‹ä¸€ä¸ªå¾®ä»»åŠ¡
  console.log(5);
}).then(() => {			// then ä¸‹ä¸€ä¸ªå¾®ä»»åŠ¡
  console.log(6);
});
```

æ‰§è¡Œé¡ºåºï¼š

```js
0
1
4
2
3
5
6
```

#### é¢˜ç›®3

ç¬¬ä¸€ä¸ª Promise ä¸­ï¼Œreturn thenableã€‚è¿™é‡Œåˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼š

1. Promise ä¼šå…ˆæ‰§è¡Œ thenï¼Œå°è¯•å¾—åˆ°ä¸€ä¸ªç«‹å³å€¼ã€‚
2. ç„¶å `Promise.resolve()` åŒ…è£¹è¿”å›ã€‚

é‡åˆ°éç«‹å³å€¼ã€‚Promise ä¼šæŠŠæ¥ä¸‹æ¥çš„ä»£ç æ”¾åˆ°ä¸‹ä¸€ä¸ªå¾®ä»»åŠ¡ä¸­ã€‚

âš ï¸ï¼šPromise è°ƒç”¨ then æ–¹æ³•ï¼Œä¼šæ”¾åœ¨ä¸‹ä¸€ä¸ªå¾®ä»»åŠ¡ä¸­ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœ `return thenable` æ–¹æ³•ï¼Œä¼šè·³åˆ°ä¸‹ä¸€ä¸ªå¾®ä»»åŠ¡ä¸­æ‰§è¡Œã€‚

```js
Promise.resolve().then(() => { // then ä¸‹ä¸€ä¸ªå¾®ä»»åŠ¡
  console.log(0); 
  return {
    then: function(resolve) {	 // thenable ä¸‹ä¸€ä¸ªå¾®ä»»åŠ¡
      console.log('then function');
      resolve(4);
		}
  }
}).then((res) => {				// then ä¸‹ä¸€ä¸ªå¾®ä»»åŠ¡
  console.log(res);
})

Promise.resolve().then(() => {	// then ä¸‹ä¸€ä¸ªå¾®ä»»åŠ¡
  console.log(1);			
}).then(() => {			// then ä¸‹ä¸€ä¸ªå¾®ä»»åŠ¡
  console.log(2);
}).then(() => {			// then ä¸‹ä¸€ä¸ªå¾®ä»»åŠ¡
  console.log(3);
}).then(() => {			// then ä¸‹ä¸€ä¸ªå¾®ä»»åŠ¡
  console.log(5);
}).then(() => {			// then ä¸‹ä¸€ä¸ªå¾®ä»»åŠ¡
  console.log(6);
});
```

ç»“æœï¼š

```js
0
1
the function
2
4
3
5
6
```

#### é¢˜ç›®4

ç¬¬ä¸€ä¸ª Promise ä¸­ï¼Œ`return Promise.resolve()`ã€‚

é‡åˆ°éç«‹å³å€¼ã€‚Promise ä¼šæŠŠæ¥ä¸‹æ¥çš„ä»£ç æ”¾åˆ°ä¸‹ä¸€ä¸ªå¾®ä»»åŠ¡ä¸­ã€‚

- é¢å¤–çš„ã€Œè®°ã€ï¼š`return Promise.resolve()` ä¼šæ”¾åˆ°ä¸‹ä¸‹ä¸€ä¸ªå¾®ä»»åŠ¡ä¸­ï¼Œå³æ¨è¿Ÿ 2 æ¬¡ã€‚
  - å¯¹æ¯”ä¸Šä¸€é¢˜ 4 çš„æ‰“å°æ—¶æœºï¼Œå¯ä»¥çœ‹åˆ°å½“å‰é¢˜ 4 ä½ç½®é åäº† 1 ä½ã€‚

```js
Promise.resolve().then(() => { // then ä¸‹ä¸€ä¸ªå¾®ä»»åŠ¡
  console.log(0); 
  return Promise.resolve(4);	 	// ğŸ“’â—ï¸ä¸‹ä¸‹ä¸€ä¸ªå¾®ä»»åŠ¡ï¼ˆæ¨è¿Ÿ2æ¬¡ï¼‰
}).then((res) => {				// then ä¸‹ä¸€ä¸ªå¾®ä»»åŠ¡
  console.log(res);
})

Promise.resolve().then(() => {	// then ä¸‹ä¸€ä¸ªå¾®ä»»åŠ¡
  console.log(1);			
}).then(() => {			// then ä¸‹ä¸€ä¸ªå¾®ä»»åŠ¡
  console.log(2);
}).then(() => {			// then ä¸‹ä¸€ä¸ªå¾®ä»»åŠ¡
  console.log(3);
}).then(() => {			// then ä¸‹ä¸€ä¸ªå¾®ä»»åŠ¡
  console.log(5);
}).then(() => {			// then ä¸‹ä¸€ä¸ªå¾®ä»»åŠ¡
  console.log(6);
});
```

æµ‹è¯•ç»“æœï¼š

```js
0 1 2 3 4 5 6
```



## ç³»åˆ—ä¸‰ node ç¯å¢ƒ

node çš„äº‹ä»¶å¾ªç¯ï¼ŒçŸ¥è¯†ç‚¹è§ï¼š**Node çš„äº‹ä»¶å¾ªç¯**

é€šå¸¸è¦è€ƒè™‘ä»¥ä¸‹å‡ ä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼š

```
main script	|	nexttick å¾®	|	other å¾®	|	timer å®ï½œ	check å®	
```

- poll é˜Ÿåˆ—æ˜¯ IO æ“ä½œï¼Œé€šå¸¸ä¸ä¼šè€ƒå¯Ÿã€‚

æ³¨æ„ï¼š

- å¾®ä»»åŠ¡ä¼˜å…ˆæ‰§è¡Œçš„ã€‚å¾®ä»»åŠ¡ä¸­ï¼š
  - `process.nextTick` åœ¨ nexttick é˜Ÿåˆ—ä¸­ï¼Œæ˜¯ä¼˜å…ˆæ‰§è¡Œçš„ï¼›
  - Promiseçš„ then å›è°ƒã€`queueMicrotask` æ˜¯é åæ‰§è¡Œçš„ã€‚
- å®ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼š
  - `setTimeout`ã€`setInterval` åœ¨ timer é˜Ÿåˆ—ä¸­ï¼Œæ˜¯ä¼˜å…ˆæ‰§è¡Œçš„ï¼›
  - `setImmediate` æ˜¯æœ€åæ‰§è¡Œçš„ã€‚

ğŸ€„ï¸æ€»ç»“ï¼šå’Œæµè§ˆå™¨ä¸åŒï¼Œnode ä¸­éœ€è¦é¢å¤–æ³¨æ„ä¸¤ç‚¹ï¼Œåœ¨ä¸€ä¸ª tick ä¸­ï¼š

- `process.nextTick` æ˜¯å¾®ä»»åŠ¡ï¼Œæ˜¯æœ€å…ˆæ‰§è¡Œçš„ã€‚
- `setImmediate` æ˜¯å®ä»»åŠ¡ï¼Œæ˜¯æœ€åæ‰§è¡Œçš„ã€‚

#### é¢˜ç›®1

```js
async function async1() {
  console.log('async1 start') // 2
  await async2()							// å¾®2
  console.log('async1 end')		// 9
}

async function async2() {
  console.log('async2')			// 3
}

console.log('script start')  // 1

setTimeout(function () {		 // å®1
  console.log('setTimeout0')	// 11
}, 0)

setTimeout(function () {		// å®300ï¼Œæ¨è¿Ÿæ‰§è¡Œ
  console.log('setTimeout2')		// 13
}, 300)

setImmediate(() => console.log('setImmediate'));  // å®2 // 12

process.nextTick(() => console.log('nextTick1'));  //å¾®1 // 7

async1();

process.nextTick(() => console.log('nextTick2'));	// å¾®1 // 8

new Promise(function (resolve) {	
  console.log('promise1')			// 4
  resolve();
  console.log('promise2')			// 5
}).then(function () {						// å¾®2
  console.log('promise3')			// 10
})

console.log('script end') // 6
```

æ³¨æ„

- æœ€åä¸€ä¸ª Promise ä¸­ï¼Œpromise1 å’Œ promise2 æ˜¯åŒæ­¥æ‰§è¡Œçš„ã€‚
- ç¬¬ä¸‰è¡Œ `await async2()`  ä¸­ï¼Œå¯¹ `async2()` çš„è°ƒç”¨æ—¶åŒæ­¥æ‰§è¡Œçš„ã€‚
- ç¬¬äºŒä¸ª `setTimeout` æ¨è¿Ÿ 300 æ¯«ç§’æ‰§è¡Œï¼Œä¸åœ¨ä¸‹ä¸€ä¸ª tick ä¸­ï¼Œåªæœ‰æ¨è¿Ÿ 0 æ¯«ç§’çš„åœ¨ä¸‹ä¸€ä¸ª tickï¼Œæ‰€ä»¥è¯¥æ–¹æ³•çš„æ‰§è¡Œæ¯”ä»£ç ä¸­çš„ `setImmediate` é åã€‚

```js
script start
async1 start
async2
promise1
promise2
script end
nextTick1
nextTick2
async1 end
promise3
setTimeout0
setImmediate
setTimeout2
```



