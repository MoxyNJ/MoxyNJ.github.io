<!doctype html>
<html lang="zh" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-frontEnd/React/React_Note">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.18">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="ninjee RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="ninjee Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="ninjee JSON Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Ninjee的前端篮子" href="/opensearch.xml">
<script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?0930342e569f854bebdeb485c0eac7f8",e.defer=!0;var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script>
<meta name="baidu-site-verification" content="code-rqLUw5reVS">
<link rel="icon" href="/img/ninjee.jpeg">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="rgb(51 139 255)"><title data-rh="true">1. React笔记 - Ninjee的前端篮子</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://ninjee.netlify.app/img/ninjee.jpeg"><meta data-rh="true" name="twitter:image" content="https://ninjee.netlify.app/img/ninjee.jpeg"><meta data-rh="true" property="og:url" content="https://ninjee.netlify.app/docs/frontEnd/React/React_Note"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="keywords" content="Moxy, Ninjee, blog, javascript, typescript, python ,node, react, vue, web, 前端, 后端"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="1. React笔记 - Ninjee的前端篮子"><meta data-rh="true" name="description" content="React 架构体系三大模块"><meta data-rh="true" property="og:description" content="React 架构体系三大模块"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://ninjee.netlify.app/docs/frontEnd/React/React_Note"><link data-rh="true" rel="alternate" href="https://ninjee.netlify.app/docs/frontEnd/React/React_Note" hreflang="zh"><link data-rh="true" rel="alternate" href="https://ninjee.netlify.app/docs/frontEnd/React/React_Note" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://OITUMQ5615-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.7d792d30.css">
<link rel="preload" href="/assets/js/runtime~main.1d2ced33.js" as="script">
<link rel="preload" href="/assets/js/main.b11b27b3.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">跳到主要内容</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/ninjee-icon.png" alt="ninjee" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/ninjee-icon.png" alt="ninjee" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Ninjee</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">前端知识</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/frontEnd/JavaScript">JavaScript</a></li><li><a class="dropdown__link" href="/docs/frontEnd/HTML&amp;CSS">HTML &amp; CSS</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/frontEnd/React">React</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">敲代码</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/code/algorithm">算法</a></li><li><a class="dropdown__link" href="/docs/code/writtenJs">手写Js</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">面试</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/interview/summary">总结</a></li><li><a class="dropdown__link" href="/docs/interview/internet">计算机网络</a></li><li><a class="dropdown__link" href="/docs/interview/os">操作系统</a></li><li><a class="dropdown__link" href="/docs/interview/iot">物联网</a></li></ul></div><a class="navbar__item navbar__link" href="/project">我的项目</a><div class="toggle_S7eR colorModeToggle_vKtC"><button class="clean-btn toggleButton_rCf9 toggleButtonDisabled_Pu9x" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_qEbK"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="docPage_P2Lg"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_RiAD"><nav class="menu thin-scrollbar menu_izAj"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/frontEnd/React">概述</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/docs/frontEnd/React/React_Note">1. React笔记</a></li></ul></nav><button type="button" title="收起侧边栏" aria-label="收起侧边栏" class="button button--secondary button--outline collapseSidebarButton_FykI"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_DTRl"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Xlws" aria-label="breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/">🏠</a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="item name">1. React笔记</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>1. React笔记</h1></header><p>React 架构体系三大模块</p><ul><li>调度</li><li>协调</li><li>渲染</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="react-设计理念">React 设计理念<a class="hash-link" href="#react-设计理念" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="问题react-架构">问题：react 架构<a class="hash-link" href="#问题react-架构" title="标题的直接链接">​</a></h3><h5 class="anchor anchorWithStickyNavbar_mojV" id="设计理念">设计理念<a class="hash-link" href="#设计理念" title="标题的直接链接">​</a></h5><p>浏览器的性能瓶颈在 CPU 和 IO。</p><p>React 解决 CPU / IO 的瓶颈：<strong>异步可中断的更新</strong>。</p><p>浏览器的刷新率通常为 60Hz/s，也就是 16.6ms 刷新一次页面。</p><ul><li>16.6ms 中，浏览器需要完成：JS脚本执行、样式布局、样式绘制。</li></ul><p>当渲染的处理时间超过 16.6ms，页面就会卡顿。通常使用节流（间隔触发）、防抖（最后一个触发），都是通过限制更新频率来提升性能。</p><p>React 把同步更新，变为异步可中断进行更新。React 通过 fiber 把渲染任务切分为多个小段，每个小段执行完毕后会把主动权交还浏览器，浏览器则可根据当前任务的优先级，把剩余时间分配给更重要的任务，以确保尽可能的响应及时。</p><ul><li>16.6ms 中，当浏览器执行完重要任务后，会把剩余时间交给 React 取执行尚未处理完的任务，如果剩余时间不够，就会把剩余任务在下一个 16.6ms 周期中执行。</li></ul><p>这样，浏览器就有充足的时间进行样式布局和页面绘制，而 React 也可以在分配给自己的时间内执行完任务。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="异步可中断">异步可中断<a class="hash-link" href="#异步可中断" title="标题的直接链接">​</a></h5><p>React 15+ 实现了异步可中断的架构。</p><ul><li>Scheduler 调度器：调度更新，给更新任务安排优先级。</li><li>Reconcoler 协调器：决定需要更新什么组件，当更高优任务来到时，可中断当前任务。</li><li>Renderer 渲染器：将组件更新到视图中，渲染过程是同步且不可中断的，需要一气呵成。</li></ul><p>在 render 函数的执行周期中，有调度（事件触发）、协调（render）、渲染（commit）三个阶段：</p><p><img loading="lazy" alt="image-20220806230807382" src="/assets/images/image-20220806230807382-ce972a80313ee829768b13c49c111bbd.png" width="1412" height="602" class="img_E7b_"></p><h4 class="anchor anchorWithStickyNavbar_mojV" id="1-调度阶段">1 调度阶段<a class="hash-link" href="#1-调度阶段" title="标题的直接链接">​</a></h4><p>当 React 需要更新时，更新任务首先被 Scheduler 调度器 处理。</p><p>处理的工作有：</p><ul><li><strong>创建项目根 Fiber 节点</strong>。首次渲染页面时，会创建唯一的根节点 FiberRoot Node。</li><li><strong>创建应用根 Fiber 节点</strong>。每一个 <code>ReactDOM.render()</code> 都会创建一个 rootFiber。</li><li><strong>初始化事件</strong>。Scheduler 会把任务按照优先级排序，让更高优的任务首先进入 Reconciler 协调器进行下一步处理。</li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="2-协调阶段">2 协调阶段<a class="hash-link" href="#2-协调阶段" title="标题的直接链接">​</a></h4><p><strong>协调阶段是 Reconcoler 协调器在参与，也被称为 render 阶段</strong>，如下图 renderRootSync 都为协调阶段。</p><p><img loading="lazy" alt="image-20220806231908259" src="/assets/images/image-20220806231908259-29f8253c8f951b76032810417729e781.png" width="680" height="386" class="img_E7b_"></p><p>Scheduler 调度器会通过 diff 算法，处理传入的更新任务。diff 完毕后，会由 fiber 构成一颗新的 virtualDOM 树，然后提交给 Renderer 渲染器进一步处理。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="该阶段的特点">该阶段的特点：<a class="hash-link" href="#该阶段的特点" title="标题的直接链接">​</a></h5><ul><li><strong>可暂停</strong>。而在 Reconciler 在进行 diff 算法时，如果调度器传来一个更高优的任务，那么当前处理的更新任务会被暂停，让调度器放入任务队列中，优先处理传入的更高优任务。</li><li><strong>用户透明</strong>。由于调度器和协调器是在内存中工作，即使 diff 中断，用户也无法感知到页面渲染被中断 / 卡顿。</li><li><strong>构建 work In Progres 树</strong>。diff 算法会构建一颗虚拟 dom 树，视图上真实存在的节点，都有一个对应的节点在虚拟 dom 上。需要更新的节点会被打上标记 Update。被打了标记的虚拟 dom 会交给渲染器。</li></ul><h5 class="anchor anchorWithStickyNavbar_mojV" id="该阶段的工作">该阶段的工作：<a class="hash-link" href="#该阶段的工作" title="标题的直接链接">​</a></h5><p><strong>调和 work IN Progress Tree</strong>，也可以理解为构建 work IN Progress Tree。</p><p>构建过程是一个递归过程，从  <code>rootFiber</code>  开始向下深度优先遍历的，具体可以分为 n 个：递阶段 + 归阶段。</p><p><strong>（1）递阶段</strong></p><p>递阶段，是向下调和的过程。</p><p>调用 <strong>beginWork</strong> 方法，从  <code>rootFiber</code>  开始向下深度优先遍历，为遍历到的每个 fiber 节点。</p><p>该方法会根据传入的 <code>Fiber节点</code> 创建 <code>子Fiber节点</code>，并将这两个 <code>Fiber节点</code> 连接起来（<strong>fiber.child</strong> 指针）。当遍历到叶子节点（即没有子组件的组件）时就会进入 “归” 阶段。</p><p>如果不是初次渲染，而是更新页面，此时已经存在一个构建好的 <strong>Current Tree</strong>，<strong>beginWork</strong> 方法会由 fiberRoot 根节点，按照 <strong>child</strong> 指针逐层向下调和。</p><p>beginWork 具体的工作如下：</p><ul><li>对于组件，执行部分生命周期，执行 render ，得到最新的 children。</li><li>向下遍历调和 children ，复用 oldFiber ( diff 算法)。</li><li>打不同的副作用标签 effectTag ，比如类组件的生命周期，或者元素的增加，删除，更新。这些被标记的节点，会在归阶段收集起来，形成单项链表 effectList。</li></ul><div class="codeBlockContainer_I0IT language-js theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-js codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 生命周期钩子会在协调阶段被调用：</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">constructor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">componentWillMount 废弃</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">componentWillReceiveProps 废弃</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> getDerivedStateFromProps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">shouldComponentUpdate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">componentWillUpdate 废弃</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">render</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 常见的 effect tag</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> Placement </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/*             */</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0b0000000000010</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 插入节点</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> Update </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/*                */</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0b0000000000100</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 更新fiber</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> Deletion </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/*              */</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0b0000000001000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 删除fiebr</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> Snapshot </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/*              */</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0b0000100000000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 快照</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> Passive </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/*               */</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0b0001000000000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// useEffect的副作用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> Callback </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/*              */</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0b0000000100000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// setState的 callback</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> Ref </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/*                   */</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0b0000010000000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ref</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><strong>（2）归阶段</strong></p><p>归阶段，是向上并归的过程。</p><p>调用 <strong>completeWork</strong> 方法，来处理当前的 Fiber 节点。</p><p>当某个 <code>Fiber节点</code> 执行完 <code>completeWork</code>，如果其存在 <code>兄弟Fiber节点</code>（<strong>fiber.sibling</strong> 指针 ），会进入其 <code>兄弟Fiber</code> 的 “递”阶段。如果不存在 <code>兄弟Fiber</code>，会进入 <code>父级Fiber</code> 的“归”阶段（<strong>fiber.return</strong> 指针）。</p><p>在此期间会形成 effectList 单项副作用链表。如果是初次渲染的初始化流程，会创建 DOM ，对于 DOM 元素进行事件收集，处理 style，className 等工作。</p><ul><li>completeUnitOfWork
会将 effectTag 的 Fiber 节点会被保存在一条被称为 effectList 的单向链表中。在 之后的 commit 阶段，将不再需要遍历每一个 fiber ，只需要执行更新 effectList 就可以了。</li><li>completeWork 阶段
对于组件，会处理 context ；
对于元素标签初始化，会创建真实 DOM ，将子孙 DOM 节点插入刚生成的 DOM 节点中；
会触发 diffProperties 处理 props ，比如事件收集，style，className 处理，在15章讲到过。</li></ul><p><strong>（3）进入循环</strong></p><p>“递”和“归”阶段会交错执行，直到 “归” 到 <code>rootFiber</code> 根结点。至此，<code>render阶段</code> 的工作就结束了。</p><ul><li>构成（调和）了由 fiber节点构成的 work IN Progress Tree 树。</li><li>构成了接下来 commit 阶段需要执行更新的 effectList 副作用链表。</li></ul><p><img loading="lazy" alt="截屏2022-08-08 00.27.04" src="/assets/images/截屏2022-08-08 00.27.04-d65a2edb1c300496eae515e26cb61e62.png" width="2130" height="1850" class="img_E7b_"></p><h4 class="anchor anchorWithStickyNavbar_mojV" id="3-渲染阶段">3 渲染阶段<a class="hash-link" href="#3-渲染阶段" title="标题的直接链接">​</a></h4><p><strong>渲染器工作的阶段，是 Renderer 渲染器在参与，被称为 commit 阶段</strong>，下图中，commitRoot 就是 commit 阶段。</p><p><img loading="lazy" alt="image-20220806232428977" src="/assets/images/image-20220806232428977-7a5bc8cbc0acce02ca01ee1931d01d5b.png" width="980" height="420" class="img_E7b_"></p><p>本次更新由哪些组件需要更新视图，会让渲染器来分别执行这些视图更新操作。</p><p>每一个子阶段都是一个 while 循环，<strong>从头开始</strong> 遍历副作用链表。</p><ul><li>视图更新操作：对 DOM 节点的增、删、查、改。</li><li>渲染器把被打了标记的虚拟 dom 对应的真实 dom 节点执行更新 dom 的操作。</li><li>Mutation 突变，对于浏览器来说，就是 DOM 操作。</li></ul><p>该阶段触发的生命周期函数有：</p><div class="codeBlockContainer_I0IT language-js theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-js codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// before mutation 阶段</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">getSnapshotBeforeUpdate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// mutation 阶段</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">componentWillUnmount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// layout 阶段</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">componentDidMount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">componentDidUpdate</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><strong>（1）mutation 前阶段</strong></p><p>通常被称之为 before mutation 阶段，调用函数 <code>commitBeforeMutationEffects</code>。</p><ul><li><strong>class 组件</strong>。执行 <code>getSnapshotBeforeUpdate</code> 生命周期函数。因为 Before mutation 还没修改真实的 DOM 所以此时类组件可以获得更新 DOM 前的快照。</li><li><strong>函数组件</strong>。创建微任务，给 <code>useEffect</code> 的回调函数设定 normal Scheduler Priority，然后等待 commit 完成后，再 <strong>异步执行</strong>。防止同步执行时阻塞浏览器做视图渲染（如果对 dom 操作，则又要重协调）。</li></ul><p><strong>（2）mutaiton 阶段</strong></p><p>通常被称之为 mutation 阶段，调用函数 <code>commitMutationEffects</code>。</p><p>遍历包含 EffectTag 的 fiber 节点，所组成的 effectList 链表。处理每一个 fiber 节点的副作用，这些副作用有：</p><ul><li><strong>DOM 相关操作</strong>：增删改。Placement 插入，Update 更新 DOM 属性，Deletion 删除。</li><li><strong>class 组件</strong>。调用 class 组件 componentWillUnmount 生命周期函数。</li><li><strong>函数组件</strong>。执行 useLayoutEffect 的销毁函数，useLayoutEffect 是 <strong>同步执行</strong> 的。</li><li><strong>Ref 属性</strong>。解绑/更新 Ref 属性。</li></ul><p><strong>（2.1）更改 current 指针</strong></p><p>在进入 layout 节点前，会执行：</p><div class="codeBlockContainer_I0IT language-js theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-js codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">root</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">current </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> finishedWork</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>这就是 React 架构的双缓存机制中，Work In Progress Fiber 树完成渲染，此时 <code>fiberRoot.current</code> 指针会从之前的 current Fiber 树，指向现在的 Work In Progress Fiber 树。此时，Work In Progress Fiber 树，就变成了新的 Current Fiber 树。</p><p>在该实际触发，是因为在 layout 阶段会执行 <code>componentDidMount</code> 和 <code>componentDidUpdate </code>这两个生命周期函数，此时，Current Fiber 树已经指向了本次完成的 Work In Progress Fiber 树，这两个生命周期会对新的 Current Fiber 树进行操作。</p><p><strong>（3）mutation 后阶段</strong></p><p>通常被称之为 layout 阶段，调用函数 <code>commitLayoutEffects</code>。</p><ul><li><strong>函数组件</strong>。<ul><li>执行 useLayoutEffect 的回调函数，是 <strong>同步执行</strong> 的。</li><li>绑定 useEffect 的销毁 + 回调函数，以便在 commit 阶段完成后，<strong>异步执行</strong> useEffect 销毁 + 回调函数。</li></ul></li><li><strong>类组件</strong>。<ul><li>根据组件状态，同步执行，调用 class 生命周期：<ul><li>ComponentDidMount（组件挂载）、ComponentDidUpdate（组件卸载）</li></ul></li><li>同步执行 <code>this.setState(arg, callback)</code> 中的 <code>callback</code>回调。</li></ul></li><li>处理 Ref 属性。</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="问题algebraic-effects">问题：algebraic effects<a class="hash-link" href="#问题algebraic-effects" title="标题的直接链接">​</a></h3><p>Process 进程、Thread 线程、Coroutine 协程、Fiber 纤程</p><ul><li>JavaScript 通过 Generator，在协程层面实现了异步可中断更新。</li></ul><p>algebraic effects 代数效应：是函数式编程中的概念，用于将副作用从函数调用中分离。</p><blockquote><ul><li><p><a href="https://zhuanlan.zhihu.com/p/380855727" target="_blank" rel="noopener noreferrer">https://zhuanlan.zhihu.com/p/380855727</a></p></li><li><p><a href="https://juejin.cn/post/6844903976299675662" target="_blank" rel="noopener noreferrer">https://juejin.cn/post/6844903976299675662</a></p></li></ul></blockquote><h4 class="anchor anchorWithStickyNavbar_mojV" id="algebraic-effects-的由来">algebraic effects 的由来<a class="hash-link" href="#algebraic-effects-的由来" title="标题的直接链接">​</a></h4><ul><li>在异步编程中，如果想用同步的思维编写代码，就要使用 async/await。但 async 函数具有传染性，调用 async 的函数也必须要用 async 定义。这样逐渐传染出去，所有的函数都需要变成异步函数，造成了大范围影响，同步异步代码也不易区分。</li></ul><p>新的需求：在同步代码中，可以调用异步函数并获得结果。但不影响同步函数的逻辑（同步函数不要 async 定义）</p><ul><li>try/catch  + throw 具有跳出当前代码块（throw 区），然后冒泡到 try/catch 被捕获，在 catch 继续执行代码的能力。</li></ul><p>新的需求：Js 中，具有从同步代码跳出的逻辑，就是 try/catch 了，但只能从 throw 跳出到 catch，不可以再携带结果回到 throw 中。我们如何定义这样的功能呢？</p><ul><li>此时我们需要一个可以在 throw 区暂停执行，从 catch 区域获取答案，再跳回 throw 处继续执行代码的 “异步” 能力。这就是许多文章中说的定义一个语法：perform，try/handle，resume with。</li></ul><div class="codeBlockContainer_I0IT language-js theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-js codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">user</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> user</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 1. 我们在这里 perform 了一个 effect：name = perform &#x27;ask_name&#x27;;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> perform </span><span class="token string" style="color:#e3116c">&#x27;ask_name&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 4. …… 然后最终回到了这里（name 现在是「Arya Stark」了 </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">makeFriends</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">user1</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> user2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  user1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">friendNames</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">getName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">user2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  user2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">friendNames</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">getName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">user1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> arya </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> gendry </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Gendry&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">makeFriends</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arya</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> gendry</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">handle</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">effect</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 2. 我们跳到了handler（就像 try/catch）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">effect </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;ask_name&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 3. 然而我们可以 resume with 一个值（这就不像 try / catch 了！）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resume </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Arya Stark&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ul><li>通过 perform + resume with 实现对后续流程的控制，控制反转 + 控制恢复。</li><li>通过 try/handle 实现跨调用栈捕获当前 continuation（延续—），在上面的例子中，就是让同步代码可以继续执行下去的那个值（name）。resume with 可以替换 当前的 continuaiton，让 perform 处恢复执行。</li></ul><p>需求满足：通过上述的语法糖，实现了在同步代码中，调用一个异步函数但不影响同步代码区的目的。</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="algebraic-effects-解决的问题">Algebraic Effects 解决的问题<a class="hash-link" href="#algebraic-effects-解决的问题" title="标题的直接链接">​</a></h4><p><strong>分离了 &quot;主逻辑做什么&quot; 和 &quot;副作用实现&quot;</strong>。</p><p>在上面的例子中，</p><ul><li><strong>主逻辑</strong> 就是 getName 函数要通过 user 对象获得并返回 name。</li><li><strong>副作用</strong> 就是当出现找不到名字时，通过 perform 拿到一个名字。</li></ul><p>所以，副作用的实现：perform 处的 <code>ask_name</code> 换来了 resume with 处的 <code>Arya Stark</code>。就是代数效应需要解决的核心问题。通过穿透调用栈的换元法实现副作用。</p><ul><li>Algebraic: 代数式，可以理解成初中数学的 <strong>换元法</strong>。</li><li>Effect：副作用。</li></ul><p>总结来说，代数效应解决了 <strong>分离了 &quot;主逻辑做什么&quot; 和 &quot;副作用实现&quot;</strong>，也就是确保主逻辑和代码不受影响的情况下，实现副作用。这需要：</p><ol><li>穿透能力：可以跨调用栈获取当前 Continuation。</li><li>恢复执行：可以替换当前 Continuation 内 Effect 的实现。</li></ol><h4 class="anchor anchorWithStickyNavbar_mojV" id="react-hooks-思想">React Hooks 思想<a class="hash-link" href="#react-hooks-思想" title="标题的直接链接">​</a></h4><p>React Hooks 的代码示例：</p><div class="codeBlockContainer_I0IT language-jsx theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-jsx codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">useLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">useEffect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;mount&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;unmount&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Foo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">useLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;Example&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text">Foo</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Bar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">useLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;Bar&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text">Bar</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>穿透能力：</p><p>useHook 实现了穿透调用栈的效果。不论 hooks 如何嵌套在作用域中，只要保证是同步调用 hooks，都能正确作用于对应组件。</p><p>每一个 Function Component 看作是 React 里的 Continuation，对 Continuation 的调度是交给 React Fiber 控制的，也就是 fiber 实现了代数效应。</p><p>恢复执行：<code>useHook(callback)</code> 中，callback 是该组件副作用的实现，hook 抽象出了 React 组件里的副作用。让组件内的主逻辑不受影响。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="问题初次渲染--更新-的区别">问题：初次渲染 / 更新 的区别<a class="hash-link" href="#问题初次渲染--更新-的区别" title="标题的直接链接">​</a></h3><h5 class="anchor anchorWithStickyNavbar_mojV" id="初次渲染">初次渲染<a class="hash-link" href="#初次渲染" title="标题的直接链接">​</a></h5><p>初次渲染时，没有两颗相同的 fiber tree。 FiberRootNode.current 会指向一个单独的 RootFiberNode 节点，其节点下没有任何子节点（即<code>current Fiber树</code>为空）。</p><p>于此同时，会在内存中构建 Work In Progress Fiber Tree。WIP 树和 CUR 树的 FiberNode 节点会通过 .alternate 相互指向：</p><p><img loading="lazy" alt="截屏2022-08-07 22.42.10" src="/assets/images/截屏2022-08-07 22.42.10-c47e67c927e51a566be8b8deb428a236.png" width="2286" height="1828" class="img_E7b_"></p><p>当 workInProgress 树构建完成后，代码中称之为 finishedTree，此时 <code>.current</code> 指针指向 finishedTree，使其变为 current fiber tree，初始化流程在协调阶段的任务完成。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="更新-update">更新 Update<a class="hash-link" href="#更新-update" title="标题的直接链接">​</a></h5><p>基于上述 tree，当用户点击一次按钮，发生页面更新时，会重新创建一颗 workInProgress tree。</p><p>通过 diff 算法，workInProgress tree 会决定是否复用 current fiber tree 同一层级的 fiber 节点数据。</p><ul><li>能被复用，本次更新中，需要做组件的 update、元素的 move 和 update 等操作；</li><li>不能复用，本次更新中，需要做组件的 mount 和 umount、元素的 insert 和 delete 等操作。</li></ul><p>在构建 workInProgress Fiber 树时,  <strong>会尝试复用 current Fiber 树中已有的 Fiber 节点内的属性</strong>。在 <strong>首屏渲染</strong> 时，只有 rootFiber 存在对应的 current fiber（即 rootFiber.alternate），无法复用。</p><ul><li><strong>处于同一层次的节点，会通过 .alternate 属性相互指向，workInProgress tree 也会优先复用 current fiber tree  处在同一层次节点的属性。</strong></li></ul><p>RootFiber 已经创建不需要复制，但其子节点由于尚不存在， 则 react 需要重新创建一份，和 current 树上的 fiber 建立起 alternate 关联，然后复制 current 树上节点的属性。渲染完毕后，workInProgresss 再次变成 current 树。</p><p><img loading="lazy" alt="截屏2022-08-07 22.49.01" src="/assets/images/截屏2022-08-07 22.49.01-a6ffd18d89304be80d7459a9d8483400.png" width="2502" height="1458" class="img_E7b_"></p><h5 class="anchor anchorWithStickyNavbar_mojV" id="再次更新">再次更新<a class="hash-link" href="#再次更新" title="标题的直接链接">​</a></h5><p>如果进行下一次更新，那么会将 current 的 alternate 作为基础（如图右树），复制一份作为 workInProgresss ，然后进行更新。</p><ul><li>所谓 “复制”，具体是指在构建 workInProgress Fiber 树时会尝试复用 current Fiber 树中已有的 Fiber 节点（.alternate 可以相互指向的，同一层次的节点）内的属性。而决定是否复用过程，就是 diff 算法。</li></ul><blockquote><p><a href="https://juejin.cn/post/7118259566868955167" target="_blank" rel="noopener noreferrer">https://juejin.cn/post/7118259566868955167</a></p><p><a href="https://github.com/lizuncong/mini-react/blob/master/docs/render/%E6%B7%B1%E5%85%A5%E6%A6%82%E8%BF%B0%20React%E5%88%9D%E6%AC%A1%E6%B8%B2%E6%9F%93%E5%8F%8A%E7%8A%B6%E6%80%81%E6%9B%B4%E6%96%B0%E4%B8%BB%E6%B5%81%E7%A8%8B.md" target="_blank" rel="noopener noreferrer">https://github.com/lizuncong/mini-react/blob/master/docs/render/%E6%B7%B1%E5%85%A5%E6%A6%82%E8%BF%B0%20React%E5%88%9D%E6%AC%A1%E6%B8%B2%E6%9F%93%E5%8F%8A%E7%8A%B6%E6%80%81%E6%9B%B4%E6%96%B0%E4%B8%BB%E6%B5%81%E7%A8%8B.md</a></p><p><a href="https://www.jianshu.com/p/6660d3ab0394" target="_blank" rel="noopener noreferrer">https://www.jianshu.com/p/6660d3ab0394</a></p></blockquote><h2 class="anchor anchorWithStickyNavbar_mojV" id="diff-相关">diff 相关<a class="hash-link" href="#diff-相关" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="问题什么是-virtual-dom">问题：什么是 virtual DOM<a class="hash-link" href="#问题什么是-virtual-dom" title="标题的直接链接">​</a></h3><p>从结构来看：虚拟 DOM 是一个 JavaScript 对象。其保存了每一个节点的 type、props、key、ref、children 等信息（具体看 fiber 结构）。</p><p>从本质来看：在 React 运行时，有两颗 virtual DOM（双缓存机制）：current fiber 树 + work in progress fiber 树。其是由于 fiber 对象所组成的。</p><p>从来源来看：虚拟 DOM 是通过 <code>React.creatElement()</code> 创建的 React Element 构建的 DOM 树。</p><p>对比真实DOM来看：virtual DOM要比真实 DOM 轻的多，少了很多用不到的默认属性和方法。</p><p>测试：</p><p>用 <code>React.createElement</code> 和 <code>document.createElement</code> 创建节点并打印：</p><div class="codeBlockContainer_I0IT language-js theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-js codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">VDOM</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> React</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createElement</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;div&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;小杜杜&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">DOM</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> document</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createElement</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;div&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">DOM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">innerHTML </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;小杜杜&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">虚拟DOM：</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">VDOM</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">真实DOM：</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">DOM</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>结果：</p><p><img loading="lazy" alt="1.png" src="/assets/images/58db2ee32bde44b3afd5e2e6af3e3647~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0-ce22e7fc31e9aefa33fb0a3d08b5ef3d.awebp" width="1166" height="482" class="img_E7b_"></p><p>虚拟 DOM 是一个 js 对象，而真实 DOM 上还挂在了许多默认属性和方法：</p><p><img loading="lazy" alt="2.png" src="/assets/images/c859397a03024903939f934907052cc2~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0-bf7010e65b450f32e10625812a9b8bb0.awebp" width="970" height="730" class="img_E7b_"></p><p>虚拟 DOM 的结构：</p><ul><li>type：实际的标签</li><li>props：标签内部的属性（除 <code>key</code> 和 <code>ref</code> ，会形成单独的 <code>key</code> 名）</li><li>children: 为节点内容</li></ul><div class="codeBlockContainer_I0IT language-jsx theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-jsx codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 转化前</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">className</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">Index</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text">Hello World 123</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">ul</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">li</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text">React</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">li</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">li</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text">Vue</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">li</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">ul</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 转化后</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;div&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">props</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Index&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">children</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token literal-property property" style="color:#36acaa">type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;div&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token literal-property property" style="color:#36acaa">children</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Hello World 123&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token literal-property property" style="color:#36acaa">type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;ul&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token literal-property property" style="color:#36acaa">children</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token literal-property property" style="color:#36acaa">type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;li&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token literal-property property" style="color:#36acaa">children</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;React&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token literal-property property" style="color:#36acaa">type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;li&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token literal-property property" style="color:#36acaa">children</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Vue&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="问题virtual-dom-的优势">问题：virtual DOM 的优势<a class="hash-link" href="#问题virtual-dom-的优势" title="标题的直接链接">​</a></h3><p>主要有三：提高效率、提升性能、增强兼容性。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="1-提高效率">1. 提高效率<a class="hash-link" href="#1-提高效率" title="标题的直接链接">​</a></h5><p>使用原生 JS 的时候，我们需要的关注点在 <strong>操作DOM</strong> 上，而 <code>React</code> 会通过 <code>virtual DOM</code> 来确保 <code>DOM</code> 的匹配。程序员只需使用 JSX 来进行声明式编程，也就是说，程序员不需关系 dom 是如何构建 / 操作 / 更新的，React 会处理一切，而只需要关系业务逻辑。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="2-提升性能">2. 提升性能<a class="hash-link" href="#2-提升性能" title="标题的直接链接">​</a></h5><p>虚拟 DOM 通过 diff 算法 + 基于双缓存的批量处理机制，优化了每次更新真实 DOM 得操作，使更新尽可能的局部、改动尽可能的少，从而减少对真实 DOM 的操作，最终提升性能。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="3-增强兼容性">3. 增强兼容性<a class="hash-link" href="#3-增强兼容性" title="标题的直接链接">​</a></h5><p>基于 virtual DOM，让 React 可以兼容各种浏览器，甚至跨平台兼容。</p><ul><li><code>React</code> 基于虚拟 DOM 实现了一套自己的事件机制，并且模拟了事件冒泡和捕获的过程，采取 <strong>事件代理</strong>、<strong>批量更新</strong> 等方法，从而磨平了各个浏览器的事件兼容性问题。</li><li>对于跨平台，<code>React</code> 和 <code>React Native</code> 都是根据 <strong>虚拟DOM</strong> 渲染出相应平台的 <code>UI</code> 层，只不过不同的平台有不同的渲染引擎而已。</li></ul><blockquote><ul><li><a href="https://juejin.cn/post/7116326409961734152" target="_blank" rel="noopener noreferrer">https://juejin.cn/post/7116326409961734152</a></li></ul></blockquote><h3 class="anchor anchorWithStickyNavbar_mojV" id="问题diff-原理">问题：diff 原理<a class="hash-link" href="#问题diff-原理" title="标题的直接链接">​</a></h3><h5 class="anchor anchorWithStickyNavbar_mojV" id="概述">概述<a class="hash-link" href="#概述" title="标题的直接链接">​</a></h5><p>从 React 的运行原理来说，React diff 是协调（<strong>reconciliation</strong>）阶段的主要任务，协调阶段也称 render 阶段。React diff 会计算出 Virtual DOM 中真正变化的部分，并构建好一颗 Work In Progress Fiber Tree 和一个 EffectList 单项符作用链表，<strong>指名哪些节点需要被更新</strong>。在渲染阶段（commit 阶段），React 会只针对 effectList 上的 fiber 节点进行 DOM 操作，而不是对整个页面（树）进行重新渲染。</p><p>传统 diff 算法使用循环递归对节点一次对比，时间复杂度为 <em>O(n^3)</em> 。React 改进后将时间复杂度降为 <em>O(n)</em>。</p><p>React diff 的策略有：</p><ol><li>Web UI 中 DOM 节点跨层级的移动操作特别少，可以忽略不计。</li><li>拥有相同类的两个组件将会生成相似的树形结构，拥有不同类的两个组件将会生成不同的树形结构。</li><li>对于同一层级的一组子节点，它们可以通过唯一 id 进行区分。</li></ol><p>基于以上三个前提策略，React 分别对 tree diff、component diff 以及 element diff 进行算法优化：</p><ul><li>tree diff、component diff、element diff</li></ul><h5 class="anchor anchorWithStickyNavbar_mojV" id="tree-diff">tree diff<a class="hash-link" href="#tree-diff" title="标题的直接链接">​</a></h5><p>基于策略一，React 对树的 diff 算法进行优化，即两棵树只会对同一层次的节点进行比较，而不考虑跨等次的节点比较。而在初次构建 fiber tree 时，基于双缓存的思想，已经构建好了 work in progress fiber tree 和 current fiber tree，且两棵树的统一层级的 fiber 节点会用 fiber.alternate 相互连接。这样对一棵树只需遍历一次，便能完成整个 DOM 树的比较。</p><ul><li><strong>跨层级移动操作的处理</strong>。React 对节点跨层级的移动操作不会 diff 比较，只有销毁旧节点和重新创建。所以通过同层遍历，React 发现同级节点已经发生变化，则会把该节点和其子节点全部销毁，然后重新创建新节点。</li></ul><p><strong>🚀 性能优化</strong>：在页面中使用 antd 的 model 模态框时，尽可能不要移除该节点，而是使用 css 隐藏掉。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="component-diff">component diff<a class="hash-link" href="#component-diff" title="标题的直接链接">​</a></h5><p>React 是基于组件构建应用的，diff 算法会在组件间也有优化，基于策略 2：</p><ul><li>如果是不同类型的组件进行 diff，和 “跨层级的移动操作” 一样，会直接销毁整个旧组件，重新创建新组件。</li><li>如果是同一类型的组件进行 diff，则 DOM 结构大致相似，会按照 tree diff 算法进行比较。</li></ul><p><strong>🚀 性能优化</strong>：如果是同一个组件，本次更新时 Virtual DOM 没有任何变化（props、state 也没有变化），那么用户可以通过性能优化告知 React ，diff 会跳过该组件的对比。</p><ul><li>对于 class 组件来说，通过 shouldComponentUpdate + shallowEqual，或直接使用 PureComponent。</li><li>对于 function 组件来说，通过 React.memo 包裹。</li></ul><blockquote><p><strong>shouldComponentUpdate</strong> </p><p>render （调合）阶段的生命周期函数。<strong>用于拦截组件渲染</strong>。</p><ol><li>父组件更新，子组件必须更新。</li></ol><p>当使用component时，父组件的state或prop更新时，无论子组件的state、prop是否更新，都会触发子组件的更新，这会形成很多没必要的render，浪费很多性能。</p><ol start="2"><li>shallowEqual 可以浅对比组件的 props 和 state 是否发生变化，从而避免无意义的 render。</li></ol><p>在 shouldComponentUpdate 中，使用 shallowEqual 比较组件的 props 和 state 是否发生变化，最后返回 true 的时候，当前组件进行 render；返回 false 则不进行 render。</p><p><strong>PureComponent / React.memo</strong></p><p>PureComponent 是针对类组件的语法糖，而 React.memo 让函数组件也可以使用，通过 React.memo 包裹函数组件，回返回一个高阶组件。</p><ul><li>另：函数组件没有 shouldComponentUpdate 周期。</li></ul><p>React 给出了官方的定义：使用 PureComponent 定义组件。可以完成上述 2 的操作。PureComponent 会在 shouldComponentUpdate 周期进行一次 shallowEqual 浅对比，从而尽可能避免 render。</p></blockquote><h5 class="anchor anchorWithStickyNavbar_mojV" id="element-diff">element diff<a class="hash-link" href="#element-diff" title="标题的直接链接">​</a></h5><p>当 fiber 节点处于同一层级时，React diff 提供了三种节点操作，分别为：<strong>INSERT_MARKUP</strong>（插入）、<strong>MOVE_EXISTING</strong>（移动）和 <strong>REMOVE_NODE</strong>（删除）。</p><ul><li><strong>插入</strong>：当前节点所在的组件，不在原来的集合中存在，即是全新的节点，执行插入操作。</li><li><strong>移动</strong>：当前节点所在的组件，存在于原来的集合中，且节点内可更新（ DOM 结构相似等递归判断），则根据 React 唯一 key 进行区分，并且执行移动操作。<ul><li>如：(A,B,C,D) → (A,D,B,C)，传统 diff 会把 B,C,D 全部销毁并重新创建，而 React 仅移动位置。</li></ul></li><li><strong>删除</strong>：当前节点的所在组件虽然存在在原来的集合中，但节点不能直接复用和更新，所以需要删除旧节点。或旧节点已经不再需要，执行销毁。</li></ul><p>节点间的移动策略，是通过节点下标 lastIndex/_mountIndex 判断，这里不细说了。</p><p>可否复用的原则：</p><ul><li>如果 key 未定义，则默认 key = null。</li><li>更新后，判断 key 是否改变：<ul><li>key 改变，不能复用。</li><li>key 没改变，继续判断 type 是否改变：<ul><li>type 改变，不能复用。</li><li>type 没变，当前节点可以复用。需要判断其 children 下的节点是否需要更新。</li></ul></li></ul></li></ul><p><strong>🚀 性能优化</strong>：</p><ol><li>对同一层级的一组子节点，可以给它们添加唯一的 key 进行区分，则 React 可以在更新前后通过 key 去判断该节点及其子节点是否发生更新，提升性能。</li><li>尽可能保持 DOM 结构稳定，减少大量移动同级节点的操作，比如从队头插入新节点 / 将对尾巴的节点移动到队头。</li></ol><blockquote><p>参考：</p><p><a href="https://juejin.cn/post/7116326409961734152" target="_blank" rel="noopener noreferrer">https://juejin.cn/post/7116326409961734152</a></p><p><a href="https://juejin.cn/post/6844903944796258317" target="_blank" rel="noopener noreferrer">https://juejin.cn/post/6844903944796258317</a></p><p><a href="https://zhuanlan.zhihu.com/p/20346379" target="_blank" rel="noopener noreferrer">https://zhuanlan.zhihu.com/p/20346379</a></p><p><a href="https://juejin.cn/book/6945998773818490884/section/6959807335720026150" target="_blank" rel="noopener noreferrer">https://juejin.cn/book/6945998773818490884/section/6959807335720026150</a></p></blockquote><h3 class="anchor anchorWithStickyNavbar_mojV" id="问题双缓存模型">问题：双缓存模型<a class="hash-link" href="#问题双缓存模型" title="标题的直接链接">​</a></h3><p><strong>产生原因</strong>：</p><ol><li>双缓存模型是一个解决图形编程中 “<strong>闪烁问题</strong>” 的方案。其基本原理是在内存中绘制当前帧，绘制完毕后直接用当前帧替换上一帧，由于省掉了帧与帧之间替换的时间因此可以有效的避免闪烁问题。 </li><li>react 15+ 的新架构，协调阶段的异步可中断。通过双缓存，当更高优任务来到，需要中断当前 diff 的树时，由于存在 current fiber tree 正常工作。所以 workInProgress fiber tree 的中断并重新构建，不会影响页面的正常展示，对用户透明。</li></ol><p><strong>实施阶段</strong>：在协调阶段，react 通过 双缓存机制输出两颗 fiber tree（work in progress fiber tree 内存中的树，current fiber tree 渲染树）。这两棵树中，同级节点通过 <code>fiber.alternate</code> 指针相互连接。current fiber tree 代表了页面正在展示的 DOM 内容，而 work in progress fiber tree 是内存中 react 正在构建的 fiber tree，是本次更新之后页面展示的 DOM 内容。</p><p><strong>实施过程</strong>：当触发更新时，react 会通过 diff 算法（官方称 Reconciliation）对比 current fiber tree，构建一颗 work in progress fiber tree。</p><ul><li>在构建 workInProgress Fiber 树时,  <strong>会尝试复用 current Fiber 树中已有的 Fiber 节点内的属性</strong>。在 <strong>首屏渲染</strong> 时，只有 rootFiber 存在对应的 current fiber（即 rootFiber.alternate）。<ul><li>更多见问题：初次渲染 / 更新的区别。</li></ul></li><li>引入协调阶段的工作内容：深度遍历优先、递阶段、归阶段、构建 effectList 副作用链。</li><li>渲染阶段：在下一次渲染的时候，直接复用缓存树做为下一次渲染树，上一次的渲染树又作为缓存树，这样可以防止只用一颗树更新状态的丢失的情况，又加快了 DOM 节点的替换与更新。</li></ul><p>总结：一个元素最多存在两个版本的 fiber 节点，一个 current 版本和当前浏览器页面对应，一个 WorkInProgress 版本，WorkInProgress 版本是正在协调的节点。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="fiber">Fiber<a class="hash-link" href="#fiber" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="问题1-为什么要引入-fiber-架构">问题1 为什么要引入 Fiber 架构？<a class="hash-link" href="#问题1-为什么要引入-fiber-架构" title="标题的直接链接">​</a></h3><p>fiber 是针对单进程的一种调度策略。</p><p>在操作系统中，介绍过常见的单处理进程调度策略：</p><ul><li>先到先得(First-Come-First-Served, FCFS)<ul><li>优点：简单，易实现</li><li>缺点：对短进程不利、对 I/O 密集型进程不理。</li></ul></li><li>轮转<ul><li>抢占策略。确定合理的时间片长度，公平地给每一个进程一定的执行时间，当时间消耗完毕或阻塞，操作系统就会调度其他进程，将执行权抢占过来。</li></ul></li><li>最短进程优先(Shortest Process Next, SPN)<ul><li>缺点：对长进程不利，会饥饿。</li></ul></li><li>最短剩余时间(Shortest Remaining Time, SRT)<ul><li>根据剩余时间的长短，优先执行可最快完成的进程。</li><li>缺点：对长进程不利，会饥饿。</li></ul></li><li>最高响应比优先(HRRN)<ul><li>响应比 = （等待执行时间 + 进程执行时间） / 进程执行时间</li><li>解决长进程饥饿问题，引入了等待执行时间，让等待时间较长的可以尽可能优先执行。</li></ul></li><li>反馈法，多队列<ul><li>每个进程一开始都有相同的优先级，每次被抢占(需要配合其他抢占策略使用，如轮转)，优先级就会降低一级。因此通常它会根据优先级划分多个队列</li></ul></li></ul><p>浏览器中，JavaScript 的执行也是单线程的。Javascript 引擎和页面渲染引擎在同一个<code>渲染线程</code>，GUI 渲染和 Javascript执行 两者是互斥的。如果让 js执行长期占据渲染进程，浏览器就会呈现 “卡死” 状态，页面无法刷新。</p><p>对于’前端框架‘来说，解决这种问题有三个方向:</p><ul><li>1️⃣ 优化每个任务，让它有多快就多快。挤压CPU运算量</li><li>2️⃣ 快速响应用户，让用户觉得够快，不能阻塞用户的交互</li><li>3️⃣ 尝试 Worker 多线程</li></ul><p>Vue 从1⃣️角度入手，通过模版 + 响应式机制，提升任务运行速度。</p><p>React 从2⃣️角度入手，通过 fiber 架构，把任务切分，提升浏览器响应速度。</p><p>具体为：</p><p>React 有三大模块：</p><ul><li><p>Scheduler 调度器：调度更新.</p></li><li><p>Reconcoler 协调器：决定需要更新什么组件.</p></li><li><p>Renderer 渲染器：将组件更新到视图中.</p></li></ul><p>其中，<code>Reconcilation</code> 协调阶段是 CPU 密集型操作，fiber 把该环节切分，使 <code>Reconcilation</code> 过程变成可中断，适时的让出 CPU 执行权（16.6ms），好处：</p><ul><li>不再一次性操作大量 DOM 节点，而是分批延时对 DOM 进行操作。提升了浏览器的响应速度。</li><li>给浏览器一点喘息的机会，他会对代码进行编译优化（JIT）及进行热代码优化，或者对reflow进行修正</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="问题2-什么是-fiber">问题2 什么是 Fiber<a class="hash-link" href="#问题2-什么是-fiber" title="标题的直接链接">​</a></h3><p>是一种流程控制机制：</p><ul><li>一个动态执行单元</li><li>一种静态数据结构</li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="1-流程控制机制">1 流程控制机制<a class="hash-link" href="#1-流程控制机制" title="标题的直接链接">​</a></h4><p>Fiber 也称协程、或者纤程。 是一种控制流程的让出机制。协程和线程并不一样，协程本身是没有并发或者并行能力的（需要配合线程）。</p><p>Fiber 实现了代数效应（看代数效应的例子），可以近似的理解为是 async/await + try/catch 的结合。</p><ul><li>普通函数的执行过程中无法被中断和恢复：async/await 实现了中断和恢复。</li><li>但因此导致了副作用：async具有传染性，需要全部的函数都为 async。如果可以类似 try/catch 的效果，让副作用和主逻辑分离，则代码逻辑更清晰。</li></ul><p><strong>React 渲染的过程可以被中断，可以将控制权交回浏览器，让位给高优先级的任务，浏览器空闲后再恢复渲染</strong></p><p>合作式调度 Cooperative Scheduling：浏览器中没有抢占机制，无法中断正在执行的任务，所以 React 需要具备让出机制，主动让出控制权。</p><p>这是一种给予信任的契约合作机制：React 会根据自己的任务量，向浏览器申请适量的时间片。而浏览器会先执行更高优先级的任务，再把剩余时间分给 React，React 也会在规定的时间内完成任务执行，归还控制权。</p><p><img loading="lazy" alt="img" src="/assets/images/16deecc37fdd60d7~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0-5175c162183af87a410334df21557a68.awebp" width="1268" height="700" class="img_E7b_"></p><p>那么，如何确定剩余时间呢？或者哪些任务是更高优先级的呢？</p><p>在一帧（16.6 ms）中，浏览器会执行以下任务：</p><ul><li>处理用户输入事件</li><li>Javascript执行</li><li>requestAnimation 调用</li><li>布局 Layout</li><li>绘制 Paint</li></ul><p>如果在执行完这些必须任务后，还有剩余的时间，就可给 React 去使用：</p><p>浏览器调用 <code>requestIdleCallback</code> 的回调：</p><p><img loading="lazy" alt="img" src="/assets/images/16deecc43c710e16~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0-af1ecf1eda7814df686431778089fc93.awebp" width="737" height="139" class="img_E7b_"></p><p>为了避免剩余时间不足，任务被饿死，React 定义了一个超时时间。如果任务等待时间到达超时时间后，就会提升优先级，立即执行。</p><ul><li><code>Immediate</code>(-1) - 这个优先级的任务会同步执行, 或者说要马上执行且不能中断</li><li><code>UserBlocking</code>(250ms) 这些任务一般是用户交互的结果, 需要即时得到反馈</li><li><code>Normal</code> (5s) 应对哪些不需要立即感受到的任务，例如网络请求</li><li><code>Low</code> (10s) 这些任务可以放后，但是最终应该得到执行. 例如分析通知</li><li><code>Idle</code> (没有超时时间) 一些没有必要做的任务 (e.g. 比如隐藏的内容), 可能会被饿死</li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="2-执行单元">2 执行单元<a class="hash-link" href="#2-执行单元" title="标题的直接链接">​</a></h4><p>FIber 另一个概念是一种数据结构，或者说执行单元。</p><ul><li>将它视作一个执行单元，每次执行完一个 &#x27;执行单元&#x27;，React 就会检查现在还剩多少时间，如果没有时间就将控制权让出去。</li></ul><p>流程：</p><ul><li><p>假设用户调用 <code>setState</code> 更新组件, 这个待更新的任务会先放入队列中，然后通过 <code>requestIdleCallback</code> 请求浏览器调度。</p></li><li><p>浏览器有空闲时间，或者任务超时，就会调用 <code>performWork</code> 来循环遍历，并执行队列中的任务。</p></li></ul><p><code>workLoop</code> ：它会从更新队列 (updateQueue) 中弹出更新任务来执行，每执行完一个 ‘<code>执行单元</code>‘ ，就检查一下剩余时间是否充足，如果充足就进行执行下一个 <code>执行单元</code>，反之则停止执行，保存现场，等下一次有执行权时恢复。</p><p><img loading="lazy" alt="img" src="/assets/images/16deed1711f281b3~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0-d0240fc89f86c4d1a73102992edf1a0f.awebp" width="1056" height="1089" class="img_E7b_"></p><h4 class="anchor anchorWithStickyNavbar_mojV" id="3-一种数据结构">3 一种数据结构<a class="hash-link" href="#3-一种数据结构" title="标题的直接链接">​</a></h4><p>查看问题3.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="问题3-fiber-的结构">问题3 Fiber 的结构<a class="hash-link" href="#问题3-fiber-的结构" title="标题的直接链接">​</a></h3><p>在 React 16以前，Reconcilation 是同步的、递归执行的。也就是说，Dom 的构建基于 <strong>函数调用栈</strong> 的Reconcilation算法，因此通常也称它为<code>Stack Reconcilation</code>。</p><p>但基于调用栈的方式不能随意中断 / 恢复现场，也不利于异步处理的代数效应实现。 如果要恢复递归现场，可能需要从头开始，恢复到之前的调用栈。</p><p>所以，React 16 通过模拟函数调用栈，将递归转化成迭代，使用 <strong>链表</strong> 构建。</p><p> 每个 VirtualDOM 节点，都使用一个 <code>Fiber</code> 表示：</p><div class="codeBlockContainer_I0IT language-js theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-js codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">Fiber</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">   * ⚛️ 节点的类型信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">   */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 标记 Fiber 类型, 例如函数组件、类组件、宿主组件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">tag</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> WorkTag</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 节点元素类型, 是具体的类组件、函数组件、宿主组件(字符串)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> any</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">   * ⚛️ 结构信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">   */</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 指向父节点，或者render该节点的组件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Fiber </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 指向第一个子节点</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">child</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Fiber </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 指向下一个兄弟节点</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">sibling</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Fiber </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">   * ⚛️ 节点状态 state</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">   */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 节点实例(状态)：</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">//        对于宿主组件，这里保存宿主组件的实例, 例如DOM节点。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">//        对于类组件来说，这里保存类组件的实例</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">//        对于函数组件说，这里为空，因为函数组件没有实例</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">stateNode</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> any</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 新的、待处理的props</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">pendingProps</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> any</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 上一次渲染的props</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">memoizedProps</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> any</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// The props used to create the output.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 上一次渲染的组件状态</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">memoizedState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> any</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">   * ⚛️ 副作用</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">   */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 当前节点的副作用类型，例如节点更新、删除、移动</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">effectTag</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> SideEffectTag</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 和节点关系一样，React 同样使用链表来将所有有副作用的Fiber连接起来</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">nextEffect</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Fiber </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">   * ⚛️ 替身</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">   * 指向旧树中的节点，如果节点不发生任何改变，就会直接使用旧节点，而无需重新创建</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">   */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">alternate</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Fiber </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Fiber 包含的属性可以划分为 5 个部分:</p><ul><li><strong>🆕 结构信息</strong><ul><li>Fiber 使用链表的形式来表示节点在树中的定位，将 virtualDom 构建起来。</li></ul></li><li><strong>节点类型信息</strong><ul><li>tag 表示节点的分类、type 保存具体的类型值，如div、Component。</li></ul></li><li><strong>节点的状态</strong><ul><li>节点的组件实例、props、state 等，它们将影响组件的输出。</li></ul></li><li><strong>🆕 副作用</strong><ul><li>在 Reconciliation 过程中发现的 &#x27;副作用&#x27;(<strong>变更需求</strong>) 就保存在节点的 <code>effectTag</code> 中(想象为打上一个标记)。</li><li>使用链表结构，将本次渲染的所有节点副作用都收集起来。在遍历过程中 React 会将所有有 ‘副作用’ 的节点都通过 <code>nextEffect</code> 连接起来。</li></ul></li><li><strong>🆕 替身</strong> <ul><li>React 在 Reconciliation 过程中会构建一颗新的 virtualDOm (官方称为<strong>workInProgress tree</strong>，<strong>WIP树</strong>)。是一颗表示当前工作进度的树。</li><li>还有一颗表示已渲染界面的<strong>旧树（current tree）</strong>，这棵树代表了已经渲染的并正在显示的页面。</li><li>React就是一边和旧树比对，一边构建WIP树的。 alternate 指向旧树的同等节点。</li></ul></li></ul><p><img loading="lazy" alt="img" src="/assets/images/16deecce3162b355~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0-c4218249f9dea90c20684edbe11ebc2c.awebp" width="915" height="690" class="img_E7b_"></p><p>上图是 Reconciliation 完成后的状态，左边是旧树，右边是WIP树。对于需要变更的节点，都打上了&#x27;标签&#x27;。 在提交阶段，React 就会将这些打上标签的节点应用变更。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="其他">其他<a class="hash-link" href="#其他" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="问题jsx-element-fiber-dom-的关系">问题：JSX, element, fiber, dom 的关系<a class="hash-link" href="#问题jsx-element-fiber-dom-的关系" title="标题的直接链接">​</a></h3><p>首先必须需要弄明白 React.element ，fiber 和真实 DOM 三者是什么关系。</p><ul><li>jsx 语法，是创建 <code>React.creatElement()</code> 的语法糖。<ul><li>jsx 语法最终会被 babel 转译为各种 <code>React.creatElement()</code>。最终，这些代码会被执行，从而创建 React element 对象，</li></ul></li><li>React element 是 js 对象，上面保存了 props，children 等信息。</li><li>DOM 是元素在浏览器上给用户直观的表象。</li><li>fiber 可以说是是 element 和真实 DOM 之间的交流枢纽站。<ul><li>每一个类型 element 都会有一个与之对应的 fiber 类型，element 变化引起更新流程都是通过 fiber 层面做一次调和改变，fiber 通过链表形式，构建出一颗 virtualDOM 树。最终会在渲染阶段，转化为真实 DOM 并渲染在页面上。</li></ul></li></ul><p><img loading="lazy" alt="2.jpg" src="/assets/images/0a90368f24f0477aaf0d446a8f6736db~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0-075ad7c9c4b513ce7afa653459291b2b.awebp" width="1590" height="360" class="img_E7b_"></p><p>JSX 最终会转变为 <code>React.createElement()</code> 并执行，从而创建 React element，最终合并到 fiber 节点上。而 fiber 节点之间通过链表连接，最终构造为一颗 virtualDOM 树。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="问题fiber-更新机制">问题：Fiber 更新机制<a class="hash-link" href="#问题fiber-更新机制" title="标题的直接链接">​</a></h3><p>初始化更新：</p><p><strong>第一步：创建 fiberRoot 和 rootFiber</strong></p><ul><li><code>fiberRoot</code>：首次构建应用， 创建唯一的 fiberRoot 节点，是整个 React 应用的根基。</li><li><code>rootFiber</code>： 通过 <code>ReactDOM.render()</code> 渲染出来的。一个 React 应用可以有多 ReactDOM.render 创建的 rootFiber ，但是只能有一个 fiberRoot（应用根节点）。</li></ul><div class="codeBlockContainer_I0IT language-js theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-js codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// rootFiber</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ReactDOM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">render</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Index</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> document</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getElementById</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;app&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>第一次挂载的过程中，会将 fiberRoot 和 rootFiber 建立起关联。</p><ul><li><code>fiberRoot.current = rootFiber;</code></li></ul><p><img loading="lazy" alt="3.jpg" src="data:;base64,UklGRk4kAABXRUJQVlA4WAoAAAAgAAAA0QIAywEASUNDUOAPAAAAAA/gYXBwbAIQAABtbnRyUkdCIFhZWiAH5QACAA8AAQAYADBhY3NwQVBQTAAAAABBUFBMAAAAAAAAAAAAAAAAAAAAAAAA9tYAAQAAAADTLWFwcGwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABJkZXNjAAABXAAAAGJkc2NtAAABwAAABIJjcHJ0AAAGRAAAACN3dHB0AAAGaAAAABRyWFlaAAAGfAAAABRnWFlaAAAGkAAAABRiWFlaAAAGpAAAABRyVFJDAAAGuAAACAxhYXJnAAAOxAAAACB2Y2d0AAAO5AAAADBuZGluAAAPFAAAAD5jaGFkAAAPVAAAACxtbW9kAAAPgAAAACh2Y2dwAAAPqAAAADhiVFJDAAAGuAAACAxnVFJDAAAGuAAACAxhYWJnAAAOxAAAACBhYWdnAAAOxAAAACBkZXNjAAAAAAAAAAhEaXNwbGF5AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAbWx1YwAAAAAAAAAmAAAADGhySFIAAAAUAAAB2GtvS1IAAAAMAAAB7G5iTk8AAAASAAAB+GlkAAAAAAASAAACCmh1SFUAAAAUAAACHGNzQ1oAAAAWAAACMGRhREsAAAAcAAACRm5sTkwAAAAWAAACYmZpRkkAAAAQAAACeGl0SVQAAAAUAAACiGVzRVMAAAASAAACnHJvUk8AAAASAAACnGZyQ0EAAAAWAAACrmFyAAAAAAAUAAACxHVrVUEAAAAcAAAC2GhlSUwAAAAWAAAC9HpoVFcAAAAKAAADCnZpVk4AAAAOAAADFHNrU0sAAAAWAAADInpoQ04AAAAKAAADCnJ1UlUAAAAkAAADOGVuR0IAAAAUAAADXGZyRlIAAAAWAAADcG1zAAAAAAASAAADhmhpSU4AAAASAAADmHRoVEgAAAAMAAADqmNhRVMAAAAYAAADtmVuQVUAAAAUAAADXGVzWEwAAAASAAACnGRlREUAAAAQAAADzmVuVVMAAAASAAAD3nB0QlIAAAAYAAAD8HBsUEwAAAASAAAECGVsR1IAAAAiAAAEGnN2U0UAAAAQAAAEPHRyVFIAAAAUAAAETHB0UFQAAAAWAAAEYGphSlAAAAAMAAAEdgBMAEMARAAgAHUAIABiAG8AagBpzuy37AAgAEwAQwBEAEYAYQByAGcAZQAtAEwAQwBEAEwAQwBEACAAVwBhAHIAbgBhAFMAegDtAG4AZQBzACAATABDAEQAQgBhAHIAZQB2AG4A/QAgAEwAQwBEAEwAQwBEAC0AZgBhAHIAdgBlAHMAawDmAHIAbQBLAGwAZQB1AHIAZQBuAC0ATABDAEQAVgDkAHIAaQAtAEwAQwBEAEwAQwBEACAAYwBvAGwAbwByAGkATABDAEQAIABjAG8AbABvAHIAQQBDAEwAIABjAG8AdQBsAGUAdQByIA8ATABDAEQAIAZFBkQGSAZGBikEGgQ+BDsETAQ+BEAEPgQyBDgEOQAgAEwAQwBEIA8ATABDAEQAIAXmBdEF4gXVBeAF2V9pgnIATABDAEQATABDAEQAIABNAOAAdQBGAGEAcgBlAGIAbgD9ACAATABDAEQEJgQyBDUEQgQ9BD4EOQAgBBYEGgAtBDQEOARBBD8EOwQ1BDkAQwBvAGwAbwB1AHIAIABMAEMARABMAEMARAAgAGMAbwB1AGwAZQB1AHIAVwBhAHIAbgBhACAATABDAEQJMAkCCRcJQAkoACAATABDAEQATABDAEQAIA4qDjUATABDAEQAIABlAG4AIABjAG8AbABvAHIARgBhAHIAYgAtAEwAQwBEAEMAbwBsAG8AcgAgAEwAQwBEAEwAQwBEACAAQwBvAGwAbwByAGkAZABvAEsAbwBsAG8AcgAgAEwAQwBEA4gDswPHA8EDyQO8A7cAIAO/A7gDzAO9A7cAIABMAEMARABGAOQAcgBnAC0ATABDAEQAUgBlAG4AawBsAGkAIABMAEMARABMAEMARAAgAGEAIABDAG8AcgBlAHMwqzDpMPwATABDAEQAAHRleHQAAAAAQ29weXJpZ2h0IEFwcGxlIEluYy4sIDIwMjEAAFhZWiAAAAAAAADzFgABAAAAARbKWFlaIAAAAAAAAIMKAAA9bv///7xYWVogAAAAAAAAS/oAALQhAAAK4FhZWiAAAAAAAAAn0gAADnAAAMiRY3VydgAAAAAAAAQAAAAABQAKAA8AFAAZAB4AIwAoAC0AMgA2ADsAQABFAEoATwBUAFkAXgBjAGgAbQByAHcAfACBAIYAiwCQAJUAmgCfAKMAqACtALIAtwC8AMEAxgDLANAA1QDbAOAA5QDrAPAA9gD7AQEBBwENARMBGQEfASUBKwEyATgBPgFFAUwBUgFZAWABZwFuAXUBfAGDAYsBkgGaAaEBqQGxAbkBwQHJAdEB2QHhAekB8gH6AgMCDAIUAh0CJgIvAjgCQQJLAlQCXQJnAnECegKEAo4CmAKiAqwCtgLBAssC1QLgAusC9QMAAwsDFgMhAy0DOANDA08DWgNmA3IDfgOKA5YDogOuA7oDxwPTA+AD7AP5BAYEEwQgBC0EOwRIBFUEYwRxBH4EjASaBKgEtgTEBNME4QTwBP4FDQUcBSsFOgVJBVgFZwV3BYYFlgWmBbUFxQXVBeUF9gYGBhYGJwY3BkgGWQZqBnsGjAadBq8GwAbRBuMG9QcHBxkHKwc9B08HYQd0B4YHmQesB78H0gflB/gICwgfCDIIRghaCG4IggiWCKoIvgjSCOcI+wkQCSUJOglPCWQJeQmPCaQJugnPCeUJ+woRCicKPQpUCmoKgQqYCq4KxQrcCvMLCwsiCzkLUQtpC4ALmAuwC8gL4Qv5DBIMKgxDDFwMdQyODKcMwAzZDPMNDQ0mDUANWg10DY4NqQ3DDd4N+A4TDi4OSQ5kDn8Omw62DtIO7g8JDyUPQQ9eD3oPlg+zD88P7BAJECYQQxBhEH4QmxC5ENcQ9RETETERTxFtEYwRqhHJEegSBxImEkUSZBKEEqMSwxLjEwMTIxNDE2MTgxOkE8UT5RQGFCcUSRRqFIsUrRTOFPAVEhU0FVYVeBWbFb0V4BYDFiYWSRZsFo8WshbWFvoXHRdBF2UXiReuF9IX9xgbGEAYZRiKGK8Y1Rj6GSAZRRlrGZEZtxndGgQaKhpRGncanhrFGuwbFBs7G2MbihuyG9ocAhwqHFIcexyjHMwc9R0eHUcdcB2ZHcMd7B4WHkAeah6UHr4e6R8THz4faR+UH78f6iAVIEEgbCCYIMQg8CEcIUghdSGhIc4h+yInIlUigiKvIt0jCiM4I2YjlCPCI/AkHyRNJHwkqyTaJQklOCVoJZclxyX3JicmVyaHJrcm6CcYJ0kneierJ9woDSg/KHEooijUKQYpOClrKZ0p0CoCKjUqaCqbKs8rAis2K2krnSvRLAUsOSxuLKIs1y0MLUEtdi2rLeEuFi5MLoIuty7uLyQvWi+RL8cv/jA1MGwwpDDbMRIxSjGCMbox8jIqMmMymzLUMw0zRjN/M7gz8TQrNGU0njTYNRM1TTWHNcI1/TY3NnI2rjbpNyQ3YDecN9c4FDhQOIw4yDkFOUI5fzm8Ofk6Njp0OrI67zstO2s7qjvoPCc8ZTykPOM9Ij1hPaE94D4gPmA+oD7gPyE/YT+iP+JAI0BkQKZA50EpQWpBrEHuQjBCckK1QvdDOkN9Q8BEA0RHRIpEzkUSRVVFmkXeRiJGZ0arRvBHNUd7R8BIBUhLSJFI10kdSWNJqUnwSjdKfUrESwxLU0uaS+JMKkxyTLpNAk1KTZNN3E4lTm5Ot08AT0lPk0/dUCdQcVC7UQZRUFGbUeZSMVJ8UsdTE1NfU6pT9lRCVI9U21UoVXVVwlYPVlxWqVb3V0RXklfgWC9YfVjLWRpZaVm4WgdaVlqmWvVbRVuVW+VcNVyGXNZdJ114XcleGl5sXr1fD19hX7NgBWBXYKpg/GFPYaJh9WJJYpxi8GNDY5dj62RAZJRk6WU9ZZJl52Y9ZpJm6Gc9Z5Nn6Wg/aJZo7GlDaZpp8WpIap9q92tPa6dr/2xXbK9tCG1gbbluEm5rbsRvHm94b9FwK3CGcOBxOnGVcfByS3KmcwFzXXO4dBR0cHTMdSh1hXXhdj52m3b4d1Z3s3gReG54zHkqeYl553pGeqV7BHtje8J8IXyBfOF9QX2hfgF+Yn7CfyN/hH/lgEeAqIEKgWuBzYIwgpKC9INXg7qEHYSAhOOFR4Wrhg6GcobXhzuHn4gEiGmIzokziZmJ/opkisqLMIuWi/yMY4zKjTGNmI3/jmaOzo82j56QBpBukNaRP5GokhGSepLjk02TtpQglIqU9JVflcmWNJaflwqXdZfgmEyYuJkkmZCZ/JpomtWbQpuvnByciZz3nWSd0p5Anq6fHZ+Ln/qgaaDYoUehtqImopajBqN2o+akVqTHpTilqaYapoum/adup+CoUqjEqTepqaocqo+rAqt1q+msXKzQrUStuK4trqGvFq+LsACwdbDqsWCx1rJLssKzOLOutCW0nLUTtYq2AbZ5tvC3aLfguFm40blKucK6O7q1uy67p7whvJu9Fb2Pvgq+hL7/v3q/9cBwwOzBZ8Hjwl/C28NYw9TEUcTOxUvFyMZGxsPHQce/yD3IvMk6ybnKOMq3yzbLtsw1zLXNNc21zjbOts83z7jQOdC60TzRvtI/0sHTRNPG1EnUy9VO1dHWVdbY11zX4Nhk2OjZbNnx2nba+9uA3AXcit0Q3ZbeHN6i3ynfr+A24L3hROHM4lPi2+Nj4+vkc+T85YTmDeaW5x/nqegy6LzpRunQ6lvq5etw6/vshu0R7ZzuKO6070DvzPBY8OXxcvH/8ozzGfOn9DT0wvVQ9d72bfb794r4Gfio+Tj5x/pX+uf7d/wH/Jj9Kf26/kv+3P9t//9wYXJhAAAAAAADAAAAAmZmAADypwAADVkAABPQAAAKW3ZjZ3QAAAAAAAAAAQABAAAAAAAAAAEAAAABAAAAAAAAAAEAAAABAAAAAAAAAAEAAG5kaW4AAAAAAAAANgAArgAAAFIAAABDwAAAsMAAACaAAAANgAAAUAAAAFRAAAIzMwACMzMAAjMzAAAAAAAAAABzZjMyAAAAAAABDHIAAAX4///zHQAAB7oAAP1y///7nf///aQAAAPZAADAcW1tb2QAAAAAAAAGEAAAoEQAAAAA2ZNdgAAAAAAAAAAAAAAAAAAAAAB2Y2dwAAAAAAADAAAAAmZmAAMAAAACZmYAAwAAAAJmZgAAAAIzMzQAAAAAAjMzNAAAAAACMzM0AFZQOCBIFAAAEJ4AnQEq0gLMAT6RRp5MpaOjIiDyOSCwEglpbv//vfd25K2ElDfZzKoPrH+L75P8D/j/EnxceZPaPkidXeZv8w+2H578xfjx/I/6HwZ+UGoX7C/zP228TrsvmC+o/1T/f/3fxlP9L0L+uvsA/z/+tf9X2E78P8D/zvYG/of+N/Zb2M//L/W+jP6v/9nuHfsF/0Ox6Gw0z4ZfIKnOhpnwy+QVOdDTPhl8gqc6GmfDL5BU50NM+GXyCpzoaZ8MvkFTnQ0z4ZfIKnOhpnwy+QVOdDTPhl8gqc6GmfDL5BU50NM+GXyCpzoaZ8MvkFTnQ0z4YzWhl/z17x+iEYR150l8IKez9RmEVuV/jq65GYRW5oFr0ZlH50NM+GXyCpzoaB/RAhsgPUvkFTnQ0z2qG6rN98S+QVOdDTPhl8bsEE2mBfIKnOhpnwy+N0s0UvkFTnQ0z4ZfG5IJK2a7dywQN34/CTeT+2pjv9aObDWKNN/7RMiiUwozZqyz4L3F7Koh/B12ssVPFjB86Gfcgog0z4ZfIKnOhpnE5H8LJfG2IJl3xqwQki63s7vhh4v0s8gWYP92MqNPR33lsMTcMt/fFdL5BU50NM+GXyBDmUvL5o5uGXyCpzoaXx7xxl8gqc6GmfDL43YRWC7TnQ0z4ZfIKnCtTl3JzSBm4ZfIKnOhpnwxqkLy2lZ5U7Yg8oCVOLurrPeylYRlOPcfAQnzUDVlldgdN8uu2CE7DSu9t8PUvkFTnQ0z4ZfIKnNljLnr8MvkFTnQ0z4ZfIKnOhpnwy+QVOEqeCBMLwTmr86GmfDL5BU50NM+GXyCpwiQ0LPEK+G70HKTi7dw1rtgGBUcG+1RgDSjmpOTTa/FyU0M/cpOdDTPhl8gqc6GmfDL5AdNXhuQArexEpGQPmA8Ac8Iq24C03sRgFF1rZ4U3YiVkUxfKLbDTPhl8gqc6GmfDL5BU50NM+GW/Iwd4pi3yncB6l8gqc6GmfDL5BU50NM+GXumU/oL/jH1iiZY6GmfDL5BU50NM+GXyCpxUKsX+1lZMZ0zVbn37MFQZD1KaObhl8gqc6GmfDL5Akb8ZBznb9SEDMJiYihBXZluSDrjQpImQjMKHLgvdQKiDVqIBTwFAl6Qm35ri1XDTPhl8gqcK6Tzqqz+GXyCpzoaZ8MaaFP3FquGmfDL5BU5s/xU4B5HhKWWTwlE01JR3vqZ8Mvjckg3yCpzoaZ8MvkFEFkDcYDmXXR1Y7QojwDk+HW2OCbRl6DUN0mbZ22Tjcjx+2YQFmgw60FEUTBBib773Huins8LzaajnKB7nFJYOPi1XClZmUz4ZfIKnOhpnwiLU/Z64tVxjCvqXyCiuWmfDL5BU50NM+ERahsQfwD1L5BU50NM4Q66TpruA9S+QVOdDTOLx3YopvuNJFWgdTaXfHZplLzA7WIOqeXEOEyYrZGR5KwfC9BMDtYg61RVRXnHdjQWfDL5BU50NM+GXxwwcj2lEyEZhQgrsy3JA7eXrGFRbdg5HuPQ0z4Ze3NIVr5DytMwjLfkangoeBcVF7dyoc8Vb4cEwbyMniGXf8MvkFTnQ0z4ZfIKnOhpntAxq7Cn2a46ry6TgzQQdQF5YF+Eg4modHiCtcHercdj7nmC70B0gIBIXE8tO9ALQAtH1BUxEc8yYv9IEOcWL2wRCQ1bXcB6l8gqc6GmfDL5BU50NM+GXyCpIAD+/0vAAAAAAAA1MkzTL61EbhHwAQwfHHHiD8JBDHKrr8kF8UjA0wS+8oLfoEHgFl4knbJ1cEE48RlzXGh1L4EfWgUJwx5BFh6JLyKySp2okj0U63q1j097jwFFXs5Y4U28fdX4MHfSRYUFks4TdFio/xiBVjh81QmWnHikBpHiI4hABZQscJcAZ6j6uBgGMZEHM8JHhGU6XescGP3W3pAHrfgk8hc3lz9uWmYU6NjYw7TXic52qhHTwx/deF9nS5tyEppd/huTK4gYVhiIwo6MExdMKshRdrC/yEyNglrGDiTy9lLLwrq/pjO6C7PB+IdNEYaCKdX7yOXL8377qY3iOfs1eLPKScgkwTMFprcTH2XcidCYGzY7QPX7POAC8RKNKe+34eEMLy+sPgJLN3WJj5MhjgX0NKGOm+/wgbPKR/VAGU346xxUt4Y5acHOZCEDu4PndYrzFrzwrcClenj1NDLuO9cCNXNbZLHeZrTG72L0vugJ35C43NxWhn9uiUIP5gdFwZtgPZI2t2jNpZ47lm0h5NkiIWqx5w3KAw3rIt7vLwNVPJt/V+fTqljCGRNfkHADD33L/EFTjWxypEP4aupUdo11Ex4rotmUlz/fEOmrc69qGEVFZEPPIDltdBj0Adu0ahwPj88/suWXcK1hQII7H3ah3dyz/O6+tPnZyw87N6IxI6cPSn+Kd8Ljgz64zRnbbDBKumwDfL96jin3P9uF/NEIYlV4bVQnpe0qppiFr2cbOGSSy5oPsTYFn3mwtfQulFmaO14o+uMDG/GUVwGbvtUa4XNnf/EiQgf6r9rjirKj0RSlL/9c7KVR+x1v6B/tj/Ou/HbS94e/XuzQDnvZsdhEsnQtVra5EBWITc2KBjviiGDJadPYBEWTbmMxRnWbMqB2C+CMuJArZW8EX9h4RsrPFUskE0JDckLkMPz17SG65TSwg12qJ/Co9E3ebV2a/AtXU5HTUM9vXUiXINZR/LzdLKOzv1dxlcPrV9vefOqPgUUP/mon6bn8EYtY2sxpG+dnWWFO16sfn7e196ZYFSVnJigvIxLWck6oZaomKvXgsn+t04cSf4LaUb0JGTCOjC0aB51+X/nHagAIJV6k46ILcnkGInlDYUS00RFdZtYNGMoFM+8ES/Xhy9GThDamn0Dj8b6XcdbovcS0K3Ct8gtkmvhsnLHfbIrJ5viEPExyj/pWi7hLWqjE98A6cZwVapl0hLZjZ9sYeRhLBBpAlJbipC7+dvIFDROiLGvNpjQ6zg+Mkfct9mAPnpHtH6SnhPg4sSmxzSgs6XHwZ9W+LohS7dHcjmoSrm5CjHlUS8Y7QC5mYIGtuVhoJ9eq/QyWxAflNbbYTssXxAxJ+tGLzQnsLZQ//VYCkN7hJyrZHx1EB4U2iwH+WDKgC19y9icl6UuyFIfgiQ8EH6m/OOG3qzHH4Y8f4XwcrrGhkeeOq1ggDj9jnqdCwiPPo7bszPxu2BeavTyWhBf9+qrKz7/KPuVZTWtXOD5LSQ/y2S4+ifZJoOCQnbA9vuWzHJu72l0DKumxoODMRPdEDswIL7OpYE1PV4E1GnDzro9039uuF95o8X2r/lXavMNYFufmjkisJN1TPU9aJcxHD5FdzgYwa+VpHZ8Q/8P6YIuLza+6+7HoQrFYSfyKD1S22BFJNcN2NXCebEFy5/0e+Eql0dzMwWg8C4F8QcnzLfOkcNwGhOGJi+btTa4Jz7kxuVDswNRfZItG/IO7ZgHDhiQbl5zDrM+CeUKiwjDug5mJSYINe5CG9cDyzQRQpAXzZ9I/W8Aok+SbK1qGXC6U8YUaVE+FWq0f89xut58slOt+KPWlC1LHzkgLPJn+/unhznPG7aCI7l6zcYOjD8I4nX7UFQq/OQuT5thFvdc5o2NsWX2HWDyY4qMLtH+A4eHS7eKGr5yE0mh5dcSfUNnZYDcMvVvD62MOsldlrDH/h8XIXcGpufCvKgoSEMnYtaa5eeGOUAFff8DT3M39wch+Ax7m2pP23s4oEVKVlGldGz82cGdI1/qFhMpfW72MLHtnBL3mR48bTUpXLv8ObVKLwYK/9CUlUYWfXyNkaTmDbT99uZN/AG8HiwCobUi5aK4g11f3kq3XLUIAATp8lfmw99lfHsdAnzfzXxSuO+l+KHNkht+7KUC3a7ANjs+BK9XJHnPUcLtPnAO0UpijIzEDDJiIJp86JTGUnDHZZ/HD5vgcz0uH647aKRGNUVgMfinlXTNYZrUfyXhZfci42c/sYbNAll49jEef9w1bZfVbS2BbJljkOIp9zkPkmFQOtPyHhXV2VxJctL4igf1RhV3cIsQ3gAeXwnRkn/flLGC9ZpkNHey4E30agGgZrQg7xW5psJ5w4kPiw+g3/+F7tDnABPWAQCZP+bU13/wJgIVjAPoWe9BA66eBtnmOCQhQciL/Qci27nGre5RIj9IWN92asrggApXtGHZZqbHOcS5f6JqxLdS26gg58oORWSACXg+Bw0CVmTdgQkedECADkdp5HQO1wCS/ivU3ue3rfoXJ8yUIjpsvqpoVlV37RYOvIABHeH6HPWVcN227Py7oBNGhipiDF3Rr21zosGYmthxgeVaVIi8WDeTR4komfVY4WDhoJ2cTFqkyKYpCf9BWgCReKmwp5MmXDgbWz1FrC4AAgECpeC2CJ2QYGz5/YCCjwLaEhenSPbtlhzMS2EVgOK3gJ4XyamjN+ygWmzU0aIX3OUqDyBwwlDS+BuKWBkEG0tfU7TcVMB4TxnufXM/LLLvZgWPeXL4dY9Jl6sFHVwuddgnjrAsUVpR+EHqSw7kTe9XjO/aGmRDOijX0eEq3k92YTdcVB/9dWMw29o/7v+4w/6CVJf1JWj+1alMqJy3ydRlMnloCObEnrYSoyvYHrMqgk3xMTRdnhh9ymE+hq4SX9fF2uslyTHyn2Ywhu249tMjBCortc3T5as6+YdfznF2fY51ZxTf+LStvEYg9KAhGDCS3nm+Ueeb/sH9Hh/di/6n5EcI4m4HgmtWnv7lzh5/8HfhF2W0GEI679tcZsMJPaqgoKjRg60INMQ+Vq4rl3fQpaOPjnd2nlr3wOSdUR7cjjzM7riYDZAEGJiHIm08lay8051pgVD/RfWs6j8ECimQBQNBPUagcJmLNok+fQoFca3A9lnwntaTQUs51TKeyzDkE62oMAkBXWtmr/o0hS0iypTSeXKqSUel3q+L5ahdYxJ99JOIyPKrJMfIQMpfjRsssQICsVG+fd83Eu1MqGbSpOxi7TFpSRr7w+O++iXqMBU7Jrf1vbC586lEvuQW+t9/ilkUKvYCqjPbugYUbQxETlF7ld8a9RZeNCZa3oq6odNpR0J8JOTTnZcw2lCfvPoslJauJVzlcDDPsAOUwjR81BWc15BgVIQbj27B9GGkJMQR6LNh5cYvJQsCo22d3OnikY7oGH04tre52LpmLGjPyly8qxh/uHpZQVbEvq8BrJ+oKgVxEjFUDd8lDWDNLnzgHQI8Srq6DewrrnDfrzpCk2Jajln1p+yx4B8dMblBTdNM+7bx7dhf06CAn+1EyZKVj5Hy1jblJ3mgrM4wbphXm+Qo/Ya6o13BJY8FPOcq9PCE1cL2RYINrEnqEom0Vv7OJreNZ7Df2F9QM23QeQ0kD3KTOYasic/Ad+BbFgyPF3n8STzwO+NuNDdHSl5hiVnqfwVGMUuZuRtc1xYastsHL20/ydT7xJtgHIGFESEvTAquODyvhbbJlXyOy4swnlVzgU1Z4LeMHmzm90xuYXtyKWXhrvL5a85nAApc0V1WIglmOq5OaAZVNwMEqvq67qsfU8fx1EZD0OOCk4iPU0e0a2sE+BeVQwsE4WnaKbiBfaRwOdi//Y2QnoCqhXHLKxZ3pCP0S7neLzGbCRlt9ONtgUr/c2AKvLWaGS0Dnmc2zygVYijgl7fFSdzgkJ+t5M/V01xVziEkADAwhfuFTGSqGwy5cIRwd1qsAm/KbX0ReIBXdC4IgODP0Fjz3RAqsO8oOmOdPp9ZpXhYE40TLHp9EMwYMhF2YNzI5lbP9T3wywQO5rEfgad413D63Kb5vLouKYyhqDphZI40oETaQgq3Z1Sxk0gQ6Lsu0c9xiQQ1pu2AAuTNwn7gvs8bRHU1ikHCoKNiWfOAhmIOkwohh8TSbGOWABiotb7W/CoDBij+lm2T3h0EwHC7MOZ7UN/BBcLlod7QCMmKXekKGv4k5pTrTQgN00Lnn83jXq/I62WX8THDQIPxE/rNzjHCR6vPXXMCuKYpIMDhcGmW+wJMnLpAUCxg89I3bcbKGH0QHHK7qf/HSSRR38JtWtnrge8vorLzhhx9CU8GuP3+JZAz2FcXbKXENN1xcr1Xf1/7aRdWmj4pI1Ir2LnlmexCEVGJW7zQ/ETeK6a4TTDcaVBSkMrrsdZPhjSyg/8WC4CFkC7iIcoDFq0IbLDzIXwLUlye8r9fo2d34Gjh4ZFAKoMn2m9m+oYUS9csfgmi1xMaizUBMgZM+igjdbI85rIGnRwoARc+f8qkMyDPoHbGtu+rM0Z/LTYlqj4O4gyqN4Imqpwx6b2gDoZSKsp50EEk3NClS50eBSef7E5p4mUSozvpXAVu3zZf5zrMXq2qrS4Xt/kHSGIIdVCowcafvUL6o4KuGfHxjrQMZMGFALPqs8H0n8MU9gM2WqQO5TaSfT+1jS+Kp9QwNks9CvRLnvNgvHpa4PjVRSOFApCFWsbbsq3qXKABN4XQhoyFaOSAtWc1zzf4dqMpUmpaGFMDMiHQPj4WmehkuWQiLHJOFh9Uy7X0jrQWnSLkNnjQWDLFt8AcYiFfOmtUqOwd2Zs+5KEOF1G+BQdBafwhuVES2aAaXMV6Z7INMpHLZ0+cVHjfqXmUr+cJcbUzOAckL4gfXuC+5siKaJf66StxSwCLf2DA2Rs6CrS1wPQsEf0BRlS29MAdUhfzEc00UE/YqBP+81KdztQwtB3LEV4/AasYam8OWNNkXxchrseS4BR4GQGhtYDuGC3yNfrD5JFBnvj6E+5KNbnNYNYw3ltJCUSuImWMr0U883c0gwWBFpbJHgfb3JyEA+D3wq6rgI5Qwfr8CcSc+lssmJOu+R9OvSm05LBT5VhX94MUyAyhRn21KZyiivpGSR8UITDqrMI+Lv4XnYGxKGqB0syw2yji3/ACA6gfTQG2o1bBYPVnQ16JZjorTzep4UXX43oGgieYaWyIr8ZiAXWVTAAA=" width="722" height="460" class="img_E7b_"></p><p><strong>第二步：workInProgress 和 current</strong></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="问题useeffect-和-uselayouteffect-的区别">问题：useEffect 和 useLayoutEffect 的区别<a class="hash-link" href="#问题useeffect-和-uselayouteffect-的区别" title="标题的直接链接">​</a></h3><p>useEffect 是异步调用的，useLayoutEffect 是同步调用的。</p><ul><li>useEffect 在 before mutation 阶段给它定义 mormal 优先级，然后绑定调用时机，在 commit 阶段完成后异步调用。在 layout 阶段，会绑定 useEffect 的 销毁函数、回调函数。在 commit 阶段完成后，按照优先级，最终会异步执行 销毁函数、回调函数。</li><li>useLayoutEffect 在 muation 阶段会执行销毁函数，在layout 阶段会执行回调函数。</li></ul><p><img loading="lazy" alt="截屏2022-08-07 00.18.02" src="/assets/images/截屏2022-08-07 00.18.02-62b446f9b882330ff0d1a9fb7e7a6396.png" width="2202" height="1218" class="img_E7b_"></p><blockquote><p>来源：</p><p>React课程：<a href="https://ke.segmentfault.com/course/1650000023864436/section/1500000023864578" target="_blank" rel="noopener noreferrer">https://ke.segmentfault.com/course/1650000023864436/section/1500000023864578</a></p><p><a href="https://github.com/lizuncong/mini-react/blob/master/docs/render/%E6%B7%B1%E5%85%A5%E6%A6%82%E8%BF%B0%20React%E5%88%9D%E6%AC%A1%E6%B8%B2%E6%9F%93%E5%8F%8A%E7%8A%B6%E6%80%81%E6%9B%B4%E6%96%B0%E4%B8%BB%E6%B5%81%E7%A8%8B.md" target="_blank" rel="noopener noreferrer">https://github.com/lizuncong/mini-react/blob/master/docs/render/%E6%B7%B1%E5%85%A5%E6%A6%82%E8%BF%B0%20React%E5%88%9D%E6%AC%A1%E6%B8%B2%E6%9F%93%E5%8F%8A%E7%8A%B6%E6%80%81%E6%9B%B4%E6%96%B0%E4%B8%BB%E6%B5%81%E7%A8%8B.md</a></p><p><a href="https://segmentfault.com/a/1190000039227345" target="_blank" rel="noopener noreferrer">https://segmentfault.com/a/1190000039227345</a></p><p><a href="https://juejin.cn/post/6844903975112671239" target="_blank" rel="noopener noreferrer">https://juejin.cn/post/6844903975112671239</a></p><p><a href="https://juejin.cn/post/7118259566868955167" target="_blank" rel="noopener noreferrer">https://juejin.cn/post/7118259566868955167</a></p></blockquote></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>标签：</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/docs/tags/react">React</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/frontEnd/React"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">概述</div></a></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#react-设计理念" class="table-of-contents__link toc-highlight">React 设计理念</a><ul><li><a href="#问题react-架构" class="table-of-contents__link toc-highlight">问题：react 架构</a><ul><li><a href="#1-调度阶段" class="table-of-contents__link toc-highlight">1 调度阶段</a></li><li><a href="#2-协调阶段" class="table-of-contents__link toc-highlight">2 协调阶段</a></li><li><a href="#3-渲染阶段" class="table-of-contents__link toc-highlight">3 渲染阶段</a></li></ul></li><li><a href="#问题algebraic-effects" class="table-of-contents__link toc-highlight">问题：algebraic effects</a><ul><li><a href="#algebraic-effects-的由来" class="table-of-contents__link toc-highlight">algebraic effects 的由来</a></li><li><a href="#algebraic-effects-解决的问题" class="table-of-contents__link toc-highlight">Algebraic Effects 解决的问题</a></li><li><a href="#react-hooks-思想" class="table-of-contents__link toc-highlight">React Hooks 思想</a></li></ul></li><li><a href="#问题初次渲染--更新-的区别" class="table-of-contents__link toc-highlight">问题：初次渲染 / 更新 的区别</a></li></ul></li><li><a href="#diff-相关" class="table-of-contents__link toc-highlight">diff 相关</a><ul><li><a href="#问题什么是-virtual-dom" class="table-of-contents__link toc-highlight">问题：什么是 virtual DOM</a></li><li><a href="#问题virtual-dom-的优势" class="table-of-contents__link toc-highlight">问题：virtual DOM 的优势</a></li><li><a href="#问题diff-原理" class="table-of-contents__link toc-highlight">问题：diff 原理</a></li><li><a href="#问题双缓存模型" class="table-of-contents__link toc-highlight">问题：双缓存模型</a></li></ul></li><li><a href="#fiber" class="table-of-contents__link toc-highlight">Fiber</a><ul><li><a href="#问题1-为什么要引入-fiber-架构" class="table-of-contents__link toc-highlight">问题1 为什么要引入 Fiber 架构？</a></li><li><a href="#问题2-什么是-fiber" class="table-of-contents__link toc-highlight">问题2 什么是 Fiber</a><ul><li><a href="#1-流程控制机制" class="table-of-contents__link toc-highlight">1 流程控制机制</a></li><li><a href="#2-执行单元" class="table-of-contents__link toc-highlight">2 执行单元</a></li><li><a href="#3-一种数据结构" class="table-of-contents__link toc-highlight">3 一种数据结构</a></li></ul></li><li><a href="#问题3-fiber-的结构" class="table-of-contents__link toc-highlight">问题3 Fiber 的结构</a></li></ul></li><li><a href="#其他" class="table-of-contents__link toc-highlight">其他</a><ul><li><a href="#问题jsx-element-fiber-dom-的关系" class="table-of-contents__link toc-highlight">问题：JSX, element, fiber, dom 的关系</a></li><li><a href="#问题fiber-更新机制" class="table-of-contents__link toc-highlight">问题：Fiber 更新机制</a></li><li><a href="#问题useeffect-和-uselayouteffect-的区别" class="table-of-contents__link toc-highlight">问题：useEffect 和 useLayoutEffect 的区别</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">分享</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/frontEnd/JavaScript">前端</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/code/algorithm">算法笔记</a></li><li class="footer__item"><a class="footer__link-item" href="/project">我的项目</a></li></ul></div><div class="col footer__col"><div class="footer__title">社交媒体</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/about">关于我</a></li><li class="footer__item"><a href="https://github.com/moxyNJ" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://juejin.cn/user/2005151873514024" target="_blank" rel="noopener noreferrer" class="footer__link-item">掘金<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Blog</div><ul class="footer__items"><li class="footer__item"><a href="https://www.ninjee.co" target="_blank" rel="noopener noreferrer" class="footer__link-item">Ninjee 的前端篮子</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright"><p>Copyright © 2022 Ninjee Built with Docusaurus.</p><p><a href="http://beian.miit.gov.cn/">晋ICP备2021017941号-2</a></p></div></div></div></footer></div>
<script src="/assets/js/runtime~main.1d2ced33.js"></script>
<script src="/assets/js/main.b11b27b3.js"></script>
</body>
</html>