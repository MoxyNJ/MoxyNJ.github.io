<!doctype html>
<html lang="zh" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-frontEnd/React/React_Note">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.18">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="ninjee RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="ninjee Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="ninjee JSON Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Ninjee的前端篮子" href="/opensearch.xml">
<script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?0930342e569f854bebdeb485c0eac7f8",e.defer=!0;var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script>
<meta name="baidu-site-verification" content="code-rqLUw5reVS">
<link rel="icon" href="/img/ninjee.jpeg">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="rgb(51 139 255)"><title data-rh="true">1. React笔记 - Ninjee的前端篮子</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://ninjee.netlify.app/img/ninjee.jpeg"><meta data-rh="true" name="twitter:image" content="https://ninjee.netlify.app/img/ninjee.jpeg"><meta data-rh="true" property="og:url" content="https://ninjee.netlify.app/docs/frontEnd/React/React_Note"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="keywords" content="Moxy, Ninjee, blog, javascript, typescript, python ,node, react, vue, web, 前端, 后端"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="1. React笔记 - Ninjee的前端篮子"><meta data-rh="true" name="description" content="React 架构体系三大模块"><meta data-rh="true" property="og:description" content="React 架构体系三大模块"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://ninjee.netlify.app/docs/frontEnd/React/React_Note"><link data-rh="true" rel="alternate" href="https://ninjee.netlify.app/docs/frontEnd/React/React_Note" hreflang="zh"><link data-rh="true" rel="alternate" href="https://ninjee.netlify.app/docs/frontEnd/React/React_Note" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://OITUMQ5615-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.7d792d30.css">
<link rel="preload" href="/assets/js/runtime~main.555a76fc.js" as="script">
<link rel="preload" href="/assets/js/main.ab00bfd0.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">跳到主要内容</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/ninjee-icon.png" alt="ninjee" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/ninjee-icon.png" alt="ninjee" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Ninjee</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">前端知识</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/frontEnd/JavaScript">JavaScript</a></li><li><a class="dropdown__link" href="/docs/frontEnd/HTML&amp;CSS">HTML &amp; CSS</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/frontEnd/React">React</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">敲代码</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/code/algorithm">算法</a></li><li><a class="dropdown__link" href="/docs/code/writtenJs">手写Js</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">面试</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/interview/summary">总结</a></li><li><a class="dropdown__link" href="/docs/interview/internet">计算机网络</a></li><li><a class="dropdown__link" href="/docs/interview/os">操作系统</a></li><li><a class="dropdown__link" href="/docs/interview/iot">物联网</a></li></ul></div><a class="navbar__item navbar__link" href="/project">我的项目</a><div class="toggle_S7eR colorModeToggle_vKtC"><button class="clean-btn toggleButton_rCf9 toggleButtonDisabled_Pu9x" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_qEbK"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="docPage_P2Lg"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_RiAD"><nav class="menu thin-scrollbar menu_izAj"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/frontEnd/React">概述</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/docs/frontEnd/React/React_Note">1. React笔记</a></li></ul></nav><button type="button" title="收起侧边栏" aria-label="收起侧边栏" class="button button--secondary button--outline collapseSidebarButton_FykI"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_DTRl"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Xlws" aria-label="breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/">🏠</a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="item name">1. React笔记</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>1. React笔记</h1></header><p>React 架构体系三大模块</p><ul><li>调度</li><li>协调</li><li>渲染</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="react-设计理念">React 设计理念<a class="hash-link" href="#react-设计理念" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="问题react-运行机制--架构">问题：React 运行机制 / 架构<a class="hash-link" href="#问题react-运行机制--架构" title="标题的直接链接">​</a></h3><h5 class="anchor anchorWithStickyNavbar_mojV" id="设计理念">设计理念<a class="hash-link" href="#设计理念" title="标题的直接链接">​</a></h5><p>浏览器的性能瓶颈在 CPU 和 IO。</p><p>React 解决 CPU / IO 的瓶颈：<strong>异步可中断的更新</strong>。</p><p>浏览器的刷新率通常为 60Hz/s，也就是 16.6ms 刷新一次页面。</p><ul><li>16.6ms 中，浏览器需要完成：JS脚本执行、样式布局、样式绘制。</li></ul><p>当渲染的处理时间超过 16.6ms，页面就会卡顿。通常使用节流（间隔触发）、防抖（最后一个触发），都是通过限制更新频率来提升性能。</p><p>React 把同步更新，变为异步可中断进行更新。React 通过 fiber 把渲染任务切分为多个小段，每个小段执行完毕后会把主动权交还浏览器，浏览器则可根据当前任务的优先级，把剩余时间分配给更重要的任务，以确保尽可能的响应及时。</p><ul><li>16.6ms 中，当浏览器执行完重要任务后，会把剩余时间交给 React 取执行尚未处理完的任务，如果剩余时间不够，就会把剩余任务在下一个 16.6ms 周期中执行。</li></ul><p>这样，浏览器就有充足的时间进行样式布局和页面绘制，而 React 也可以在分配给自己的时间内执行完任务。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="异步可中断">异步可中断<a class="hash-link" href="#异步可中断" title="标题的直接链接">​</a></h5><p>React 15+ 实现了异步可中断的架构。</p><ul><li>Scheduler 调度器：调度更新，给更新任务安排优先级。</li><li>Reconcoler 协调器：决定需要更新什么组件，当更高优任务来到时，可中断当前任务。</li><li>Renderer 渲染器：将组件更新到视图中，渲染过程是同步且不可中断的，需要一气呵成。</li></ul><p>在 render 函数的执行周期中，有调度（事件触发）、协调（render）、渲染（commit）三个阶段：</p><p><img loading="lazy" alt="image-20220806230807382" src="/assets/images/image-20220806230807382-ce972a80313ee829768b13c49c111bbd.png" width="1412" height="602" class="img_E7b_"></p><h4 class="anchor anchorWithStickyNavbar_mojV" id="1-调度阶段">1 调度阶段<a class="hash-link" href="#1-调度阶段" title="标题的直接链接">​</a></h4><p>当 React 需要更新时，更新任务首先被 Scheduler 调度器 处理。</p><p>处理的工作有：</p><ul><li><strong>创建项目根 Fiber 节点</strong>。首次渲染页面时，会创建唯一的根节点 FiberRoot Node。</li><li><strong>创建应用根 Fiber 节点</strong>。每一个 <code>ReactDOM.render()</code> 都会创建一个 rootFiber。</li><li><strong>初始化事件</strong>。Scheduler 会把任务按照优先级排序，让更高优的任务首先进入 Reconciler 协调器进行下一步处理。</li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="2-协调阶段">2 协调阶段<a class="hash-link" href="#2-协调阶段" title="标题的直接链接">​</a></h4><p><strong>协调阶段是 Reconcoler 协调器在参与，也被称为 render 阶段</strong>，如下图 renderRootSync 都为协调阶段。</p><p><img loading="lazy" alt="image-20220806231908259" src="/assets/images/image-20220806231908259-29f8253c8f951b76032810417729e781.png" width="680" height="386" class="img_E7b_"></p><p>Scheduler 调度器会通过 diff 算法，处理传入的更新任务。diff 完毕后，会由 fiber 构成一颗新的 fiber 树，然后提交给 Renderer 渲染器进一步处理。</p><ul><li>关于 virtual DOM 的概念，有两种说法：<ul><li>广义的说，由 fiber 组成的树为 fiber 树，也是一个 virtual DOM 树；</li><li>狭义的说，通过 React element 组成的树，是 virtual DOM 树，在协调阶段，会把 virtual DOM 转化为 fiber tree。</li></ul></li><li>关于组件中的 render 函数的作用：<ul><li>在调和阶段的整体任务，是通过 fiber 节点构建一棵 workInProgress fiber tree。这个构建过程是从根节点向子节点深度优先遍历完成的。</li><li>遇到，某个组件，会执行其调和阶段的生命周期函数，然后调用组件的 render。 render 会根据本次更新中的 state 变化，通过 <code>React.createElement</code> 生成新的 React Element 对象，在新的对象上保存了新的 state + props 状态。</li><li>该组件的 fiber 节点会根据对应的 React element 完成构建。同时对副作用变化打上标记。</li></ul></li></ul><h5 class="anchor anchorWithStickyNavbar_mojV" id="该阶段的特点">该阶段的特点：<a class="hash-link" href="#该阶段的特点" title="标题的直接链接">​</a></h5><ul><li><strong>可暂停</strong>。而在 Reconciler 在进行 diff 算法时，如果调度器传来一个更高优的任务，那么当前处理的更新任务会被暂停，让调度器放入任务队列中，优先处理传入的更高优任务。</li><li><strong>用户透明</strong>。由于调度器和协调器是在内存中工作，即使 diff 中断，用户也无法感知到页面渲染被中断 / 卡顿。</li><li><strong>构建 work In Progres 树</strong>。diff 算法会构建一颗虚拟 dom 树，视图上真实存在的节点，都有一个对应的节点在虚拟 dom 上。需要更新的节点会被打上标记 Update。被打了标记的虚拟 dom 会交给渲染器。</li></ul><h5 class="anchor anchorWithStickyNavbar_mojV" id="该阶段的工作">该阶段的工作：<a class="hash-link" href="#该阶段的工作" title="标题的直接链接">​</a></h5><p><strong>调和 work IN Progress Tree</strong>，也可以理解为构建 work IN Progress Tree。</p><p>构建过程是一个递归过程，从  <code>rootFiber</code>  开始向下深度优先遍历的，具体可以分为 n 个：递阶段 + 归阶段。</p><p><strong>（1）递阶段</strong></p><p>递阶段，是向下调和的过程。</p><p>调用 <strong>beginWork</strong> 方法，从  <code>rootFiber</code>  开始向下深度优先遍历，为遍历到的每个 fiber 节点。</p><p>该方法会根据传入的 <code>Fiber节点</code> 创建 <code>子Fiber节点</code>，并将这两个 <code>Fiber节点</code> 连接起来（<strong>fiber.child</strong> 指针）。当遍历到叶子节点（即没有子组件的组件）时就会进入 “归” 阶段。</p><p>如果不是初次渲染，而是更新页面，此时已经存在一个构建好的 <strong>Current Tree</strong>，<strong>beginWork</strong> 方法会由 fiberRoot 根节点，按照 <strong>child</strong> 指针逐层向下调和。</p><p>beginWork 具体的工作如下：</p><ul><li>对于组件，执行部分生命周期，执行 render ，得到最新的 children。</li><li>向下遍历调和 children ，复用 oldFiber ( diff 算法)。</li><li>打不同的副作用标签 effectTag ，比如类组件的生命周期，或者元素的增加，删除，更新。这些被标记的节点，会在归阶段收集起来，形成单项链表 effectList。</li></ul><div class="codeBlockContainer_I0IT language-js theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-js codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 生命周期钩子会在协调阶段被调用：</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">constructor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">componentWillMount 废弃</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">componentWillReceiveProps 废弃</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> getDerivedStateFromProps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">shouldComponentUpdate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">componentWillUpdate 废弃</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">render</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 常见的 effect tag</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> Placement </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/*             */</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0b0000000000010</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 插入节点</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> Update </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/*                */</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0b0000000000100</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 更新fiber</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> Deletion </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/*              */</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0b0000000001000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 删除fiebr</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> Snapshot </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/*              */</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0b0000100000000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 快照</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> Passive </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/*               */</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0b0001000000000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// useEffect的副作用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> Callback </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/*              */</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0b0000000100000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// setState的 callback</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> Ref </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/*                   */</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0b0000010000000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ref</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><strong>（2）归阶段</strong></p><p>归阶段，是向上并归的过程。</p><p>调用 <strong>completeWork</strong> 方法，来处理当前的 Fiber 节点。</p><p>当某个 <code>Fiber节点</code> 执行完 <code>completeWork</code>，如果其存在 <code>兄弟Fiber节点</code>（<strong>fiber.sibling</strong> 指针 ），会进入其 <code>兄弟Fiber</code> 的 “递”阶段。如果不存在 <code>兄弟Fiber</code>，会进入 <code>父级Fiber</code> 的“归”阶段（<strong>fiber.return</strong> 指针）。</p><p>在此期间会形成 effectList 单项副作用链表。如果是初次渲染的初始化流程，会创建 DOM ，对于 DOM 元素进行事件收集，处理 style，className 等工作。</p><ul><li>completeUnitOfWork
会将 effectTag 的 Fiber 节点会被保存在一条被称为 effectList 的单向链表中。在 之后的 commit 阶段，将不再需要遍历每一个 fiber ，只需要执行更新 effectList 就可以了。</li><li>completeWork 阶段
对于组件，会处理 context ；
对于元素标签初始化，会创建真实 DOM ，将子孙 DOM 节点插入刚生成的 DOM 节点中；
会触发 diffProperties 处理 props ，比如事件收集，style，className 处理，在15章讲到过。</li></ul><p><strong>（3）进入循环</strong></p><p>“递”和“归”阶段会交错执行，直到 “归” 到 <code>rootFiber</code> 根结点。至此，<code>render阶段</code> 的工作就结束了。</p><ul><li>构成（调和）了由 fiber 节点构成的 work IN Progress Tree 树。</li><li>构成了接下来 commit 阶段需要执行更新的 effectList 副作用链表。</li></ul><p><img loading="lazy" alt="截屏2022-08-08 00.27.04" src="/assets/images/截屏2022-08-08 00.27.04-d65a2edb1c300496eae515e26cb61e62.png" width="2130" height="1850" class="img_E7b_"></p><h4 class="anchor anchorWithStickyNavbar_mojV" id="3-渲染阶段">3 渲染阶段<a class="hash-link" href="#3-渲染阶段" title="标题的直接链接">​</a></h4><p><strong>渲染器工作的阶段，是 Renderer 渲染器在参与，被称为 commit 阶段</strong>，下图中，commitRoot 就是 commit 阶段。</p><p><img loading="lazy" alt="image-20220806232428977" src="/assets/images/image-20220806232428977-7a5bc8cbc0acce02ca01ee1931d01d5b.png" width="980" height="420" class="img_E7b_"></p><p>本次更新由哪些组件需要更新视图，会让渲染器来分别执行这些视图更新操作。</p><p>每一个子阶段都是一个 while 循环，<strong>从头开始</strong> 遍历副作用链表。</p><ul><li>视图更新操作：对 DOM 节点的增、删、查、改。</li><li>渲染器把被打了标记的虚拟 dom 对应的真实 dom 节点执行更新 dom 的操作。</li><li>Mutation 突变，对于浏览器来说，就是 DOM 操作。</li></ul><p>该阶段触发的生命周期函数有：</p><div class="codeBlockContainer_I0IT language-js theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-js codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// before mutation 阶段</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">getSnapshotBeforeUpdate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// mutation 阶段</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">componentWillUnmount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// layout 阶段</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">componentDidMount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">componentDidUpdate</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><strong>（1）mutation 前阶段</strong></p><p>通常被称之为 before mutation 阶段，调用函数 <code>commitBeforeMutationEffects</code>。</p><ul><li><strong>class 组件</strong>。执行 <code>getSnapshotBeforeUpdate</code> 生命周期函数。因为 Before mutation 还没修改真实的 DOM 所以此时类组件可以获得更新 DOM 前的快照。</li><li><strong>函数组件</strong>。创建微任务，给 <code>useEffect</code> 的回调函数设定 normal Scheduler Priority，然后等待 commit 完成后，再 <strong>异步执行</strong>。防止同步执行时阻塞浏览器做视图渲染（如果对 dom 操作，则又要重协调）。</li></ul><p><strong>（2）mutaiton 阶段</strong></p><p>通常被称之为 mutation 阶段，调用函数 <code>commitMutationEffects</code>。</p><p>遍历包含 EffectTag 的 fiber 节点，所组成的 effectList 链表。处理每一个 fiber 节点的副作用，这些副作用有：</p><ul><li><strong>DOM 相关操作</strong>：增删改。Placement 插入，Update 更新 DOM 属性，Deletion 删除。</li><li><strong>class 组件</strong>。调用 class 组件 componentWillUnmount 生命周期函数。</li><li><strong>函数组件</strong>。执行 useLayoutEffect 的销毁函数，useLayoutEffect 是 <strong>同步执行</strong> 的。</li><li><strong>Ref 属性</strong>。解绑/更新 Ref 属性。</li></ul><p><strong>（2.1）更改 current 指针</strong></p><p>在进入 layout 节点前，会执行：</p><div class="codeBlockContainer_I0IT language-js theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-js codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">root</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">current </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> finishedWork</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>这就是 React 架构的双缓存机制中，Work In Progress Fiber 树完成渲染，此时 <code>fiberRoot.current</code> 指针会从之前的 current Fiber 树，指向现在的 Work In Progress Fiber 树。此时，Work In Progress Fiber 树，就变成了新的 Current Fiber 树。</p><p>在该实际触发，是因为在 layout 阶段会执行 <code>componentDidMount</code> 和 <code>componentDidUpdate </code>这两个生命周期函数，此时，Current Fiber 树已经指向了本次完成的 Work In Progress Fiber 树，这两个生命周期会对新的 Current Fiber 树进行操作。</p><p><strong>（3）mutation 后阶段</strong></p><p>通常被称之为 layout 阶段，调用函数 <code>commitLayoutEffects</code>。</p><ul><li><strong>函数组件</strong>。<ul><li>执行 useLayoutEffect 的回调函数，是 <strong>同步执行</strong> 的。</li><li>绑定 useEffect 的销毁 + 回调函数，以便在 commit 阶段完成后，<strong>异步执行</strong> useEffect 销毁 + 回调函数。</li></ul></li><li><strong>类组件</strong>。<ul><li>根据组件状态，同步执行，调用 class 生命周期：<ul><li>ComponentDidMount（组件挂载）、ComponentDidUpdate（组件卸载）</li></ul></li><li>同步执行 <code>this.setState(arg, callback)</code> 中的 <code>callback</code>回调。</li></ul></li><li>处理 Ref 属性。</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="问题algebraic-effects">问题：algebraic effects<a class="hash-link" href="#问题algebraic-effects" title="标题的直接链接">​</a></h3><p>Process 进程、Thread 线程、Coroutine 协程、Fiber 纤程</p><ul><li>JavaScript 通过 Generator，在协程层面实现了异步可中断更新。</li></ul><p>algebraic effects 代数效应：是函数式编程中的概念，用于将副作用从函数调用中分离。</p><blockquote><ul><li><p><a href="https://zhuanlan.zhihu.com/p/380855727" target="_blank" rel="noopener noreferrer">https://zhuanlan.zhihu.com/p/380855727</a></p></li><li><p><a href="https://juejin.cn/post/6844903976299675662" target="_blank" rel="noopener noreferrer">https://juejin.cn/post/6844903976299675662</a></p></li></ul></blockquote><h4 class="anchor anchorWithStickyNavbar_mojV" id="algebraic-effects-的由来">algebraic effects 的由来<a class="hash-link" href="#algebraic-effects-的由来" title="标题的直接链接">​</a></h4><ul><li>在异步编程中，如果想用同步的思维编写代码，就要使用 async/await。但 async 函数具有传染性，调用 async 的函数也必须要用 async 定义。这样逐渐传染出去，所有的函数都需要变成异步函数，造成了大范围影响，同步异步代码也不易区分。</li></ul><p>新的需求：在同步代码中，可以调用异步函数并获得结果。但不影响同步函数的逻辑（同步函数不要 async 定义）</p><ul><li>try/catch  + throw 具有跳出当前代码块（throw 区），然后冒泡到 try/catch 被捕获，在 catch 继续执行代码的能力。</li></ul><p>新的需求：Js 中，具有从同步代码跳出的逻辑，就是 try/catch 了，但只能从 throw 跳出到 catch，不可以再携带结果回到 throw 中。我们如何定义这样的功能呢？</p><ul><li>此时我们需要一个可以在 throw 区暂停执行，从 catch 区域获取答案，再跳回 throw 处继续执行代码的 “异步” 能力。这就是许多文章中说的定义一个语法：perform，try/handle，resume with。</li></ul><div class="codeBlockContainer_I0IT language-js theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-js codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">user</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> user</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 1. 我们在这里 perform 了一个 effect：name = perform &#x27;ask_name&#x27;;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> perform </span><span class="token string" style="color:#e3116c">&#x27;ask_name&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 4. …… 然后最终回到了这里（name 现在是「Arya Stark」了 </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">makeFriends</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">user1</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> user2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  user1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">friendNames</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">getName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">user2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  user2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">friendNames</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">getName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">user1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> arya </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> gendry </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Gendry&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">makeFriends</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arya</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> gendry</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">handle</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">effect</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 2. 我们跳到了handler（就像 try/catch）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">effect </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;ask_name&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 3. 然而我们可以 resume with 一个值（这就不像 try / catch 了！）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resume </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Arya Stark&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ul><li>通过 perform + resume with 实现对后续流程的控制，控制反转 + 控制恢复。</li><li>通过 try/handle 实现跨调用栈捕获当前 continuation（延续—），在上面的例子中，就是让同步代码可以继续执行下去的那个值（name）。resume with 可以替换 当前的 continuaiton，让 perform 处恢复执行。</li></ul><p>需求满足：通过上述的语法糖，实现了在同步代码中，调用一个异步函数但不影响同步代码区的目的。</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="algebraic-effects-解决的问题">Algebraic Effects 解决的问题<a class="hash-link" href="#algebraic-effects-解决的问题" title="标题的直接链接">​</a></h4><p><strong>分离了 &quot;主逻辑做什么&quot; 和 &quot;副作用实现&quot;</strong>。</p><p>在上面的例子中，</p><ul><li><strong>主逻辑</strong> 就是 getName 函数要通过 user 对象获得并返回 name。</li><li><strong>副作用</strong> 就是当出现找不到名字时，通过 perform 拿到一个名字。</li></ul><p>所以，副作用的实现：perform 处的 <code>ask_name</code> 换来了 resume with 处的 <code>Arya Stark</code>。就是代数效应需要解决的核心问题。通过穿透调用栈的换元法实现副作用。</p><ul><li>Algebraic: 代数式，可以理解成初中数学的 <strong>换元法</strong>。</li><li>Effect：副作用。</li></ul><p>总结来说，代数效应解决了 <strong>分离了 &quot;主逻辑做什么&quot; 和 &quot;副作用实现&quot;</strong>，也就是确保主逻辑和代码不受影响的情况下，实现副作用。这需要：</p><ol><li>穿透能力：可以跨调用栈获取当前 Continuation。</li><li>恢复执行：可以替换当前 Continuation 内 Effect 的实现。</li></ol><h4 class="anchor anchorWithStickyNavbar_mojV" id="react-hooks-思想">React Hooks 思想<a class="hash-link" href="#react-hooks-思想" title="标题的直接链接">​</a></h4><p>React Hooks 的代码示例：</p><div class="codeBlockContainer_I0IT language-jsx theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-jsx codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">useLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">useEffect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;mount&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;unmount&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Foo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">useLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;Example&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text">Foo</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Bar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">useLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;Bar&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text">Bar</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>穿透能力：</p><p>useHook 实现了穿透调用栈的效果。不论 hooks 如何嵌套在作用域中，只要保证是同步调用 hooks，都能正确作用于对应组件。</p><p>每一个 Function Component 看作是 React 里的 Continuation，对 Continuation 的调度是交给 React Fiber 控制的，也就是 fiber 实现了代数效应。</p><p>恢复执行：<code>useHook(callback)</code> 中，callback 是该组件副作用的实现，hook 抽象出了 React 组件里的副作用。让组件内的主逻辑不受影响。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="问题初次渲染--更新-的区别">问题：初次渲染 / 更新 的区别<a class="hash-link" href="#问题初次渲染--更新-的区别" title="标题的直接链接">​</a></h3><h5 class="anchor anchorWithStickyNavbar_mojV" id="初次渲染">初次渲染<a class="hash-link" href="#初次渲染" title="标题的直接链接">​</a></h5><p>初次渲染时，没有两颗相同的 fiber tree。 FiberRootNode.current 会指向一个单独的 RootFiberNode 节点，其节点下没有任何子节点（即<code>current Fiber树</code>为空）。</p><p>于此同时，会在内存中构建 Work In Progress Fiber Tree。WIP 树和 CUR 树的 FiberNode 节点会通过 .alternate 相互指向：</p><p><img loading="lazy" alt="截屏2022-08-07 22.42.10" src="/assets/images/截屏2022-08-07 22.42.10-c47e67c927e51a566be8b8deb428a236.png" width="2286" height="1828" class="img_E7b_"></p><p>当 workInProgress 树构建完成后，代码中称之为 finishedTree，此时 <code>.current</code> 指针指向 finishedTree，使其变为 current fiber tree，初始化流程在协调阶段的任务完成。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="更新-update">更新 Update<a class="hash-link" href="#更新-update" title="标题的直接链接">​</a></h5><p>基于上述 tree，当用户点击一次按钮，发生页面更新时，会重新创建一颗 workInProgress tree。</p><p>通过 diff 算法，workInProgress tree 会决定是否复用 current fiber tree 同一层级的 fiber 节点数据。</p><ul><li>能被复用，本次更新中，需要做组件的 update、元素的 move 和 update 等操作；</li><li>不能复用，本次更新中，需要做组件的 mount 和 umount、元素的 insert 和 delete 等操作。</li></ul><p>在构建 workInProgress Fiber 树时,  <strong>会尝试复用 current Fiber 树中已有的 Fiber 节点内的属性</strong>。在 <strong>首屏渲染</strong> 时，只有 rootFiber 存在对应的 current fiber（即 rootFiber.alternate），无法复用。</p><ul><li><strong>处于同一层次的节点，会通过 .alternate 属性相互指向，workInProgress tree 也会优先复用 current fiber tree  处在同一层次节点的属性。</strong></li></ul><p>RootFiber 已经创建不需要复制，但其子节点由于尚不存在， 则 react 需要重新创建一份，和 current 树上的 fiber 建立起 alternate 关联，然后复制 current 树上节点的属性。渲染完毕后，workInProgresss 再次变成 current 树。</p><p><img loading="lazy" alt="截屏2022-08-07 22.49.01" src="/assets/images/截屏2022-08-07 22.49.01-a6ffd18d89304be80d7459a9d8483400.png" width="2502" height="1458" class="img_E7b_"></p><h5 class="anchor anchorWithStickyNavbar_mojV" id="再次更新">再次更新<a class="hash-link" href="#再次更新" title="标题的直接链接">​</a></h5><p>如果进行下一次更新，那么会将 current 的 alternate 作为基础（如图右树），复制一份作为 workInProgresss ，然后进行更新。</p><ul><li>所谓 “复制”，具体是指在构建 workInProgress Fiber 树时会尝试复用 current Fiber 树中已有的 Fiber 节点（.alternate 可以相互指向的，同一层次的节点）内的属性。而决定是否复用过程，就是 diff 算法。</li></ul><blockquote><p><a href="https://juejin.cn/post/7118259566868955167" target="_blank" rel="noopener noreferrer">https://juejin.cn/post/7118259566868955167</a></p><p><a href="https://github.com/lizuncong/mini-react/blob/master/docs/render/%E6%B7%B1%E5%85%A5%E6%A6%82%E8%BF%B0%20React%E5%88%9D%E6%AC%A1%E6%B8%B2%E6%9F%93%E5%8F%8A%E7%8A%B6%E6%80%81%E6%9B%B4%E6%96%B0%E4%B8%BB%E6%B5%81%E7%A8%8B.md" target="_blank" rel="noopener noreferrer">https://github.com/lizuncong/mini-react/blob/master/docs/render/%E6%B7%B1%E5%85%A5%E6%A6%82%E8%BF%B0%20React%E5%88%9D%E6%AC%A1%E6%B8%B2%E6%9F%93%E5%8F%8A%E7%8A%B6%E6%80%81%E6%9B%B4%E6%96%B0%E4%B8%BB%E6%B5%81%E7%A8%8B.md</a></p><p><a href="https://www.jianshu.com/p/6660d3ab0394" target="_blank" rel="noopener noreferrer">https://www.jianshu.com/p/6660d3ab0394</a></p></blockquote><h3 class="anchor anchorWithStickyNavbar_mojV" id="问题哪些方式可以触发-update-更新">问题：哪些方式可以触发 update 更新？<a class="hash-link" href="#问题哪些方式可以触发-update-更新" title="标题的直接链接">​</a></h3><p>对于用户来说，对 UI 的操作都有可能触发 update 更新：拖动组件、输入文本、点击按钮改变 state 等等。</p><p>对 React 内部来说，通过对 DOM 事件监听，会触发对应的回调函数，按照可以触发更新的方法所隶属的组件分类：</p><ul><li><code>ReactDOM.render()</code> —— HostRoot</li><li><code>this.setState()</code> —— ClassComponent</li><li><code>this.forceUpdate()</code> —— ClassComponent</li><li><code>useState()</code> —— FunctionComponent</li><li><code>useReducer()</code> —— FunctionComponent</li></ul><p>可以看到，一共三种组件（<code>HostRoot</code> | <code>ClassComponent</code> | <code>FunctionComponent</code>）可以触发 update 更新。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="diff">diff<a class="hash-link" href="#diff" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="问题什么是-virtual-dom">问题：什么是 virtual DOM<a class="hash-link" href="#问题什么是-virtual-dom" title="标题的直接链接">​</a></h3><p>从结构来看：虚拟 DOM 是一个 JavaScript 对象。其保存了每一个节点的 type、props、key、ref、children 等信息（具体看 fiber 结构）。</p><p>从本质来看：在 React 运行时，有两颗 virtual DOM（双缓存机制）：current fiber 树 + work in progress fiber 树。其是由于 fiber 对象所组成的。</p><p>从来源来看：虚拟 DOM 是通过 <code>React.creatElement()</code> 创建的 React Element 构建的 DOM 树。</p><p>对比真实DOM来看：virtual DOM要比真实 DOM 轻的多，少了很多用不到的默认属性和方法。</p><p>测试：</p><p>用 <code>React.createElement</code> 和 <code>document.createElement</code> 创建节点并打印：</p><div class="codeBlockContainer_I0IT language-js theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-js codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">VDOM</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> React</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createElement</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;div&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;小杜杜&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">DOM</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> document</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createElement</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;div&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">DOM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">innerHTML </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;小杜杜&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">虚拟DOM：</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">VDOM</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">真实DOM：</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">DOM</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>结果：</p><p><img loading="lazy" alt="1.png" src="/assets/images/58db2ee32bde44b3afd5e2e6af3e3647~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0-ce22e7fc31e9aefa33fb0a3d08b5ef3d.awebp" width="1166" height="482" class="img_E7b_"></p><p>虚拟 DOM 是一个 js 对象，而真实 DOM 上还挂在了许多默认属性和方法：</p><p><img loading="lazy" alt="2.png" src="/assets/images/c859397a03024903939f934907052cc2~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0-bf7010e65b450f32e10625812a9b8bb0.awebp" width="970" height="730" class="img_E7b_"></p><p>虚拟 DOM 的结构：</p><ul><li>type：实际的标签</li><li>props：标签内部的属性（除 <code>key</code> 和 <code>ref</code> ，会形成单独的 <code>key</code> 名）</li><li>children: 为节点内容</li></ul><div class="codeBlockContainer_I0IT language-jsx theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-jsx codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 转化前</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">className</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">Index</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text">Hello World 123</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">ul</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">li</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text">React</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">li</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">li</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text">Vue</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">li</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">ul</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 转化后</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;div&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">props</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Index&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">children</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token literal-property property" style="color:#36acaa">type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;div&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token literal-property property" style="color:#36acaa">children</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Hello World 123&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token literal-property property" style="color:#36acaa">type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;ul&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token literal-property property" style="color:#36acaa">children</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token literal-property property" style="color:#36acaa">type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;li&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token literal-property property" style="color:#36acaa">children</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;React&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token literal-property property" style="color:#36acaa">type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;li&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token literal-property property" style="color:#36acaa">children</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Vue&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="问题virtual-dom-的优势">问题：virtual DOM 的优势<a class="hash-link" href="#问题virtual-dom-的优势" title="标题的直接链接">​</a></h3><p>主要有三：提高效率、提升性能、增强兼容性。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="1-提高效率">1. 提高效率<a class="hash-link" href="#1-提高效率" title="标题的直接链接">​</a></h5><p>使用原生 JS 的时候，我们需要的关注点在 <strong>操作DOM</strong> 上，而 <code>React</code> 会通过 <code>virtual DOM</code> 来确保 <code>DOM</code> 的匹配。程序员只需使用 JSX 来进行声明式编程，也就是说，程序员不需关系 dom 是如何构建 / 操作 / 更新的，React 会处理一切，而只需要关系业务逻辑。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="2-提升性能">2. 提升性能<a class="hash-link" href="#2-提升性能" title="标题的直接链接">​</a></h5><p>虚拟 DOM 通过 diff 算法 + 基于双缓存的批量处理机制，优化了每次更新真实 DOM 得操作，使更新尽可能的局部、改动尽可能的少，从而减少对真实 DOM 的操作，最终提升性能。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="3-增强兼容性">3. 增强兼容性<a class="hash-link" href="#3-增强兼容性" title="标题的直接链接">​</a></h5><p>基于 virtual DOM，让 React 可以兼容各种浏览器，甚至跨平台兼容。</p><ul><li><code>React</code> 基于虚拟 DOM 实现了一套自己的事件机制，并且模拟了事件冒泡和捕获的过程，采取 <strong>事件代理</strong>、<strong>批量更新</strong> 等方法，从而磨平了各个浏览器的事件兼容性问题。</li><li>对于跨平台，<code>React</code> 和 <code>React Native</code> 都是根据 <strong>虚拟DOM</strong> 渲染出相应平台的 <code>UI</code> 层，只不过不同的平台有不同的渲染引擎而已。</li></ul><blockquote><ul><li><a href="https://juejin.cn/post/7116326409961734152" target="_blank" rel="noopener noreferrer">https://juejin.cn/post/7116326409961734152</a></li></ul></blockquote><h3 class="anchor anchorWithStickyNavbar_mojV" id="问题diff-原理">问题：diff 原理<a class="hash-link" href="#问题diff-原理" title="标题的直接链接">​</a></h3><h5 class="anchor anchorWithStickyNavbar_mojV" id="概述">概述<a class="hash-link" href="#概述" title="标题的直接链接">​</a></h5><p>从 React 的运行原理来说，React diff 是协调（<strong>reconciliation</strong>）阶段的主要任务，协调阶段也称 render 阶段。React diff 会计算出 Virtual DOM 中真正变化的部分，并构建好一颗 Work In Progress Fiber Tree 和一个 EffectList 单项符作用链表，<strong>指名哪些节点需要被更新</strong>。在渲染阶段（commit 阶段），React 会只针对 effectList 上的 fiber 节点进行 DOM 操作，而不是对整个页面（树）进行重新渲染。</p><p>传统 diff 算法使用循环递归对节点一次对比，时间复杂度为 <em>O(n^3)</em> 。React 改进后将时间复杂度降为 <em>O(n)</em>。</p><p>React diff 的策略有：</p><ol><li>Web UI 中 DOM 节点跨层级的移动操作特别少，可以忽略不计。</li><li>拥有相同类的两个组件将会生成相似的树形结构，拥有不同类的两个组件将会生成不同的树形结构。</li><li>对于同一层级的一组子节点，它们可以通过唯一 id 进行区分。</li></ol><p>基于以上三个前提策略，React 分别对 tree diff、component diff 以及 element diff 进行算法优化：</p><ul><li>tree diff、component diff、element diff</li></ul><h5 class="anchor anchorWithStickyNavbar_mojV" id="tree-diff">tree diff<a class="hash-link" href="#tree-diff" title="标题的直接链接">​</a></h5><p>基于策略一，React 对树的 diff 算法进行优化，即两棵树只会对同一层次的节点进行比较，而不考虑跨等次的节点比较。而在初次构建 fiber tree 时，基于双缓存的思想，已经构建好了 work in progress fiber tree 和 current fiber tree，且两棵树的统一层级的 fiber 节点会用 fiber.alternate 相互连接。这样对一棵树只需遍历一次，便能完成整个 DOM 树的比较。</p><ul><li><strong>跨层级移动操作的处理</strong>。React 对节点跨层级的移动操作不会 diff 比较，只有销毁旧节点和重新创建。所以通过同层遍历，React 发现同级节点已经发生变化，则会把该节点和其子节点全部销毁，然后重新创建新节点。</li></ul><p><strong>🚀 性能优化</strong>：在页面中使用 antd 的 model 模态框时，尽可能不要移除该节点，而是使用 css 隐藏掉。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="component-diff">component diff<a class="hash-link" href="#component-diff" title="标题的直接链接">​</a></h5><p>React 是基于组件构建应用的，diff 算法会在组件间也有优化，基于策略 2：</p><ul><li>如果是不同类型的组件进行 diff，和 “跨层级的移动操作” 一样，会直接销毁整个旧组件，重新创建新组件。</li><li>如果是同一类型的组件进行 diff，则 DOM 结构大致相似，会按照 tree diff 算法进行比较。</li></ul><p><strong>🚀 性能优化</strong>：如果是同一个组件，本次更新时 Virtual DOM 没有任何变化（props、state 也没有变化），那么用户可以通过性能优化告知 React ，diff 会跳过该组件的对比。</p><ul><li>对于 class 组件来说，通过 shouldComponentUpdate + shallowEqual，或直接使用 PureComponent。</li><li>对于 function 组件来说，通过 React.memo 包裹。</li></ul><blockquote><p><strong>shouldComponentUpdate</strong> </p><p>render （调合）阶段的生命周期函数。<strong>用于拦截组件渲染</strong>。</p><ol><li>父组件更新，子组件必须更新。</li></ol><p>当使用component时，父组件的state或prop更新时，无论子组件的state、prop是否更新，都会触发子组件的更新，这会形成很多没必要的render，浪费很多性能。</p><ol start="2"><li>shallowEqual 可以浅对比组件的 props 和 state 是否发生变化，从而避免无意义的 render。</li></ol><p>在 shouldComponentUpdate 中，使用 shallowEqual 比较组件的 props 和 state 是否发生变化，最后返回 true 的时候，当前组件进行 render；返回 false 则不进行 render。</p><p><strong>PureComponent / React.memo</strong></p><p>PureComponent 是针对类组件的语法糖，而 React.memo 让函数组件也可以使用，通过 React.memo 包裹函数组件，回返回一个高阶组件。</p><ul><li>另：函数组件没有 shouldComponentUpdate 周期。</li></ul><p>React 给出了官方的定义：使用 PureComponent 定义组件。可以完成上述 2 的操作。PureComponent 会在 shouldComponentUpdate 周期进行一次 shallowEqual 浅对比，从而尽可能避免 render。</p></blockquote><h5 class="anchor anchorWithStickyNavbar_mojV" id="element-diff">element diff<a class="hash-link" href="#element-diff" title="标题的直接链接">​</a></h5><p>当 fiber 节点处于同一层级时，React diff 提供了三种节点操作，分别为：<strong>INSERT_MARKUP</strong>（插入）、<strong>MOVE_EXISTING</strong>（移动）和 <strong>REMOVE_NODE</strong>（删除）。</p><ul><li><strong>插入</strong>：当前节点所在的组件，不在原来的集合中存在，即是全新的节点，执行插入操作。</li><li><strong>移动</strong>：当前节点所在的组件，存在于原来的集合中，且节点内可更新（ DOM 结构相似等递归判断），则根据 React 唯一 key 进行区分，并且执行移动操作。<ul><li>如：(A,B,C,D) → (A,D,B,C)，传统 diff 会把 B,C,D 全部销毁并重新创建，而 React 仅移动位置。</li></ul></li><li><strong>删除</strong>：当前节点的所在组件虽然存在在原来的集合中，但节点不能直接复用和更新，所以需要删除旧节点。或旧节点已经不再需要，执行销毁。</li></ul><p>节点间的移动策略，是通过节点下标 lastIndex/_mountIndex 判断，这里不细说了。</p><p>可否复用的原则：</p><ul><li>如果 key 未定义，则默认 key = null。</li><li>更新后，判断 key 是否改变：<ul><li>key 改变，不能复用。</li><li>key 没改变，继续判断 type 是否改变：<ul><li>type 改变，不能复用。</li><li>type 没变，当前节点可以复用。需要判断其 children 下的节点是否需要更新。</li></ul></li></ul></li></ul><p><strong>🚀 性能优化</strong>：</p><ol><li>对同一层级的一组子节点，可以给它们添加唯一的 key 进行区分，则 React 可以在更新前后通过 key 去判断该节点及其子节点是否发生更新，提升性能。</li><li>尽可能保持 DOM 结构稳定，减少大量移动同级节点的操作，比如从队头插入新节点 / 将对尾巴的节点移动到队头。</li></ol><blockquote><p>参考：</p><p><a href="https://juejin.cn/post/7116326409961734152" target="_blank" rel="noopener noreferrer">https://juejin.cn/post/7116326409961734152</a></p><p><a href="https://juejin.cn/post/6844903944796258317" target="_blank" rel="noopener noreferrer">https://juejin.cn/post/6844903944796258317</a></p><p><a href="https://zhuanlan.zhihu.com/p/20346379" target="_blank" rel="noopener noreferrer">https://zhuanlan.zhihu.com/p/20346379</a></p><p><a href="https://juejin.cn/book/6945998773818490884/section/6959807335720026150" target="_blank" rel="noopener noreferrer">https://juejin.cn/book/6945998773818490884/section/6959807335720026150</a></p></blockquote><h3 class="anchor anchorWithStickyNavbar_mojV" id="问题双缓存模型">问题：双缓存模型<a class="hash-link" href="#问题双缓存模型" title="标题的直接链接">​</a></h3><p><strong>产生原因</strong>：</p><ol><li>双缓存模型是一个解决图形编程中 “<strong>闪烁问题</strong>” 的方案。其基本原理是在内存中绘制当前帧，绘制完毕后直接用当前帧替换上一帧，由于省掉了帧与帧之间替换的时间因此可以有效的避免闪烁问题。 </li><li>react 15+ 的新架构，协调阶段的异步可中断。通过双缓存，当更高优任务来到，需要中断当前 diff 的树时，由于存在 current fiber tree 正常工作。所以 workInProgress fiber tree 的中断并重新构建，不会影响页面的正常展示，对用户透明。</li></ol><p><strong>实施阶段</strong>：在协调阶段，react 通过 双缓存机制输出两颗 fiber tree（work in progress fiber tree 内存中的树，current fiber tree 渲染树）。这两棵树中，同级节点通过 <code>fiber.alternate</code> 指针相互连接。current fiber tree 代表了页面正在展示的 DOM 内容，而 work in progress fiber tree 是内存中 react 正在构建的 fiber tree，是本次更新之后页面展示的 DOM 内容。</p><p><strong>实施过程</strong>：当触发更新时，react 会通过 diff 算法（官方称 Reconciliation）对比 current fiber tree，构建一颗 work in progress fiber tree。</p><ul><li>在构建 workInProgress Fiber 树时,  <strong>会尝试复用 current Fiber 树中已有的 Fiber 节点内的属性</strong>。在 <strong>首屏渲染</strong> 时，只有 rootFiber 存在对应的 current fiber（即 rootFiber.alternate）。<ul><li>更多见问题：初次渲染 / 更新的区别。</li></ul></li><li>引入协调阶段的工作内容：深度遍历优先、递阶段、归阶段、构建 effectList 副作用链。</li><li>渲染阶段：在下一次渲染的时候，直接复用缓存树做为下一次渲染树，上一次的渲染树又作为缓存树，这样可以防止只用一颗树更新状态的丢失的情况，又加快了 DOM 节点的替换与更新。</li></ul><p>总结：一个元素最多存在两个版本的 fiber 节点，一个 current 版本和当前浏览器页面对应，一个 WorkInProgress 版本，WorkInProgress 版本是正在协调的节点。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="fiber">Fiber<a class="hash-link" href="#fiber" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="问题1-为什么要引入-fiber-架构">问题1 为什么要引入 Fiber 架构？<a class="hash-link" href="#问题1-为什么要引入-fiber-架构" title="标题的直接链接">​</a></h3><p>fiber 是针对单进程的一种调度策略。</p><p>在操作系统中，介绍过常见的单处理进程调度策略：</p><ul><li>先到先得(First-Come-First-Served, FCFS)<ul><li>优点：简单，易实现</li><li>缺点：对短进程不利、对 I/O 密集型进程不理。</li></ul></li><li>轮转<ul><li>抢占策略。确定合理的时间片长度，公平地给每一个进程一定的执行时间，当时间消耗完毕或阻塞，操作系统就会调度其他进程，将执行权抢占过来。</li></ul></li><li>最短进程优先(Shortest Process Next, SPN)<ul><li>缺点：对长进程不利，会饥饿。</li></ul></li><li>最短剩余时间(Shortest Remaining Time, SRT)<ul><li>根据剩余时间的长短，优先执行可最快完成的进程。</li><li>缺点：对长进程不利，会饥饿。</li></ul></li><li>最高响应比优先(HRRN)<ul><li>响应比 = （等待执行时间 + 进程执行时间） / 进程执行时间</li><li>解决长进程饥饿问题，引入了等待执行时间，让等待时间较长的可以尽可能优先执行。</li></ul></li><li>反馈法，多队列<ul><li>每个进程一开始都有相同的优先级，每次被抢占(需要配合其他抢占策略使用，如轮转)，优先级就会降低一级。因此通常它会根据优先级划分多个队列</li></ul></li></ul><p>浏览器中，JavaScript 的执行也是单线程的。Javascript 引擎和页面渲染引擎在同一个<code>渲染线程</code>，GUI 渲染和 Javascript执行 两者是互斥的。如果让 js执行长期占据渲染进程，浏览器就会呈现 “卡死” 状态，页面无法刷新。</p><p>对于’前端框架‘来说，解决这种问题有三个方向:</p><ul><li>1️⃣ 优化每个任务，让它有多快就多快。挤压CPU运算量</li><li>2️⃣ 快速响应用户，让用户觉得够快，不能阻塞用户的交互</li><li>3️⃣ 尝试 Worker 多线程</li></ul><p>Vue 从1⃣️角度入手，通过模版 + 响应式机制，提升任务运行速度。</p><p>React 从2⃣️角度入手，通过 fiber 架构，把任务切分，提升浏览器响应速度。</p><p>具体为：</p><p>React 有三大模块：</p><ul><li><p>Scheduler 调度器：调度更新.</p></li><li><p>Reconcoler 协调器：决定需要更新什么组件.</p></li><li><p>Renderer 渲染器：将组件更新到视图中.</p></li></ul><p>其中，<code>Reconcilation</code> 协调阶段是 CPU 密集型操作，fiber 把该环节切分，使 <code>Reconcilation</code> 过程变成可中断，适时的让出 CPU 执行权（16.6ms），好处：</p><ul><li>不再一次性操作大量 DOM 节点，而是分批延时对 DOM 进行操作。提升了浏览器的响应速度。</li><li>给浏览器一点喘息的机会，他会对代码进行编译优化（JIT）及进行热代码优化，或者对reflow进行修正</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="问题2-什么是-fiber">问题2 什么是 Fiber<a class="hash-link" href="#问题2-什么是-fiber" title="标题的直接链接">​</a></h3><p>是一种流程控制机制：</p><ul><li>一个动态执行单元</li><li>一种静态数据结构</li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="1-流程控制机制">1 流程控制机制<a class="hash-link" href="#1-流程控制机制" title="标题的直接链接">​</a></h4><p>Fiber 也称协程、或者纤程。 是一种控制流程的让出机制。协程和线程并不一样，协程本身是没有并发或者并行能力的（需要配合线程）。</p><p>Fiber 实现了代数效应（看代数效应的例子），可以近似的理解为是 async/await + try/catch 的结合。</p><ul><li>普通函数的执行过程中无法被中断和恢复：async/await 实现了中断和恢复。</li><li>但因此导致了副作用：async具有传染性，需要全部的函数都为 async。如果可以类似 try/catch 的效果，让副作用和主逻辑分离，则代码逻辑更清晰。</li></ul><p><strong>React 渲染的过程可以被中断，可以将控制权交回浏览器，让位给高优先级的任务，浏览器空闲后再恢复渲染</strong></p><p>合作式调度 Cooperative Scheduling：浏览器中没有抢占机制，无法中断正在执行的任务，所以 React 需要具备让出机制，主动让出控制权。</p><p>这是一种给予信任的契约合作机制：React 会根据自己的任务量，向浏览器申请适量的时间片。而浏览器会先执行更高优先级的任务，再把剩余时间分给 React，React 也会在规定的时间内完成任务执行，归还控制权。</p><p><img loading="lazy" alt="img" src="/assets/images/16deecc37fdd60d7~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0-5175c162183af87a410334df21557a68.awebp" width="1268" height="700" class="img_E7b_"></p><p>那么，如何确定剩余时间呢？或者哪些任务是更高优先级的呢？</p><p>在一帧（16.6 ms）中，浏览器会执行以下任务：</p><ul><li>处理用户输入事件</li><li>Javascript执行</li><li>requestAnimation 调用</li><li>布局 Layout</li><li>绘制 Paint</li></ul><p>如果在执行完这些必须任务后，还有剩余的时间，就可给 React 去使用：</p><p>浏览器调用 <code>requestIdleCallback</code> 的回调：</p><p><img loading="lazy" alt="img" src="/assets/images/16deecc43c710e16~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0-af1ecf1eda7814df686431778089fc93.awebp" width="737" height="139" class="img_E7b_"></p><p>为了避免剩余时间不足，任务被饿死，React 定义了一个超时时间。如果任务等待时间到达超时时间后，就会提升优先级，立即执行。</p><ul><li><code>Immediate</code>(-1) - 这个优先级的任务会同步执行, 或者说要马上执行且不能中断</li><li><code>UserBlocking</code>(250ms) 这些任务一般是用户交互的结果, 需要即时得到反馈</li><li><code>Normal</code> (5s) 应对哪些不需要立即感受到的任务，例如网络请求</li><li><code>Low</code> (10s) 这些任务可以放后，但是最终应该得到执行. 例如分析通知</li><li><code>Idle</code> (没有超时时间) 一些没有必要做的任务 (e.g. 比如隐藏的内容), 可能会被饿死</li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="2-执行单元">2 执行单元<a class="hash-link" href="#2-执行单元" title="标题的直接链接">​</a></h4><p>FIber 另一个概念是一种数据结构，或者说执行单元。</p><ul><li>将它视作一个执行单元，每次执行完一个 &#x27;执行单元&#x27;，React 就会检查现在还剩多少时间，如果没有时间就将控制权让出去。</li></ul><p>流程：</p><ul><li><p>假设用户调用 <code>setState</code> 更新组件, 这个待更新的任务会先放入队列中，然后通过 <code>requestIdleCallback</code> 请求浏览器调度。</p></li><li><p>浏览器有空闲时间，或者任务超时，就会调用 <code>performWork</code> 来循环遍历，并执行队列中的任务。</p></li></ul><p><code>workLoop</code> ：它会从更新队列 (updateQueue) 中弹出更新任务来执行，每执行完一个 ‘<code>执行单元</code>‘ ，就检查一下剩余时间是否充足，如果充足就进行执行下一个 <code>执行单元</code>，反之则停止执行，保存现场，等下一次有执行权时恢复。</p><p><img loading="lazy" alt="img" src="/assets/images/16deed1711f281b3~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0-d0240fc89f86c4d1a73102992edf1a0f.awebp" width="1056" height="1089" class="img_E7b_"></p><h4 class="anchor anchorWithStickyNavbar_mojV" id="3-一种数据结构">3 一种数据结构<a class="hash-link" href="#3-一种数据结构" title="标题的直接链接">​</a></h4><p>查看问题3.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="问题3-fiber-的结构">问题3 Fiber 的结构<a class="hash-link" href="#问题3-fiber-的结构" title="标题的直接链接">​</a></h3><p>在 React 16以前，Reconcilation 是同步的、递归执行的。也就是说，Dom 的构建基于 <strong>函数调用栈</strong> 的Reconcilation算法，因此通常也称它为<code>Stack Reconcilation</code>。</p><p>但基于调用栈的方式不能随意中断 / 恢复现场，也不利于异步处理的代数效应实现。 如果要恢复递归现场，可能需要从头开始，恢复到之前的调用栈。</p><p>所以，React 16 通过模拟函数调用栈，将递归转化成迭代，使用 <strong>链表</strong> 构建。</p><p> 每个 VirtualDOM 节点，都使用一个 <code>Fiber</code> 表示：</p><div class="codeBlockContainer_I0IT language-js theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-js codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">Fiber</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">   * ⚛️ 节点的类型信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">   */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 标记 Fiber 类型: 函数/类组件、根元素、dom元素、文本节点、Fragment、MemoComponent等</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">tag</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> WorkTag</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 节点元素类型, 是具体的类组件、函数组件、宿主组件(字符串)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> any</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">   * ⚛️ 结构信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">   */</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 指向父节点，或者render该节点的组件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Fiber </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 指向第一个子节点</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">child</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Fiber </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 指向下一个兄弟节点</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">sibling</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Fiber </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">   * ⚛️ 节点状态 state</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">   */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 节点实例(状态)：</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">//        对于宿主组件，这里保存宿主组件的实例, 例如DOM节点。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">//        对于类组件来说，这里保存类组件的实例</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">//        对于函数组件说，这里为空，因为函数组件没有实例</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">stateNode</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> any</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 新的、待处理的props</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">pendingProps</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> any</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 上一次渲染的props</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">memoizedProps</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> any</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// props、events</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 上一次渲染的组件状态 </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">memoizedState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> any</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// state、hooks</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">   * ⚛️ 副作用</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">   */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 当前节点的副作用类型，例如节点更新、删除、移动</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">effectTag</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> SideEffectTag</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 和节点关系一样，React 同样使用链表来将所有有副作用的Fiber连接起来</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">nextEffect</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Fiber </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">   * ⚛️ 替身</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">   * 指向旧树中的节点，WorkInProgress会把alternate对应的fiber属性完整的复制过来</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">   */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">alternate</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Fiber </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Fiber 包含的属性可以划分为 5 个部分:</p><ul><li><strong>🆕 结构信息</strong><ul><li>Fiber 使用链表的形式来表示节点在树中的定位，将 virtualDom 构建起来。</li></ul></li><li><strong>节点类型信息</strong><ul><li>tag 表示节点的分类、type 保存具体的类型值，如div、Component。</li></ul></li><li><strong>节点的状态</strong><ul><li>节点的组件实例、props、state 等，它们将影响组件的输出。</li></ul></li><li><strong>🆕 副作用</strong><ul><li>在 Reconciliation 过程中发现的 &#x27;副作用&#x27;(<strong>变更需求</strong>) 就保存在节点的 <code>effectTag</code> 中(想象为打上一个标记)。</li><li>使用链表结构，将本次渲染的所有节点副作用都收集起来。在遍历过程中 React 会将所有有 ‘副作用’ 的节点都通过 <code>nextEffect</code> 连接起来。</li></ul></li><li><strong>🆕 替身</strong> <ul><li>React 在 Reconciliation 过程中会构建一颗新的 virtualDOM (官方称为<strong>workInProgress tree</strong>，<strong>WIP树</strong>)。是一颗表示当前工作进度的树。</li><li>还有一颗表示已渲染界面的<strong>旧树（current tree）</strong>，这棵树代表了已经渲染的并正在显示的页面。</li><li>React就是一边和旧树比对，一边构建WIP树的。 alternate 指向旧树的同等节点。</li></ul></li></ul><p><img loading="lazy" alt="img" src="/assets/images/16deecce3162b355~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0-c4218249f9dea90c20684edbe11ebc2c.awebp" width="915" height="690" class="img_E7b_"></p><p>上图是 Reconciliation 完成后的状态，左边是旧树，右边是WIP树。对于需要变更的节点，都打上了&#x27;标签&#x27;。 在提交阶段，React 就会将这些打上标签的节点应用变更。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="问题fiber-更新机制">问题：Fiber 更新机制<a class="hash-link" href="#问题fiber-更新机制" title="标题的直接链接">​</a></h3><p>初始化更新：</p><p><strong>第一步：创建 fiberRoot 和 rootFiber</strong></p><ul><li><code>fiberRoot</code>：首次构建应用， 创建唯一的 fiberRoot 节点，是整个 React 应用的根基。</li><li><code>rootFiber</code>： 通过 <code>ReactDOM.render()</code> 渲染出来的。一个 React 应用可以有多 ReactDOM.render 创建的 rootFiber ，但是只能有一个 fiberRoot（应用根节点）。</li></ul><div class="codeBlockContainer_I0IT language-js theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-js codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// rootFiber</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ReactDOM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">render</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Index</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> document</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getElementById</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;app&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>第一次挂载的过程中，会将 fiberRoot 和 rootFiber 建立起关联。</p><ul><li><code>fiberRoot.current = rootFiber;</code></li></ul><p><img loading="lazy" alt="3.jpg" src="data:;base64,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" width="722" height="460" class="img_E7b_"></p><p><strong>第二步：workInProgress 和 current</strong></p><p>待续。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="生命周期-hooks">生命周期 hooks<a class="hash-link" href="#生命周期-hooks" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="问题useeffect-和-uselayouteffect-的区别">问题：useEffect 和 useLayoutEffect 的区别<a class="hash-link" href="#问题useeffect-和-uselayouteffect-的区别" title="标题的直接链接">​</a></h3><p>useEffect 是异步调用的，useLayoutEffect 是同步调用的。</p><ul><li>useEffect 在 before mutation 阶段给它定义 mormal 优先级，然后绑定调用时机，在 commit 阶段完成后异步调用。在 layout 阶段，会绑定 useEffect 的 销毁函数、回调函数。在 commit 阶段完成后，按照优先级，最终会异步执行 销毁函数、回调函数。</li><li>useLayoutEffect 在 muation 阶段会执行销毁函数，在layout 阶段会执行回调函数。</li></ul><p><img loading="lazy" alt="截屏2022-08-07 00.18.02" src="/assets/images/截屏2022-08-07 00.18.02-62b446f9b882330ff0d1a9fb7e7a6396.png" width="2202" height="1218" class="img_E7b_"></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="问题react-生命周期8">问题：React 生命周期（8）<a class="hash-link" href="#问题react-生命周期8" title="标题的直接链接">​</a></h3><blockquote><ul><li><a href="https://projects.wojtekmaj.pl/react-lifecycle-methods-diagram/" target="_blank" rel="noopener noreferrer">https://projects.wojtekmaj.pl/react-lifecycle-methods-diagram/</a></li></ul></blockquote><p>类组件的生命周期，从 React 运行阶段 + 组件处理类型来分析。</p><ul><li>React 运行有三个阶段：调度、协调、渲染。</li><li>组件的处理有三个类型：挂载、更新、卸载。</li></ul><p><img loading="lazy" alt="截屏2022-08-08 15.34.10" src="/assets/images/截屏2022-08-08 15.34.10-ae118d8fe5719e54706b8bdb9f950749.png" width="2232" height="1476" class="img_E7b_"></p><p>组件挂载会执行：</p><ul><li><p>协调阶段：constructor、static getDerivedStateFrpmProps、render</p></li><li><p>渲染阶段：componentDidMount</p></li></ul><p>组件更新会执行：</p><ul><li>协调阶段：static getDerivedStateFrpmProps、shouldComponentUpdate（forceUpdate不执行）、render</li><li>渲染阶段：getSnapshotBeforeUpdate、componentDidUpdate</li></ul><p>组件卸载会执行：</p><ul><li>渲染阶段：componentWillUnmount</li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="协调阶段-render">协调阶段 render<a class="hash-link" href="#协调阶段-render" title="标题的直接链接">​</a></h4><p>协调阶段的生命周期函数是不包含副作用的。</p><p>组件挂载：</p><p><strong><code>constructor(props)</code></strong>
类组件的继承、props 传递、初始化 state。</p><ul><li>在初始化阶段执行，可直接对 <code>this.state</code> 赋值。其他生命周期函数中只能通过 <code>this.setState</code> 修改 state，不能直接为 <code>this.state</code> 赋值。</li></ul><div class="codeBlockContainer_I0IT language-js theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-js codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">constructor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">props</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">super</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">props</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token literal-property property" style="color:#36acaa">number</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">handlexxx </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">handlexxx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">bind</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>共有：</p><p><strong><code>static get­Derived­State­From­Props（props, state)</code></strong></p><p>做为 <code>componentWillMount</code>、<code>componentWillUpdate</code> 和 <code>componentWillReceiveProps</code> 的替代方案。在调用 render 前，最后一次修改 state 的机会。它可以返回一个对象，用来更新 state；返回 null 则不更新。</p><ul><li>做为静态方法，其内部使用 this 拿不到组件实例。</li></ul><p>组件更新：</p><p><strong><code>shouldComponentUpdate(nextProps, nextState)</code></strong></p><p>只有在通过修改 props 或 state 时才会触发。首次渲染和 forceUpdate 不会触发。这里是 React 给用户判断，组件是否应当更新的时机。如果返回 flase，则组件不会调用 render 及以后的方法，不会更新。</p><ul><li><strong>性能优化</strong>。通过将  <code>this.props</code> 和 nextProps 比较，以及将 <code>this.state</code> 与 nextState 比较，并返回 false，让组件跳过更新。</li><li><strong>关联知识</strong>：<code>Diff</code>、<code>PureComponent</code>、<code>React.memo()</code>。</li></ul><p><strong><code>render</code></strong></p><p>render 函数必须实现，它的返回值将构建为 fiber node，参与到 WorkInProgress Fiber Tree 的构建。</p><p>render 函数是纯函数，相同的 state 和 props，它总是返回相同的渲染结果。</p><p>render 会返回：React Element、Fragments、string / number（会当作文本节点）、false / null（空）。</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="渲染阶段-commit">渲染阶段 commit<a class="hash-link" href="#渲染阶段-commit" title="标题的直接链接">​</a></h4><p>渲染阶段又有三个阶段：before mutation、mutation、layout。</p><p><strong>(1) 在 before mutation 时</strong></p><p> <strong><code>getSnapshotBeforeUpdate(prevProps, prevState)</code> 组件更新</strong> </p><p>在页面即将渲染、DOM 树尚未改变时触发。可以在这里获取 DOM 改变前的信息。</p><p>它接收两个参数，分别是：上一个状态的 props 和上一个状态的 state。它的返回值将会传递给 componentDidUpdate 生命周期钩子的第三个参数。</p><p><strong>使用场景：</strong>获取更新前 DOM 的信息时。例如：需要以特殊方式处理滚动位置的聊天线程等。</p><p><strong>(2) 在 mutaiton 时</strong></p><p><strong><code>componentWillUnmount</code> 组件卸载</strong></p><p>会在组件卸载以及销毁之前调用。</p><p><strong>使用场景</strong>：执行组件的清理操作，例如：清除 timer、取消网络请求、清除订阅等。</p><p><strong>(3) 在 layout 时</strong></p><p>layout 阶段，这两个生命周期的调用时机是相同的，一个是针对组件首次挂载，一个是针对组件更新。</p><p><strong><code>componentDidMount</code> 组件挂载</strong></p><p>该生命周期方法会在组件挂载之后执行，也只会执行一次，也就是将组件对应的 DOM 插入 DOM 树中之后调用。</p><ul><li><strong>注意避免</strong>：它会在浏览器更新视图之前调用，如果在 componentDidMount 中<strong>直接调用</strong> <code>this.setState</code>，它会触发额外的渲染，会再一次调用 render 函数，但是浏览器中视图的更新只会执行一次。</li><li><strong>使用场景</strong>：依赖于 DOM 的初始化操作。发送网络请求、监听事件、获取到真实 DOM。</li></ul><div class="codeBlockContainer_I0IT language-js theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-js codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">componentDidMount</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">fetch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;https://api.github.com/users&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">then</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">res</span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain">res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">json</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">then</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">users</span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">users</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">users</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><strong><code>componentDidUpdate(prevProps, PrevState, snapshot) </code> 组件更新</strong></p><p>该生命周期方法会在组件更新之后执行，只会执行一次。</p><p>该函数有三个参数：前一个状态的 props，前一个状态的 state、getSnapshotBeforeUpdate 的返回值。</p><p>可以（不建议）在生命周期中直接调用 <code>this.setState</code>。但必须包裹在一个条件语句中，否则会导致死循环。</p><p><strong>使用场景：</strong>对 DOM 进行操作，或者进行网络请求。</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="问题react-17-为什么会废弃-3-个生命周期">问题：React 17 为什么会废弃 3 个生命周期<a class="hash-link" href="#问题react-17-为什么会废弃-3-个生命周期" title="标题的直接链接">​</a></h4><p>componentWillMount、componentWillReceiveProps、componentWillUpdate 这三个生命周期函数在 React 17 版本被废弃。而 React 添加静态方法 static getDerivedStateFromProps 来代替。</p><p>React 16 更新了 fiber 架构，提出了调度、协调、渲染三大阶段。其中协调阶段是异步可中断的，如果调度阶段安排了优先级更高的任务，当前协调的任务可被中断。</p><p>这导致协调（render）阶段的生命周期函数可能会被多次执行，所以这些函数需要实现无副作用的纯函数。如果使用旧生命周期函数，在这里定义了网络请求，那么有可能会执行多次网络请求。而通过新的静态方法 getDerivedStateFromProps，开发者无法从 this 正常获取组件实例，那么就不能修改 state 和发送网络请求了。避免生命周期的不安全使用。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="问题生命周期函数的执行顺序">问题：生命周期函数的执行顺序<a class="hash-link" href="#问题生命周期函数的执行顺序" title="标题的直接链接">​</a></h3><p>父子组件间，生命周期函数的触发顺序：</p><p><img loading="lazy" alt="img" src="data:;base64,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" width="316" height="251" class="img_E7b_"></p><p>总结：</p><p>在 render 阶段的生命周期函数，自上而下调用，即父组件先调用，子组件后调用。</p><p>然后是 commit 阶段中，划分每一个子阶段。每个在阶段都是子组件先调用，后父组件调用。</p><ul><li>before mutation：getSnapshotBeforeUpdate（更新）</li><li>mutation：componentWillUnmoun (卸载)</li><li>layout：componentDidMount（挂载）或 componentDidUpdate（更新）</li></ul><p>最后的生命周期函数</p><div class="codeBlockContainer_I0IT language-jsx theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-jsx codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> React </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;react&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">App</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">React</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">Component</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">constructor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">props</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">super</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">props</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token literal-property property" style="color:#36acaa">count</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;App constructor&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getDerivedStateFromProps</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;App static getDerivedStateFromProps&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">shouldComponentUpdate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">nextProps</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;App shouldComponentUpdate&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">getSnapshotBeforeUpdate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">prevProps</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;App getSnapshotBeforeUpdate&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">componentDidMount</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;App componentDidMount&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">componentDidUpdate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;App componentDidUpdate&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">render</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;App render&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">onClick</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#393A34">=</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript punctuation" style="color:#393A34">(</span><span class="token tag script language-javascript punctuation" style="color:#393A34">)</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript operator" style="color:#393A34">=&gt;</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript keyword" style="color:#00009f">this</span><span class="token tag script language-javascript punctuation" style="color:#393A34">.</span><span class="token tag script language-javascript function" style="color:#d73a49">setState</span><span class="token tag script language-javascript punctuation" style="color:#393A34">(</span><span class="token tag script language-javascript punctuation" style="color:#393A34">(</span><span class="token tag script language-javascript parameter" style="color:#00009f">count</span><span class="token tag script language-javascript punctuation" style="color:#393A34">)</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript operator" style="color:#393A34">=&gt;</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript punctuation" style="color:#393A34">(</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript literal-property property" style="color:#36acaa">count</span><span class="token tag script language-javascript operator" style="color:#393A34">:</span><span class="token tag script language-javascript" style="color:#00009f"> count </span><span class="token tag script language-javascript operator" style="color:#393A34">+</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript number" style="color:#36acaa">1</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag script language-javascript punctuation" style="color:#393A34">)</span><span class="token tag script language-javascript punctuation" style="color:#393A34">)</span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text">App</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag class-name" style="color:#00009f">Child</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">order</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#393A34">=</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript number" style="color:#36acaa">1</span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag class-name" style="color:#00009f">Child</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">order</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#393A34">=</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript number" style="color:#36acaa">2</span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Child</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">React</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">Component</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">constructor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">props</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">super</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">props</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token literal-property property" style="color:#36acaa">count</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">Child</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation keyword" style="color:#00009f">this</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">props</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">order</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c"> constructor</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getDerivedStateFromProps</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">props</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">Child</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">props</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">order</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c"> static getDerivedStateFromProps</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">shouldComponentUpdate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">nextProps</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">Child</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">nextProps</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">order</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c"> shouldComponentUpdate</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">getSnapshotBeforeUpdate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">prevProps</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">Child</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">prevProps</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">order</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c"> getSnapshotBeforeUpdate</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">componentDidMount</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">Child</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation keyword" style="color:#00009f">this</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">props</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">order</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c"> componentDidMount</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">componentDidUpdate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">Child</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation keyword" style="color:#00009f">this</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">props</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">order</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c"> componentDidUpdate</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">render</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">Child</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation keyword" style="color:#00009f">this</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">props</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">order</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c"> render</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">onClick</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#393A34">=</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript punctuation" style="color:#393A34">(</span><span class="token tag script language-javascript punctuation" style="color:#393A34">)</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript operator" style="color:#393A34">=&gt;</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript keyword" style="color:#00009f">this</span><span class="token tag script language-javascript punctuation" style="color:#393A34">.</span><span class="token tag script language-javascript function" style="color:#d73a49">setState</span><span class="token tag script language-javascript punctuation" style="color:#393A34">(</span><span class="token tag script language-javascript punctuation" style="color:#393A34">(</span><span class="token tag script language-javascript parameter" style="color:#00009f">count</span><span class="token tag script language-javascript punctuation" style="color:#393A34">)</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript operator" style="color:#393A34">=&gt;</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript punctuation" style="color:#393A34">(</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript literal-property property" style="color:#36acaa">count</span><span class="token tag script language-javascript operator" style="color:#393A34">:</span><span class="token tag script language-javascript" style="color:#00009f"> count </span><span class="token tag script language-javascript operator" style="color:#393A34">+</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript number" style="color:#36acaa">1</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag script language-javascript punctuation" style="color:#393A34">)</span><span class="token tag script language-javascript punctuation" style="color:#393A34">)</span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">        Child</span><span class="token punctuation" style="color:#393A34">{</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">props</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">order</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">default</span><span class="token plain"> App</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>首次渲染：</p><p><img loading="lazy" alt="截屏2022-08-08 16.24.03" src="/assets/images/截屏2022-08-08 16.24.03-ebd2b8661bae741e57107481283bc6ce.png" width="2556" height="1132" class="img_E7b_"></p><p>子组件状态改变：当点击文字 Child1 时，其执行结果如下：</p><p><img loading="lazy" alt="截屏2022-08-08 16.30.47" src="/assets/images/截屏2022-08-08 16.30.47-96e47245bb84c61e16a392adfedcbee4.png" width="1502" height="312" class="img_E7b_"></p><p>父组件状态改变：点击父组件文字，让 <code>this.seteState</code> 触发</p><p><img loading="lazy" alt="截屏2022-08-08 16.34.02" src="/assets/images/截屏2022-08-08 16.34.02-288ce5471743627342f90822e8ec7fcd.png" width="1500" height="720" class="img_E7b_"></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="问题react-hooks">问题：React hooks<a class="hash-link" href="#问题react-hooks" title="标题的直接链接">​</a></h3><p>React 16+ 开始，通过 fiber 结构实现了协调阶段的异步可中断。每个组件都会被转化为 fiber node，参与 WorkInProgress fiber tree 的构建。</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="hooks-的特点">Hooks 的特点<a class="hash-link" href="#hooks-的特点" title="标题的直接链接">​</a></h4><p>在调和阶段，hooks 会被初始化并绑定在函数组件 fiber.memoizedState 上。</p><ul><li>对于类组件 fiber ，用 memoizedState 保存 state 信息；<strong>对于函数组件 fiber ，用 memoizedState 保存 hooks 信息</strong>。</li></ul><p><strong>链表</strong>。在 memoizedState 属性中，hooks 通过 .next 属性把绑定在当前函数组件的 hooks 连接起来，形成一个链表。</p><p><strong>创建</strong>。函数组件的 hooks 在挂载会调用 Mount 函数，在更新时会调用 update函数。比如第一次调用 useState 会执行 mountState，后面再调用 useState 会执行 updateState。而这个函数的执行，会根据不同的 hooks 会生成对应的 hooks 对象，绑定在 next 链上。</p><ul><li>updateQueue 存放每个 useEffect/useLayoutEffect 产生的副作用组成的链表。在 commit 阶段更新这些副作用。</li></ul><p><strong>有序</strong>。所以，React 用链表来严格保证 hooks 的顺序。如果我们在函数组件中对 hooks 的添加使用 if 判断语句。这会导致一次更新的前后 hooks 链不一致，具体来说，current tree 和  WorkInProgress 中，对同一个函数组件的 hooks 链保存的内容不一致。如果此时 WorkIn Progress 要从 current 中读取 <code>state</code>、<code>ref</code> 等信息，原本按照 next 链条去对等读取（类似数组下标读取），但因为前后两次 hooks 链已经发生改变，对等位的 hooks 对象不一致，所以发生错误，React 防止错误发生，会抛出错误。</p><ul><li>这就是为什么 Hooks 不可以在条件语句定义了。</li></ul><p><img loading="lazy" alt="截屏2022-08-08 17.20.09" src="/assets/images/截屏2022-08-08 17.20.09-f2c36c052e7c1f262bc0a0af85a2c8cb.png" width="2352" height="1770" class="img_E7b_"></p><h4 class="anchor anchorWithStickyNavbar_mojV" id="hooks-介绍-9">Hooks 介绍 (9)<a class="hash-link" href="#hooks-介绍-9" title="标题的直接链接">​</a></h4><p>数据更新驱动：useState、useReducer</p><p>执行副作用：useEffect、useLayoutEffect</p><p>状态获取/传递：useContext、useRef、useImperativeHandle</p><p>状态派生/保存：useMemo、useCallback</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="usestate">useState<a class="hash-link" href="#usestate" title="标题的直接链接">​</a></h4><div class="codeBlockContainer_I0IT language-js theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-js codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> state </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> setState </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">useState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">initData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ul><li>state：目的提供给 UI ，作为渲染视图的数据源。</li><li>setState：改变 state 的函数，推动函数组件渲染的触发函数。</li><li>initData：获得 state 的初始值。有两种情况，如果是具体值，直接作为初始值。 如果是函数，执行函数的返回值做为初始化值。</li></ul><p><strong>注意事项</strong>：</p><ul><li><strong>“所谓异步”</strong>，在函数组件一次执行上下文中，state 的值是固定不变的。<ul><li>且当前执行上下文中获取不到 setState 改变的值，只有在下一次 render 后才能获取到。</li></ul></li><li><strong>浅对比</strong>，如果 setState 传入了相同的值，组件就不会触发 render 更新。</li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="usereducer">useReducer<a class="hash-link" href="#usereducer" title="标题的直接链接">​</a></h4><p>useReducer 是 react-hooks 提供的能够在无状态组件中运行的，类似 redux 的功能 api。</p><p>useReducer 是 useState hooks 的扩展。在逻辑相对复杂的情况下，可以用 reducer 的 switch 进行判断，通过 dispatch 达到对同一个 state 有不同的更新方法。</p><div class="codeBlockContainer_I0IT language-js theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-js codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> state </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dispatch </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">useReducer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">state</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> action</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">switch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">action</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">type</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">//增加、减少、清空、赋值..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> newState</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 使用：</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">dispatch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;increment&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ul><li>state：目的提供给 UI ，作为渲染视图的数据源。</li><li>dispatch：改变 state 的函数，推动函数组件渲染的触发函数。和 useState 的 setState 一样。</li><li>reducer：相当于 redux 的 reducer。是一个入参有 旧state + action、内部有 switch 的纯函数。函数内部实现了根据不同的 type，对 state 进行操作并返回，从而更新 state。</li></ul><p>使用方式：</p><ol><li><strong>封装</strong>。当对 state 更新的逻辑相对复杂，可以通过 useReducer 包装。</li><li><strong>复用</strong>。如果多个组件均有一个相同的判断方式（可以用同一个 switch 判断），那么单独定义一个 reducer 纯函数，然后不同的组件 import 引入这个 reducer 即可。</li></ol><h4 class="anchor anchorWithStickyNavbar_mojV" id="useeffect">useEffect<a class="hash-link" href="#useeffect" title="标题的直接链接">​</a></h4><div class="codeBlockContainer_I0IT language-js theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-js codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">useEffect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// code..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> destory</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">dep1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dep2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ul><li>第一个参数为 callback，主体为 useEffect 的回调函数，当依赖发生变化时执行。</li><li>return destory 销毁函数，作为下一次 callback 执行之前调用，用于清除上一次 callback 产生的副作用。</li><li>第二个参数为依赖，是一个数组，当依赖项改变，就会执行上一次的销毁函数，新的回调函数。<ul><li>如果不添加任何依赖，组件 render 就会触发，挂载 / 更新都会触发；</li><li>如果添加空数组 <code>[]</code>，组件只有在挂载时触发。</li></ul></li></ul><p>useEffect 是 <strong>异步调用</strong> 的。关联知识：渲染（commit阶段工作流程）：</p><ul><li>before mutation：创建微任务，给 <code>useEffect</code> 的回调函数设定 normal Scheduler Priority，加入任务队列。</li><li>layout：绑定 useEffect 的销毁 + 回调函数。</li><li>commit 完成，等待主线程任务完成（DOM 更新，视图绘制完毕）。异步执行 useEffect 的（上一次）销毁函数 + （本次）回调函数。</li></ul><p><strong>useEffect 回调函数不会阻塞浏览器绘制视图。</strong></p><p><strong>使用方式</strong>：</p><ul><li>回调函数：初始化 state、异步数据请求、注册事件监听、设置定时器；</li><li>销毁函数：注销事件监听、清楚定时器。</li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="uselayouteffect">useLayoutEffect<a class="hash-link" href="#uselayouteffect" title="标题的直接链接">​</a></h4><p>参数逻辑和 useEffect 相同，只是触发时机不同，useLayoutEffect 同步调用。在渲染阶段：</p><ul><li>mutation 阶段：执行 useLayoutEffecta 的销毁函数；</li><li>layout 阶段：执行 useLayoutEffect 的回调函数。</li></ul><p><strong>使用方式：</strong></p><ul><li>回调函数：在最后绘制 dom 前，需要对 dom 进行调整，注意不要死循环。</li></ul><p>useEffect 和 useLayoutEffect 的区别：</p><ol><li>前者异步调用，后者同步调用（参考在 commit 阶段的处理流程）。</li><li>前者不会阻塞浏览器绘制，后者的回调函数会阻塞浏览器绘制。</li></ol><p>所以，如果要对 DOM 进行修改，则不可以在 useEffect 中设置， useEffect 执行是在浏览器绘制视图之后，接下来又改 DOM ，会导致浏览器再次回流和重绘。而 useLayoutEffect 在 commit 阶段同步执行，阻塞浏览器的绘制，重新进入协调阶段，则页面不会发生画面闪现，抖动的问题。</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="usecontext">useContext<a class="hash-link" href="#usecontext" title="标题的直接链接">​</a></h4><p>useContext 可以代替 <code>context.Consumer</code> 来获取 Provider 中保存的 value 值，而不需要创建 <code>comsumer</code>。</p><ul><li>使用 <code>Context</code> 可以避免的组件的层层 <code>props</code> 嵌套的问题。但是使用 <code>context.Consumer</code> 拿值时，会包裹一层 <code>&lt;Comsumer&gt;</code> 组件。</li></ul><p>使用 useContext hook 可以不用 <code>&lt;Consumer&gt;</code> 嵌套。</p><p><strong>使用方式</strong>：获取全局的class 前缀，或者国际化，UI 主题颜色等。</p><div class="codeBlockContainer_I0IT language-jsx theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-jsx codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/* 用useContext方式 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">DemoContext1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">useContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"> my name is </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name </span><span class="token punctuation" style="color:#393A34">}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/* 用Context.Consumer 方式 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">DemoContext2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag class-name" style="color:#00009f">Context.Consumer</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"> my name is </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name </span><span class="token punctuation" style="color:#393A34">}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag class-name" style="color:#00009f">Context.Consumer</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">default</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag class-name" style="color:#00009f">Context.Provider</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#393A34">=</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript literal-property property" style="color:#36acaa">name</span><span class="token tag script language-javascript operator" style="color:#393A34">:</span><span class="token tag script language-javascript string" style="color:#e3116c">&#x27;alien&#x27;</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript punctuation" style="color:#393A34">,</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript literal-property property" style="color:#36acaa">age</span><span class="token tag script language-javascript operator" style="color:#393A34">:</span><span class="token tag script language-javascript number" style="color:#36acaa">18</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag class-name" style="color:#00009f">DemoContext1</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag class-name" style="color:#00009f">DemoContext2</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag class-name" style="color:#00009f">Context.Provider</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="useref">useRef<a class="hash-link" href="#useref" title="标题的直接链接">​</a></h4><p>useRef 用来保持一个对象的引用。接受一个状态 initState 作为初始值，返回一个 ref 对象。该对象的 <code>.current</code> 属性就是 ref 对象保持引用的对象（initState），也可以通过 <code>.current</code> 来改变引用状态。</p><div class="codeBlockContainer_I0IT language-js theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-js codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> cur </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> React</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">useRef</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">initState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cur</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">current  </span><span class="token comment" style="color:#999988;font-style:italic">// ref element</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>特点：不论该组件如何更新，该引用都不会被销毁，而一直保存在内存中不变。</p><p><strong>使用方式</strong>：通常用来保持对 DOM 元素的引用，或对一个固定状态的引用。</p><div class="codeBlockContainer_I0IT language-jsx theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-jsx codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">DemoUseRef</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> dom </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">useRef</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">handerSubmit</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dom</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">current</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//  打印dom节点：&lt;div&gt;表单组件&lt;/div&gt;  </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">ref</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#393A34">=</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript" style="color:#00009f">dom</span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text">表单组件</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token comment" style="color:#999988;font-style:italic">/* ref 标记当前dom节点 */</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">button</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">onClick</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#393A34">=</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript punctuation" style="color:#393A34">(</span><span class="token tag script language-javascript punctuation" style="color:#393A34">)</span><span class="token tag script language-javascript operator" style="color:#393A34">=&gt;</span><span class="token tag script language-javascript function" style="color:#d73a49">handerSubmit</span><span class="token tag script language-javascript punctuation" style="color:#393A34">(</span><span class="token tag script language-javascript punctuation" style="color:#393A34">)</span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text">提交</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">button</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="useimperativehandle">useImperativeHandle<a class="hash-link" href="#useimperativehandle" title="标题的直接链接">​</a></h4><p>用于父组件调用子组件的属性/方法。子组件对外暴露 / 提供部分功能，供父组件调用。</p><p>引：<strong><code>React.forwardRef()</code></strong> 用于转发 ref。</p><ul><li>把一个函数组件（有 props, ref 两个参数）传入 forwardRef，会返回一个 绑定好 ref 的新组件。</li></ul><p>下面的例子中，通过 forwardRef，Father 传递给 Son 一个 sonRef 对象。而 Son 接收到 sonRef 后，把它绑定在 input DOM 元素上。这样，父组件就持有了一个子组件中 input 元素的引用。</p><div class="codeBlockContainer_I0IT language-jsx theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-jsx codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> React</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">useRef</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">forwardRef</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;react&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> Son </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">forwardRef</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">props</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> ref</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">input</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">text</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">defaultValue</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#393A34">=</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript" style="color:#00009f">props</span><span class="token tag script language-javascript punctuation" style="color:#393A34">.</span><span class="token tag script language-javascript" style="color:#00009f">value</span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">ref</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#393A34">=</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript" style="color:#00009f">ref</span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">Father</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> sonRef </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">useRef</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag class-name" style="color:#00009f">Son</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">ref</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#393A34">=</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript" style="color:#00009f">sonRef</span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">子组件</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">button</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">onClick</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#393A34">=</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript punctuation" style="color:#393A34">(</span><span class="token tag script language-javascript punctuation" style="color:#393A34">)</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript operator" style="color:#393A34">=&gt;</span><span class="token tag script language-javascript" style="color:#00009f"> console</span><span class="token tag script language-javascript punctuation" style="color:#393A34">.</span><span class="token tag script language-javascript function" style="color:#d73a49">log</span><span class="token tag script language-javascript punctuation" style="color:#393A34">(</span><span class="token tag script language-javascript" style="color:#00009f">sonRef</span><span class="token tag script language-javascript punctuation" style="color:#393A34">.</span><span class="token tag script language-javascript" style="color:#00009f">current</span><span class="token tag script language-javascript punctuation" style="color:#393A34">)</span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text">点击打印 sonRef</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">button</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 点击子组件的 button 后，控制栏输出：&lt;input type=&quot;text&quot; value=&quot;子组件&quot;&gt;&lt;/input&gt;</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><blockquote><p>代码：<a href="https://codesandbox.io/s/festive-elion-4w514b?file=/src/App.js" target="_blank" rel="noopener noreferrer">https://codesandbox.io/s/festive-elion-4w514b?file=/src/App.js</a></p></blockquote><p>上面的例子可以看到，对于 Son 来说，入参 <code>ref</code> 就是父组件发来的，用于调用子组件的引用。但有时子组件需要对父组件暴露更多指定的属性和方法，这是就需要 <code>useImperativeHandle</code> 对其打包。</p><p><strong>useImperativeHandle</strong>  接收三个参数：</p><ul><li>ref：父组件传递过来的 ref，也就是将要绑定的 ref 引用。</li><li>callback：初始化时会调用该函数，返回一个对象，这个对象会绑定在 ref 引用上，被父组件引用。</li><li>deps：数组，成员是依赖项，当依赖发生改变，就会重新执行 callback，重新添加绑定。</li></ul><div class="codeBlockContainer_I0IT language-jsx theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-jsx codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> SonComponent </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">forwardRef</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">props</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> ref</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">useImperativeHandle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ref</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function-variable function" style="color:#d73a49">handle1</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function-variable function" style="color:#d73a49">handle2</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// ..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> deps</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><strong>使用场景</strong>：当父组件需要使用子组件部分属性和方法，而子组件不希望把自己全部内容都对外暴露时，通过 <code>forward.Ref</code> + <code>useImperativeHandle</code> 的配合，可以针对性的暴露部分功能。实现父组件调用子组件的部分方法。</p><ul><li>父组件是一个提交组件，n 个子组件是表单。父组件需要调用全部子组件的提交函数，让子组件把表单信息提交给父组件。</li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="usememo">useMemo<a class="hash-link" href="#usememo" title="标题的直接链接">​</a></h4><div class="codeBlockContainer_I0IT language-js theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-js codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> memoizedValue </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">useMemo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// function </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> deps</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>性能优化。useMemo 会缓存一个 <strong>引用</strong>，这个引用可以是一个具体的值、对象、函数。在初始化组件时，会调用回调函数，并让 <code>memoizedValue</code> 缓存回调函数的返回值。当 deps 依赖项不发生变化时，即使发生多次 render，也不会重新执行回调函数，<code>memoizedValue</code> 会一直持相同的引用，从而节省相同代码的执行。</p><p><strong>使用场景</strong>：</p><ol><li>复杂计算，当创建一个值，会产生高昂的开销（比如计算上千次才会生成变量值），有必要使用 <code>useMemo</code>，当然这种场景少之又少。</li><li>通过 props ，父组件给子组件传递局部变量。父组件把这个局部变量通过 useMemo 传递给子组件。不论父组件如何 rerender，该变量不会发生改变。所以通过 <code>memo()</code> 的包裹的子组件，会对传入的变量 shallow equal，顺利的避免重新渲染。<ul><li>如果传入变量在父组件中，没有通过 useMemo 包裹，仅使用 <code>memo()</code>包裹自组件是没用的。加入传入变量是一个对象 object，父组件每次 render 都会导致该 object 重新创建，子组件的 shallow equal 会发现前后 object 地址不一致，从而判定为 props 发生改变，而重新 render。</li></ul></li></ol><h4 class="anchor anchorWithStickyNavbar_mojV" id="usecallback">useCallback<a class="hash-link" href="#usecallback" title="标题的直接链接">​</a></h4><p>和 useMemo 的功能、触发机制相同，在依赖项变化后，会让 <code>memoizedValue</code> 重新缓存引用。不同的是，useMemo 会执行回调函数，并缓存得到的函数返回值；而 useCallback 直接缓存这个回调函数，并不会执行。</p><div class="codeBlockContainer_I0IT language-jsx theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-jsx codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> memoizedValue </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">useCallback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// function </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> deps</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ul><li>这个回调函数并不会执行，而是直接缓存。</li><li>useCallback 是 useMemo 的一种特例，因为 useMemo 可以引用/缓存任何值（对象、函数），而 useCallback 只能引用/缓存函数。</li></ul><p><strong>使用场景</strong>：父组件给子组件传递一个回调函数时，会把该回调函数通过 useCallback 包裹后再返回。原理同 useMemo 一样，子组件需要用 <code>memo()</code> 包裹。这样，即使父组件 render，但被 useCallback 包裹的回调函数不会发生改变，所以子组件通过 shallow equal，顺利避免重新渲染。</p><p>useMemo 和 useCallback 的区别：</p><p>相同：</p><ol><li>从逻辑上来说，触发逻辑相同，两个 hooks 的返回值 <code>memoizedValue</code> 会对一个值保持引用(缓存)。在依赖项不变的情况下，不论组件 render 多少次，都不该引用(缓存)都不会更新。</li><li>从目的上来说，两者都是性能优化，尽可能减少子组件的 render。</li></ol><p>不同：</p><ol><li>从代码上来说，useMemo 的回调函数会被执行，<code>memoizedValue</code> 缓存被执行的返回值；useCallback 的回调函数不会被执行，而是被 <code>memoizedValue</code> 直接缓存。</li><li>从效果上来说，useMemo 可以缓存任何值（基本值、对象、函数），而 useCallback 仅能缓存函数。</li><li>从原理上来说，useCallback 是 useMemo 的语法糖，是一个特例。useMemo 除了可以避免子组件重新渲染外，还可以包裹计算复杂的函数，减少复杂计算的执行次数。</li></ol><h2 class="anchor anchorWithStickyNavbar_mojV" id="state">State<a class="hash-link" href="#state" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="问题state-api">问题：state API<a class="hash-link" href="#问题state-api" title="标题的直接链接">​</a></h3><p>类组件的 state：</p><div class="codeBlockContainer_I0IT language-jsx theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-jsx codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">setState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> callback</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/* 第一个参数为object类型 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">number</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">//获取最新的number</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/* 第一个参数为function类型 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">state</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> props</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">number</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ul><li>第一个参数：
obj 为一个对象，则为即将合并的 state ；
obj 是一个函数，那么当前组件的 state 和 props 将作为参数，返回值用于合并新的 state。</li><li>第二个参数 callback ：函数内的 state 为 setState 更新后的最新值，作为依赖 state 变化的副作用函数。</li></ul><p>一次事件中，触发了 <code>setState()</code>，React 底层会做如下事情：</p><ol><li>调度阶段：setState 会产生当前更新的优先级（基于 lane）</li><li>协调阶段：从根部 fiber 节点 (fiber Root)，向下调和子节点：发现更新的组件，合并 state，触发组件 render 函数。最终得到 finished fiber tree (work in progress) + effectList。</li><li>渲染 mutation 阶段：进入 commit 阶段，通过 effectList 单项副作用链，完成对真实 DOM 的操作。更新流程完成</li><li>渲染 layout 阶段：执行 <code>setState(obj, callback)</code> 中 callback。所以此时获取的 state 是更新后的值。</li></ol><p>函数组件的 state</p><div class="codeBlockContainer_I0IT language-js theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-js codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dispatch</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">useState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">initData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ul><li>state：数据源，</li><li>dispatch：类似 setState 函数，推动函数组件渲染的渲染函数。</li><li>initData：可以是初始值 / 函数。如果是函数，则执行后返回的值为初始值。</li></ul><p>注意：dispatch 的参数也可以是函数，入参为对应 state 上一次更新后的最新值：</p><div class="codeBlockContainer_I0IT language-jsx theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-jsx codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">number </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> setNumbsr</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> React</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">useState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">handleClick</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token function" style="color:#d73a49">setNumber</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">state</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> state </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// state - &gt; 0 + 1 = 1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token function" style="color:#d73a49">setNumber</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// state - &gt; 8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token function" style="color:#d73a49">setNumber</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">state</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> state </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// state - &gt; 8 + 1 = 9</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="问题state-的批量更新">问题：state 的批量更新<a class="hash-link" href="#问题state-的批量更新" title="标题的直接链接">​</a></h3><p>关联问题：setState 的更新流程、state 是同步更新 (同步执行) 还是异步更新？</p><p><strong>关于更新流程：</strong></p><p>setState 会调用 dispathAction，创建一个 update 对象放到对应元素 fiber 节点的 updateQueue 上，然后调度渲染。</p><p><strong>关于同步还是异步：</strong></p><p>我的理解：如果没有异步环境更新 state，state 是在同一个执行上下文（调用栈）执行的。所以理论上来说是同步执行的。通常讨论的点是 state 是批量更新，还是非批量更新。</p><ul><li>虽然我们讨论的是 setState 的同步异步，但这个不是 setTimeout、Promise 那种异步调用，而是指 setState 执行后，state 是否立刻改变了，是否可以在当前执行上下文中得到改变的值，组件是否 render 了。</li><li>回答批量更新的要点：<ul><li>先说 state 的更新顺序：flushSync 可以提前批量更新，直接 render。然后是批量更新，最后一个 setState 执行并 render。最后是异步环境（微任务/宏任务）遇到一个 setState，就立即 render。</li><li>再说类组件和函数组件的区别：（1）类组件 api 可以回调监听到 state 更新，函数组件只能用 useEffect 副作用监听。（2）类组件异步更新 state，可在当前执行上下文获取到更新后的值（看起来像同步的），函数组件在当前执行上下文的 state 不会发生变化。</li></ul></li></ul><p><strong>关于批量更新：</strong></p><p>用户触发事件，会推动 React 的组件更新。所以 state 更新的源头还是触发事件。React 使用自定义的事件机制（关联：React 事件知识）。</p><p>React 使用 dispatchEvent 同一调度所有元素 fiber 上绑定的事件，在 dispatchEvent 中，会开启 state 批量更新，待 <strong>同步</strong> 更新完毕后，关闭批量更新：</p><ul><li>如没有定义异步 state 操作（没有在 setTimeout、promise 中更新 state），连续的 setState 更新操作会被统一的批量更新。也就是说多个 setState 只会执行最后一个，得到一个 state 结果后，才<strong>执行一次 render 函数</strong>。</li></ul><p>当异步环境时，批量更新是默认关闭的：</p><ul><li>如果定义异步 state 操作，如在同一个 setTimeout 中连续定义三个 setState，因为此时没有批量更新，就会遇到一个 setState，就先执行，然后触发 render，触发 setState 回调，接着继续往下执行其他 setState。最终会 <strong>执行 3 次 render 函数</strong>。</li></ul><p><strong>所以，如果采用异步环境更新 state，就会导致多次的 render 调用，也会导致视图的多次渲染，影响性能。</strong></p><ul><li>通过 <code>unstable_batchedUpdates</code> 包裹可以手动开启批量更新。</li></ul><p><strong>批量更新举例</strong>：</p><div class="codeBlockContainer_I0IT language-jsx theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-jsx codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function-variable function" style="color:#d73a49">handleClick</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">number</span><span class="token operator" style="color:#393A34">:</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">number </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;callback1&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">number</span><span class="token operator" style="color:#393A34">:</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">number </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;callback2&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">number</span><span class="token operator" style="color:#393A34">:</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">number </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;callback3&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 点击按钮，触发事件后的打印：</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 0, 0, 0, callback1 1 ,callback2 1 ,callback3 1</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>React 更新流程：</p><ul><li>在批量更新环境下：</li><li>缓存第 1 个 setState 但不更新 state；调用 <code>console.log()</code> 打印：0；</li><li>缓存第 2 个 setState 但不更新 state；调用 <code>console.log()</code> 打印：0；</li><li>缓存第 3 个 setState 但不更新 state；调用 <code>console.log()</code> 打印：0；</li><li>合并 state，触发最后一个 setState，state 更新为 1；</li><li>调用 render，更新 state；</li><li>依次调用 3 个 setState 的回调函数，打印 <code>callback1/2/3   1</code></li></ul><p><strong>异步环境更新举例</strong>：</p><div class="codeBlockContainer_I0IT language-js theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-js codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function-variable function" style="color:#d73a49">handleClick</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// setTimeout 包裹</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">setTimeout</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">number</span><span class="token operator" style="color:#393A34">:</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">number </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;callback1&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">number</span><span class="token operator" style="color:#393A34">:</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">number </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;callback2&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">number</span><span class="token operator" style="color:#393A34">:</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">number </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;callback3&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ul><li>非批量更新环境：</li><li>遇到第 1 个 setState，更新 state，触发 render，调用 setState 回调，打印 <code>callback1 1</code>。</li><li>调用 <code>console.log()</code>，打印：1。</li><li>遇到第 2 个 setState，更新 state，触发 render，调用 setState 回调，打印 <code>callback1 2</code></li><li>调用 <code>console.log()</code>，打印：2。</li><li>遇到第 3 个 setState，更新 state，触发 render，调用 setState 回调，打印 <code>callback1 3</code></li><li>调用 <code>console.log()</code>，打印：3。</li></ul><p><strong>手动调用批量更新</strong></p><div class="codeBlockContainer_I0IT language-jsx theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-jsx codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> ReactDOM </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;react-dom&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> unstable_batchedUpdates </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ReactDOM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">setTimeout</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 使用 unstable_batchedUpdates 包裹</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">unstable_batchedUpdates</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">number</span><span class="token operator" style="color:#393A34">:</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">number </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">number</span><span class="token operator" style="color:#393A34">:</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">number </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">number</span><span class="token operator" style="color:#393A34">:</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">number </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="函数组件-注意1">函数组件 注意1<a class="hash-link" href="#函数组件-注意1" title="标题的直接链接">​</a></h4><p>上面的例子如果换成函数组件，所有的 <code>console.log(number)</code> 都无法获取更新后的 number 值，即使用 setTimeout 包裹，避免批量更新也不行：</p><div class="codeBlockContainer_I0IT language-jsx theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-jsx codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> number </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> setNumber </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> React</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">useState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">handleClick</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 优先级更新</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ReactDOM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">flushSync</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">setNumber</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 批量更新</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">setNumber</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// 0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 异步: 滞后更新</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">setTimeout</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">setNumber</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>原因：函数组件的更新，就是函数的执行。每次执行，都会重新声明 state。所以改变的 state 只有在下次函数组件执行时才会被更新。所以在如上同一个函数执行上下文中，number 一直为0，无论怎么打印，都拿不到最新的 state 。</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="函数组件-注意2">函数组件 注意2<a class="hash-link" href="#函数组件-注意2" title="标题的直接链接">​</a></h4><p>函数组件如果在一次更新前后，仅有 state 发生变化，且更新时，setState 传入了相同的值（或相同的内存空间），则不会触发 render，更新会被阻止。因为 React 内部在处理 dispacthAction 时，会 shallow equal 浅对比 state 更新前后的值，如果相同则忽略本次更新。</p><div class="codeBlockContainer_I0IT language-jsx theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-jsx codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">default</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Index</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">state  </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dispatchState</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">useState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&#x27;alien&#x27;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">handleClick</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 点击按钮，视图没有更新。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;ninjee&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">dispatchState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 直接操作state对象，在内存中指向的地址相同。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">span</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">span</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">button</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">onClick</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#393A34">=</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript" style="color:#00009f">handleClick</span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text">changeName++</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">button</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ul><li>正确的使用方式，要浅拷贝一份再传递给 dispatch</li></ul><div class="codeBlockContainer_I0IT language-js theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-js codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">handleClick</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> newState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 创建 newState</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  newState</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ninjee&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">dispatchState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="问题usestate-和-setstate-区别">问题：useState 和 setState 区别<a class="hash-link" href="#问题usestate-和-setstate-区别" title="标题的直接链接">​</a></h3><p>函数组件 useState 和类组件 setState 的区别。</p><p>相同点：</p><ul><li><strong>推动更新</strong>。useState 的 dispatch 和 setState 都可以更新 state，推动组件更新和渲染。</li><li><strong>批量更新</strong>。通过事件驱动触发更新，都有批量更新规则。<ul><li>非事件驱动：比如在 setTimeout 中异步更新。</li><li>forceUpdate</li></ul></li></ul><p>不同点：</p><ul><li><strong>浅对比</strong>。类组件不会浅比较更新前后 state 的变化，函数组件会默认比较，这就需要在更新时传递一个新的对象。<ul><li>类组件如果定义 pureComponent，或在 shouldComponentUpdate 生命周期函数中自定义，可以达到浅对比效果。</li></ul></li><li><strong>监听变化</strong>。类组件 setState 有专门监听 state 变化的回调函数 callback，可以获取最新state；但是在函数组件中，只能通过 useEffect 执行 state 变化引起的副作用。</li><li><strong>底层原理</strong>。setState 在底层处理逻辑上主要是和老 state 进行合并处理，而 useState 更倾向于重新赋值。</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="问题state-中的更新顺序">问题：state 中的更新顺序<a class="hash-link" href="#问题state-中的更新顺序" title="标题的直接链接">​</a></h3><blockquote><p>类组件 setState 和函数组件 dispatch 的概念相同，这里用类组件 setState 举例。</p></blockquote><p>state 的更新可以通过 <code>flushSync</code> 提升优先级：</p><div class="codeBlockContainer_I0IT language-js theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-js codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">ReactDOM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">flushSync</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">number</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><code>flushSync</code> 的逻辑是，当处于同步条件下（开启批量更新），遇到 <code>flushSync</code> 定义的 setState，就会发生 state 合并，<strong>并执行 <code>flushSync</code> 定义的 state 更新，调用 render</strong>。然后再继续往下执行其他同步环境（开启批量更新）下 setState。</p><p> React 同一组件中 setState <strong>更新优先级</strong> 关系是:</p><p>同步环境，默认开启批量更新：</p><ul><li>高优先级更新 flushSync 中的 setState，已经缓存的 setState 都合并 (丢弃)。<ul><li>其内部也存在批量更新。</li></ul></li><li>正常执行上下文中 setState，执行最后一个 setState，将已经缓存的都丢弃。</li></ul><p>异步环境，默认关闭批量更新：</p><ul><li>Promise 中的 setState，立即执行 + render + 渲染，然后往下执行。</li><li>setTimeout 中的 setState，立即执行 + render + 渲染，然后往下执行。<ul><li><strong>注意调用顺序</strong>：执行 setState  =&gt; 执行 render =&gt; 执行 setState 后面的代码。</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="问题函数组件中监听-state-的变化">问题：函数组件中，监听 state 的变化<a class="hash-link" href="#问题函数组件中监听-state-的变化" title="标题的直接链接">​</a></h3><p>类组件中，推动更新 state 的方法是 <code>setState({}, callback);</code></p><p>其中，第二个参数的触发时机，是当前 state 完成更新，页面完成渲染（render + commit 完成），再异步调用，可以获得 state 更新后的最新值，达到监听 state 变化的目的。</p><p>函数组件中，推动 state 更新的方法是 <code>const [state, dispatch] = useState(0)</code> 中的 dispatch，该函数不支持第二个回调参数。</p><p><strong>监听方式：</strong>自定义 hooks</p><p>通过 <code>useEffect</code> 添加该 state 的依赖，可以达到监听 state 变化的目的。</p><ul><li>缺点：useEffect 初始化会调用一次，需要其他方法阻止初始化调用。<ul><li>解决：useUpdateEffect：useRef 自定义（关联问题）。</li></ul></li></ul><p>使用参考：<a href="https://codesandbox.io/s/agitated-pare-fwln3f?file=/src/App.js" target="_blank" rel="noopener noreferrer">https://codesandbox.io/s/agitated-pare-fwln3f?file=/src/App.js</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="事件机制">事件机制<a class="hash-link" href="#事件机制" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="问题事件机制">问题：事件机制<a class="hash-link" href="#问题事件机制" title="标题的直接链接">​</a></h3><p>React 事件的几个特点：</p><ol><li><strong>兼容性</strong>。不同的浏览器，对事件存在不同的兼容性，React 创建了一个兼容全浏览器的事件系统，以抹平不同浏览器的差异。</li><li><strong>版本</strong>。v17 之前 React 事件全部绑定在 document 上；v17 之后 React 把事件绑定在 app 对应的容器container 上。<ul><li>将事件绑定在同一容器统一管理，防止很多事件直接绑定在原生的 DOM 元素上，产生兼容性问题。</li></ul></li><li><strong>重新定义事件</strong>。由于不是绑定在真实的 DOM 上，所以 React 需要模拟一套事件流：事件捕获 -&gt; 事件源 -&gt; 事件冒泡；重写了事件源对象 event 。</li><li><strong>一个事件源</strong>。基于<strong>事件委托</strong>，在整个 React 应用中只绑定一个事件源。在 v17 以前，这个事件绑定在 document 上，在 v17 以后，这个事件绑定在 app 容器上，这样更有利于一个 html 下存在多个应用（微前端）。<ul><li>事件委托：利用事件的冒泡原理，把事件绑定在父元素上面，把所有子元素各自处理的事情交给父元素统一处理，达到性能优化的效果。</li></ul></li><li><strong>事件合成</strong>。React 应用中，元素绑定的事件并不是原生事件，而是React 合成的事件，比如 onClick 是由 click 合成，onChange 是由 blur ，change ，focus 等多个事件合成。</li><li><strong>按需绑定</strong>。不是一次性绑定所有事件，比如开发者添加 onClick 事件，React 就会绑定 click 事件；比如添加 onChange 事件，会绑定 <code>[blur，change ，focus ，keydown，keyup]</code> 多个事件。</li></ol><p>事件触发的细节：</p><ol><li><strong>元素 fiber 节点保存</strong>。事件触发的回调函数，会在对应 DOM 的 fiber 节点上保存，具体是在 fiber.memoizedProps 属性上。<ul><li>fiber.memoizedStates 上保存了 hooks 回调函数。</li></ul></li><li><strong>事件队列</strong>。在触发某个元素的事件后，会从该事件源触发，通过 <code>fiber.return</code> 向上收集全部对应事件的回调函数，通过数组保存。冒泡放在队头，捕获放在队尾。最终收集到 app 后截止，事件中心 dispatchEvent 会逐步调用这些回调函数（捕获 + 冒泡）。</li></ol><p>使用：</p><div class="codeBlockContainer_I0IT language-js theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-js codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">default</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Index</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">handleClick</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;模拟冒泡阶段执行&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">stopPropagation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* 阻止事件冒泡 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">handleClickCapture</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;模拟捕获阶段执行&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">div</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">button onClick</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> handleClick  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> onClickCapture</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> handleClickCapture </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">点击</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">button</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">div</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ul><li>冒泡阶段：React 绑定的事件比如 onClick，onChange，默认会在模拟冒泡阶段执行。</li><li>捕获阶段：在捕获阶段执行：事件 + Capture 后缀，如 onClickCapture，onChangeCapture</li><li>阻止冒泡：用 <code>e.stopPropagation()</code>。</li><li>阻止默认行为：<ul><li>原生事件： <code>e.preventDefault()</code> 和 <code>return false</code> 可以用来阻止事件默认行为</li><li>React 事件：只能用 <code>e.preventDefault()</code>，注意这里的 event 对象和相应方法，都被 React 重新实现了。</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="问题一次点击事件触发的流程">问题：一次点击事件触发的流程<a class="hash-link" href="#问题一次点击事件触发的流程" title="标题的直接链接">​</a></h3><p>如点击一个 button 按钮，触发 onClick 事件。</p><p>React 事件系统可分为三个部分：</p><ol><li>事件合成。初始化会注册不同的事件插件。</li><li>事件绑定。在一次渲染过程中，对事件标签中事件的收集，向 container 注册事件。</li><li>事件触发。第三个就是一次用户交互，事件触发，到事件执行一系列过程。</li></ol><p>事件绑定：React 事件会绑定在对应 DOM 元素的 fiber 对象上，具体是 fiber.memoizedProps 属性上。</p><p><img loading="lazy" alt="截屏2022-08-09 20.44.13" src="/assets/images/截屏2022-08-09 20.44.13-d1c792f0314650d33d24c9b3427c5749.png" width="1196" height="850" class="img_E7b_"></p><p>（1）批量更新</p><p>执行 dispatchEvent，会把真实事件源 DOM (button) 传递给 dispatchEvent，通过真实 DOM 找到对应的 fiber 节点。</p><p>（2）合成事件源</p><p>接下来会通过 onClick 找到对应的处理插件 SimpleEventPlugin ，合成事件源 event。</p><ul><li>event 包含 preventDefault (阻止默认行为)、stopPropagation (阻止继续冒泡) 等方法。</li></ul><p>（3）形成事件队列</p><p>通过事件源 fiber.return 向上遍历，遇到元素类型 fiber，就会收集事件到数组中：</p><ul><li>遇到 onClickCapture 捕获阶段触发，就 unshift 放在队头，</li><li>遇到 onClick 冒泡阶段触发，就 push 放在对尾。</li></ul><p>最终收集到顶端 app 组件，形成执行队列。</p><p>（4）执行事件队列</p><p>依次执行数组里面的事件回调函数，如果遇到 <code>event.isPropagationStopped === true</code> 就会中断后续的回调执行，达到阻止冒泡的效果。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="问题componentpurecomponent-memo">问题：Component、PureComponent 、memo()<a class="hash-link" href="#问题componentpurecomponent-memo" title="标题的直接链接">​</a></h3><p><strong><code>PureComponent</code> 组件创建了默认的 <code>shouldComponentUpdate</code> 行为。</strong></p><p>这个默认的 <code>shouldComponentUpdate</code> 行为会执行 shallow equal，逐一比较即将 render 前后， <code>props</code> 和 <code>state</code> 是否发生改变，如果没有改变，就会阻止组件接下来的 render 以及之后的生命周期函数的执行，提升性能。</p><p>而函数组件没有生命周期的概念，也无法使用 PureComponent，所以 React 16+ 定义了<code>React.memo()</code> 方法，它既可以包裹 class component，也可以包裹 function component，达到和 PureComponent 相同的效果。</p><ul><li>通常和 useMemo、useCallback hooks 配合使用。</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="其他">其他<a class="hash-link" href="#其他" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="问题jsx-element-fiber-dom-的关系">问题：JSX, element, fiber, dom 的关系<a class="hash-link" href="#问题jsx-element-fiber-dom-的关系" title="标题的直接链接">​</a></h3><p>首先必须需要弄明白 React.element ，fiber 和真实 DOM 三者是什么关系。</p><ul><li>jsx 语法，是创建 <code>React.creatElement()</code> 的语法糖。<ul><li>jsx 语法最终会被 babel 转译为各种 <code>React.creatElement()</code>。最终，这些代码会被执行，从而创建 React element 对象，</li></ul></li><li>React element 是 js 对象，上面保存了 props，children 等信息。有人这么表达：React element 组成的 DOM树，就是 virtul DOM。</li><li>DOM 是元素在浏览器上给用户直观的表象。</li><li>fiber 可以说是是 element 和真实 DOM 之间的交流枢纽站。<ul><li>每一个类型 element 都会有一个与之对应的 fiber 类型，element 变化引起更新流程都是通过 fiber 层面做一次调和改变，fiber 通过链表形式，构建出一颗 fiber 树。最终会在渲染阶段，转化为真实 DOM 并渲染在页面上。</li><li>也就是说，React element 组成了 virtualDOM，在 render（协调）阶段转化为 fiber tree，在 commit(渲染) 阶段转化为真实DOM。</li></ul></li></ul><p><img loading="lazy" alt="2.jpg" src="/assets/images/0a90368f24f0477aaf0d446a8f6736db~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0-075ad7c9c4b513ce7afa653459291b2b.awebp" width="1590" height="360" class="img_E7b_"></p><p>所以：JSX 最终会转变为 <code>React.createElement()</code> 并执行，从而创建 React element（virtual DOM），最终合并到 fiber 节点上。而 fiber 节点之间通过链表连接，最终构造为一颗 fiber 树。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="问题什么是受控组件">问题：什么是受控组件？<a class="hash-link" href="#问题什么是受控组件" title="标题的直接链接">​</a></h3><p>在 HTML 的表单元素中，它们通常自己维护一套 <code>state</code>，并随着用户的输入自己进行 <code>UI</code>上的更新，这种行为是不被我们程序所管控的。而如果将 <code>React</code> 里的 <code>state</code> 属性和表单元素的值建立依赖关系，再通过 <code>onChange</code> 等事件与 <code>setState()</code> 结合更新 <code>state</code> 属性，就能达到控制用户输入过程中表单发生的操作。被 <code>React</code> 以自身 state 控制取值的表单输入元素就叫做 <strong>受控组件</strong>。</p><p>在 <code>HTML</code> 中，表单元素（如<code>&lt;input&gt;</code>、 <code>&lt;textarea&gt;</code> 和 <code>&lt;select&gt;</code>）之类的表单元素通常自己维护 state，并根据用户输入进行更新。</p><p>利用表单自己维护的 state，也能获取表单提交的信息：</p><ul><li>通过 <code>createRef</code> 绑定 input DOM节点，然后在 <code>onSubmit</code>  监听：<code>this.ref.current.value</code> 就可以获得表单中的输入值。</li></ul><p>这种利用 DOM 自身能力获取表单值的方式，就是非受控组件，如下面：</p><div class="codeBlockContainer_I0IT language-jsx theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-jsx codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> React</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> Component </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;react&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">UnControll</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">Component</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">constructor</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">props</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">super</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">props</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">inputRef </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> React</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createRef</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">handleSubmit</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;获得input的值: &#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">inputRef</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">current</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">preventDefault</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">render</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">form</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">onSubmit</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#393A34">=</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript parameter" style="color:#00009f">e</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript operator" style="color:#393A34">=&gt;</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript keyword" style="color:#00009f">this</span><span class="token tag script language-javascript punctuation" style="color:#393A34">.</span><span class="token tag script language-javascript function" style="color:#d73a49">handleSubmit</span><span class="token tag script language-javascript punctuation" style="color:#393A34">(</span><span class="token tag script language-javascript" style="color:#00009f">e</span><span class="token tag script language-javascript punctuation" style="color:#393A34">)</span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">input</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">defaultValue</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">lindaidai</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">ref</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#393A34">=</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript keyword" style="color:#00009f">this</span><span class="token tag script language-javascript punctuation" style="color:#393A34">.</span><span class="token tag script language-javascript" style="color:#00009f">inputRef</span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">input</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">submit</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">提交</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">form</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>受控组件。</p><p>把表单的输入、submit 收集表单信息通过 React 的 state 管理起来，就是受控组件。</p><div class="codeBlockContainer_I0IT language-jsx theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-jsx codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">TestComponent</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">React</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">Component</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">constructor</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">props</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">super</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">props</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">username</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;lindaidai&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">onChange</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">target</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">username</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">target</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">render</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">input</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">username</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#393A34">=</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript keyword" style="color:#00009f">this</span><span class="token tag script language-javascript punctuation" style="color:#393A34">.</span><span class="token tag script language-javascript" style="color:#00009f">state</span><span class="token tag script language-javascript punctuation" style="color:#393A34">.</span><span class="token tag script language-javascript" style="color:#00009f">username</span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">onChange</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#393A34">=</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript punctuation" style="color:#393A34">(</span><span class="token tag script language-javascript parameter" style="color:#00009f">e</span><span class="token tag script language-javascript punctuation" style="color:#393A34">)</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript operator" style="color:#393A34">=&gt;</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript keyword" style="color:#00009f">this</span><span class="token tag script language-javascript punctuation" style="color:#393A34">.</span><span class="token tag script language-javascript function" style="color:#d73a49">onChange</span><span class="token tag script language-javascript punctuation" style="color:#393A34">(</span><span class="token tag script language-javascript" style="color:#00009f">e</span><span class="token tag script language-javascript punctuation" style="color:#393A34">)</span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="问题什么是无状态组件">问题：什么是无状态组件？<a class="hash-link" href="#问题什么是无状态组件" title="标题的直接链接">​</a></h3><p>数据就是状态（state），数据的变化就是状态的变化（setState()）。有维护自己状态存储和变化机制的组件叫做有状态组件；把状态的维护抽离到父组件中，没有 state 维护的叫做无状态组件或 UI 组件。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="问题hoc--高阶组件">问题：HOC / 高阶组件<a class="hash-link" href="#问题hoc--高阶组件" title="标题的直接链接">​</a></h3><p>通常项目中的权限鉴定，就是利用了高阶组件 HOC。高阶组件实现了相同功能和逻辑的复用。</p><p>高阶函数：一个将函数作为参数并且返回值也是函数的函数。</p><p>高阶组件：是以组件作为参数，返回组件的函数。达到功能强化的目的。</p><ul><li>个人理解：类似对象的 <code>object.create()</code> 混入增强效果。</li></ul><p>使用场景：</p><ul><li><strong>对组件的拦截，本质上是对渲染的控制。</strong>不仅可以控制是否渲染组件，还可以像 dva 中 dynamic 那样懒加载/动态加载组件。</li><li><strong>让 props 中混入一些额外的数据。</strong>比如，项目中想让一个非 Route 组件，也能通过 props 获取路由实现跳转，但是不想通过父级路由组件层层绑定 props ，这个时候就需要一个 HOC 把改变路由的 history 对象混入 props 中，于是 withRoute 诞生了。</li><li><strong>不想改变组件，只是监控组件的内部状态。</strong>比如对组件内的点击事件做一些监控，或者加一次额外的生命周期。</li></ul><p>常用的高阶组件有 <strong>属性代理</strong> 和 <strong>反向继承</strong> 两种：</p><p><strong>属性代理</strong></p><p>属性代理，就是用组件包裹一层代理组件，在代理组件上对源组件的强化操作。</p><ul><li>返回的是一个新组件，被包裹的原始组件将在新的组件里被挂载。</li></ul><div class="codeBlockContainer_I0IT language-jsx theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-jsx codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">HOC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">WrapComponent</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Advance</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">React</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">Component</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    state</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&#x27;alien&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">render</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag class-name" style="color:#00009f">WrapComponent</span><span class="token tag" style="color:#00009f"> </span><span class="token tag spread punctuation" style="color:#393A34">{</span><span class="token tag spread" style="color:#00009f"> </span><span class="token tag spread operator" style="color:#393A34">...</span><span class="token tag spread keyword" style="color:#00009f">this</span><span class="token tag spread punctuation" style="color:#393A34">.</span><span class="token tag spread" style="color:#00009f">props </span><span class="token tag spread punctuation" style="color:#393A34">}</span><span class="token tag" style="color:#00009f"> </span><span class="token tag spread punctuation" style="color:#393A34">{</span><span class="token tag spread" style="color:#00009f"> </span><span class="token tag spread operator" style="color:#393A34">...</span><span class="token tag spread keyword" style="color:#00009f">this</span><span class="token tag spread punctuation" style="color:#393A34">.</span><span class="token tag spread" style="color:#00009f">state </span><span class="token tag spread punctuation" style="color:#393A34">}</span><span class="token tag" style="color:#00009f">  </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>优点：</p><ul><li><strong>低耦合</strong>。正向属性代理，更适合做一些开源项目的 HOC。属性代理可以和业务组件低耦合。只对组件增加了渲染控制、props 参数控制，无须知道业务组件内做了些什么。</li><li><strong>兼容性</strong>。同样适用于类组件和函数组件。</li><li><strong>渲染可控</strong>。可以完全隔离业务组件的渲染，因为属性代理返回了个新组件，相比反向继承，可以完全控制业务组件是否渲染。</li><li><strong>可嵌套</strong>。可以嵌套使用，多个 HOC 可以嵌套使用，一般不限制包装 HOC 的先后顺序。</li></ul><p>缺点：</p><ul><li><p><strong>Ref 问题</strong>。因其产生了一个新组件，所以需要配合 forwardRef 来转发 ref。</p></li><li><p><strong>获取状态</strong>。需要 ref 获取组件实例，才能获取原始组件的状态。</p></li><li><p><strong>无法继承静态属性</strong>。如果需要继承需要手动处理，或者引入第三方库。</p></li></ul><p><strong>反向继承</strong></p><p>反向继承包装后的组件 <strong>继承</strong> 了原始组件本身，所以此时无须再挂载业务组件。</p><div class="codeBlockContainer_I0IT language-jsx theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-jsx codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Index</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">React</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">Component</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">render</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"> hello,world </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">HOC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">Component</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/* 直接继承需要包装的组件 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">wrapComponent</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">Component</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">default</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">HOC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Index</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>优点：</p><ul><li><strong>获取状态</strong>。组件内部状态可直接获取：state ，props ，生命周期，绑定的事件函数等。</li><li><strong>继承静态属性</strong>。因为继承关系，可以直接继承静态属性和方法。</li></ul><p>缺点：</p><ul><li><strong>高耦合</strong>。和被包装的组件耦合度高，是对原始组件的直接继承并改造。</li><li><strong>兼容性</strong>。函数组件无法使用。</li><li><strong>不可随意嵌套</strong>。多个反向继承 HOC 嵌套在一起，当前状态会覆盖上一个状态。比如说有多个 componentDidMount ，当前 componentDidMount 会覆盖上一个 componentDidMount。导致对副作用的管理可能失控。</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="自定义-hook">自定义 hook<a class="hash-link" href="#自定义-hook" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="问题阻止-useeffect-初始化调用">问题：阻止 useEffect 初始化调用<a class="hash-link" href="#问题阻止-useeffect-初始化调用" title="标题的直接链接">​</a></h3><div class="codeBlockContainer_I0IT language-js theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-js codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">useUpdateEffect</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">callback</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> deps</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> firstMount </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">useRef</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">useEffect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">firstMount</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">current</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      firstMount</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">current </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">callback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> deps</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" title="复制" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ul><li>缺点：callback 中不可以有 hooks，因为使用了 if 判断<ul><li>关联：hooks 为什么不能用 if。问题：Hooks 的特点之一，有序。</li></ul></li></ul><blockquote><p>来源：</p><p>React课程：<a href="https://ke.segmentfault.com/course/1650000023864436/section/1500000023864578" target="_blank" rel="noopener noreferrer">https://ke.segmentfault.com/course/1650000023864436/section/1500000023864578</a></p><p><a href="https://github.com/lizuncong/mini-react/blob/master/docs/render/%E6%B7%B1%E5%85%A5%E6%A6%82%E8%BF%B0%20React%E5%88%9D%E6%AC%A1%E6%B8%B2%E6%9F%93%E5%8F%8A%E7%8A%B6%E6%80%81%E6%9B%B4%E6%96%B0%E4%B8%BB%E6%B5%81%E7%A8%8B.md" target="_blank" rel="noopener noreferrer">https://github.com/lizuncong/mini-react/blob/master/docs/render/%E6%B7%B1%E5%85%A5%E6%A6%82%E8%BF%B0%20React%E5%88%9D%E6%AC%A1%E6%B8%B2%E6%9F%93%E5%8F%8A%E7%8A%B6%E6%80%81%E6%9B%B4%E6%96%B0%E4%B8%BB%E6%B5%81%E7%A8%8B.md</a></p><p><a href="https://segmentfault.com/a/1190000039227345" target="_blank" rel="noopener noreferrer">https://segmentfault.com/a/1190000039227345</a></p><p><a href="https://juejin.cn/post/6844903975112671239" target="_blank" rel="noopener noreferrer">https://juejin.cn/post/6844903975112671239</a></p><p><a href="https://juejin.cn/post/7118259566868955167" target="_blank" rel="noopener noreferrer">https://juejin.cn/post/7118259566868955167</a></p></blockquote></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>标签：</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/docs/tags/react">React</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/frontEnd/React"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">概述</div></a></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#react-设计理念" class="table-of-contents__link toc-highlight">React 设计理念</a><ul><li><a href="#问题react-运行机制--架构" class="table-of-contents__link toc-highlight">问题：React 运行机制 / 架构</a><ul><li><a href="#1-调度阶段" class="table-of-contents__link toc-highlight">1 调度阶段</a></li><li><a href="#2-协调阶段" class="table-of-contents__link toc-highlight">2 协调阶段</a></li><li><a href="#3-渲染阶段" class="table-of-contents__link toc-highlight">3 渲染阶段</a></li></ul></li><li><a href="#问题algebraic-effects" class="table-of-contents__link toc-highlight">问题：algebraic effects</a><ul><li><a href="#algebraic-effects-的由来" class="table-of-contents__link toc-highlight">algebraic effects 的由来</a></li><li><a href="#algebraic-effects-解决的问题" class="table-of-contents__link toc-highlight">Algebraic Effects 解决的问题</a></li><li><a href="#react-hooks-思想" class="table-of-contents__link toc-highlight">React Hooks 思想</a></li></ul></li><li><a href="#问题初次渲染--更新-的区别" class="table-of-contents__link toc-highlight">问题：初次渲染 / 更新 的区别</a></li><li><a href="#问题哪些方式可以触发-update-更新" class="table-of-contents__link toc-highlight">问题：哪些方式可以触发 update 更新？</a></li></ul></li><li><a href="#diff" class="table-of-contents__link toc-highlight">diff</a><ul><li><a href="#问题什么是-virtual-dom" class="table-of-contents__link toc-highlight">问题：什么是 virtual DOM</a></li><li><a href="#问题virtual-dom-的优势" class="table-of-contents__link toc-highlight">问题：virtual DOM 的优势</a></li><li><a href="#问题diff-原理" class="table-of-contents__link toc-highlight">问题：diff 原理</a></li><li><a href="#问题双缓存模型" class="table-of-contents__link toc-highlight">问题：双缓存模型</a></li></ul></li><li><a href="#fiber" class="table-of-contents__link toc-highlight">Fiber</a><ul><li><a href="#问题1-为什么要引入-fiber-架构" class="table-of-contents__link toc-highlight">问题1 为什么要引入 Fiber 架构？</a></li><li><a href="#问题2-什么是-fiber" class="table-of-contents__link toc-highlight">问题2 什么是 Fiber</a><ul><li><a href="#1-流程控制机制" class="table-of-contents__link toc-highlight">1 流程控制机制</a></li><li><a href="#2-执行单元" class="table-of-contents__link toc-highlight">2 执行单元</a></li><li><a href="#3-一种数据结构" class="table-of-contents__link toc-highlight">3 一种数据结构</a></li></ul></li><li><a href="#问题3-fiber-的结构" class="table-of-contents__link toc-highlight">问题3 Fiber 的结构</a></li><li><a href="#问题fiber-更新机制" class="table-of-contents__link toc-highlight">问题：Fiber 更新机制</a></li></ul></li><li><a href="#生命周期-hooks" class="table-of-contents__link toc-highlight">生命周期 hooks</a><ul><li><a href="#问题useeffect-和-uselayouteffect-的区别" class="table-of-contents__link toc-highlight">问题：useEffect 和 useLayoutEffect 的区别</a></li><li><a href="#问题react-生命周期8" class="table-of-contents__link toc-highlight">问题：React 生命周期（8）</a><ul><li><a href="#协调阶段-render" class="table-of-contents__link toc-highlight">协调阶段 render</a></li><li><a href="#渲染阶段-commit" class="table-of-contents__link toc-highlight">渲染阶段 commit</a></li><li><a href="#问题react-17-为什么会废弃-3-个生命周期" class="table-of-contents__link toc-highlight">问题：React 17 为什么会废弃 3 个生命周期</a></li></ul></li><li><a href="#问题生命周期函数的执行顺序" class="table-of-contents__link toc-highlight">问题：生命周期函数的执行顺序</a></li><li><a href="#问题react-hooks" class="table-of-contents__link toc-highlight">问题：React hooks</a><ul><li><a href="#hooks-的特点" class="table-of-contents__link toc-highlight">Hooks 的特点</a></li><li><a href="#hooks-介绍-9" class="table-of-contents__link toc-highlight">Hooks 介绍 (9)</a></li><li><a href="#usestate" class="table-of-contents__link toc-highlight">useState</a></li><li><a href="#usereducer" class="table-of-contents__link toc-highlight">useReducer</a></li><li><a href="#useeffect" class="table-of-contents__link toc-highlight">useEffect</a></li><li><a href="#uselayouteffect" class="table-of-contents__link toc-highlight">useLayoutEffect</a></li><li><a href="#usecontext" class="table-of-contents__link toc-highlight">useContext</a></li><li><a href="#useref" class="table-of-contents__link toc-highlight">useRef</a></li><li><a href="#useimperativehandle" class="table-of-contents__link toc-highlight">useImperativeHandle</a></li><li><a href="#usememo" class="table-of-contents__link toc-highlight">useMemo</a></li><li><a href="#usecallback" class="table-of-contents__link toc-highlight">useCallback</a></li></ul></li></ul></li><li><a href="#state" class="table-of-contents__link toc-highlight">State</a><ul><li><a href="#问题state-api" class="table-of-contents__link toc-highlight">问题：state API</a></li><li><a href="#问题state-的批量更新" class="table-of-contents__link toc-highlight">问题：state 的批量更新</a><ul><li><a href="#函数组件-注意1" class="table-of-contents__link toc-highlight">函数组件 注意1</a></li><li><a href="#函数组件-注意2" class="table-of-contents__link toc-highlight">函数组件 注意2</a></li></ul></li><li><a href="#问题usestate-和-setstate-区别" class="table-of-contents__link toc-highlight">问题：useState 和 setState 区别</a></li><li><a href="#问题state-中的更新顺序" class="table-of-contents__link toc-highlight">问题：state 中的更新顺序</a></li><li><a href="#问题函数组件中监听-state-的变化" class="table-of-contents__link toc-highlight">问题：函数组件中，监听 state 的变化</a></li></ul></li><li><a href="#事件机制" class="table-of-contents__link toc-highlight">事件机制</a><ul><li><a href="#问题事件机制" class="table-of-contents__link toc-highlight">问题：事件机制</a></li><li><a href="#问题一次点击事件触发的流程" class="table-of-contents__link toc-highlight">问题：一次点击事件触发的流程</a></li><li><a href="#问题componentpurecomponent-memo" class="table-of-contents__link toc-highlight">问题：Component、PureComponent 、memo()</a></li></ul></li><li><a href="#其他" class="table-of-contents__link toc-highlight">其他</a><ul><li><a href="#问题jsx-element-fiber-dom-的关系" class="table-of-contents__link toc-highlight">问题：JSX, element, fiber, dom 的关系</a></li><li><a href="#问题什么是受控组件" class="table-of-contents__link toc-highlight">问题：什么是受控组件？</a></li><li><a href="#问题什么是无状态组件" class="table-of-contents__link toc-highlight">问题：什么是无状态组件？</a></li><li><a href="#问题hoc--高阶组件" class="table-of-contents__link toc-highlight">问题：HOC / 高阶组件</a></li></ul></li><li><a href="#自定义-hook" class="table-of-contents__link toc-highlight">自定义 hook</a><ul><li><a href="#问题阻止-useeffect-初始化调用" class="table-of-contents__link toc-highlight">问题：阻止 useEffect 初始化调用</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">分享</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/frontEnd/JavaScript">前端</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/code/algorithm">算法笔记</a></li><li class="footer__item"><a class="footer__link-item" href="/project">我的项目</a></li></ul></div><div class="col footer__col"><div class="footer__title">社交媒体</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/about">关于我</a></li><li class="footer__item"><a href="https://github.com/moxyNJ" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://juejin.cn/user/2005151873514024" target="_blank" rel="noopener noreferrer" class="footer__link-item">掘金<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Blog</div><ul class="footer__items"><li class="footer__item"><a href="https://www.ninjee.co" target="_blank" rel="noopener noreferrer" class="footer__link-item">Ninjee 的前端篮子</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright"><p>Copyright © 2022 Ninjee Built with Docusaurus.</p><p><a href="http://beian.miit.gov.cn/">晋ICP备2021017941号-2</a></p></div></div></div></footer></div>
<script src="/assets/js/runtime~main.555a76fc.js"></script>
<script src="/assets/js/main.ab00bfd0.js"></script>
</body>
</html>